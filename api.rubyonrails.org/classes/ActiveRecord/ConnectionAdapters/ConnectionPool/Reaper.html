<!DOCTYPE html>
<html lang="en">
<head>
    <title>ActiveRecord::ConnectionAdapters::ConnectionPool::Reaper</title>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="https://api.rubyonrails.org/css/reset.css" type="text/css" media="screen" />
<link rel="stylesheet" href="https://api.rubyonrails.org/css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="https://api.rubyonrails.org/css/github.css" type="text/css" media="screen" />
<script src="https://api.rubyonrails.org/js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://api.rubyonrails.org/js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="https://api.rubyonrails.org/js/highlight.pack.js" type="text/javascript" charset="utf-8"></script>


    <meta property="og:title" value="ActiveRecord::ConnectionAdapters::ConnectionPool::Reaper">

  
    
    <meta name="description" content="Every frequency seconds, the reaper will call reap and flush on pool. A reaper instantiated with a zero frequency will never reap the connection pool.">
    <meta property="og:description" content="Every frequency seconds, the reaper will call reap and flush on pool. A reaper instantiated with a zero frequency will never reap the connection pool.">
  

    <meta name="keywords" content="ActiveRecord::ConnectionAdapters::ConnectionPool::Reaper class">
  
    <meta name="keywords" content="new, run, lock_thread=, connection, active_connection?, release_connection, with_connection, connected?, disconnect, disconnect!, clear_reloadable_connections, clear_reloadable_connections!, checkout, checkin, remove, reap, flush, flush!, stat, bulk_make_new_connections, connection_cache_key, with_exclusively_acquired_all_connections, attempt_to_checkout_all_existing_connections, checkout_for_exclusive_access, with_new_connections_blocked, acquire_connection, remove_connection_from_thread_cache, new_connection, try_to_checkout_new_connection, adopt_connection, checkout_new_connection, checkout_and_verify">
  
</head>

<body>
    <div class="banner">
        
            <span>Ruby on Rails 5.2.1</span><br />
        
        <h1>
            <span class="type">Class</span>
            ActiveRecord::ConnectionAdapters::ConnectionPool::Reaper
            
                <span class="parent">&lt;
                    
                    <a href="https://api.rubyonrails.org/classes/Object.html">Object</a>
                    
                </span>
            
        </h1>
        <ul class="files">
            
            <li><a href="../../../../files/activerecord/lib/active_record/connection_adapters/abstract/connection_pool_rb.html">activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
  
    <div class="description">
      
<p>Every <code>frequency</code> seconds, the reaper will call
<code>reap</code> and <code>flush</code> on <code>pool</code>. A reaper
instantiated with a zero frequency will never reap the connection pool.</p>

<p>Configure the frequency by setting <code>reaping_frequency</code> in your
database yaml file (default 60 seconds).</p>

    </div>
  


  


  
  


  
    <!-- Namespace -->
    <div class="sectiontitle">Namespace</div>
    <ul>
      
        <li>
          <span class="type">CLASS</span>
          <a href="Reaper/ConnectionHandler.html">ActiveRecord::ConnectionAdapters::ConnectionPool::Reaper::ConnectionHandler</a>
        </li>
      
    </ul>
  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>A</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="Reaper.html#method-i-acquire_connection">acquire_connection</a>,
              </li>
            
              
              <li>
                <a href="Reaper.html#method-i-active_connection-3F">active_connection?</a>,
              </li>
            
              
              <li>
                <a href="Reaper.html#method-i-adopt_connection">adopt_connection</a>,
              </li>
            
              
              <li>
                <a href="Reaper.html#method-i-attempt_to_checkout_all_existing_connections">attempt_to_checkout_all_existing_connections</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>B</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="Reaper.html#method-i-bulk_make_new_connections">bulk_make_new_connections</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>C</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="Reaper.html#method-i-checkin">checkin</a>,
              </li>
            
              
              <li>
                <a href="Reaper.html#method-i-checkout">checkout</a>,
              </li>
            
              
              <li>
                <a href="Reaper.html#method-i-checkout_and_verify">checkout_and_verify</a>,
              </li>
            
              
              <li>
                <a href="Reaper.html#method-i-checkout_for_exclusive_access">checkout_for_exclusive_access</a>,
              </li>
            
              
              <li>
                <a href="Reaper.html#method-i-checkout_new_connection">checkout_new_connection</a>,
              </li>
            
              
              <li>
                <a href="Reaper.html#method-i-clear_reloadable_connections">clear_reloadable_connections</a>,
              </li>
            
              
              <li>
                <a href="Reaper.html#method-i-clear_reloadable_connections-21">clear_reloadable_connections!</a>,
              </li>
            
              
              <li>
                <a href="Reaper.html#method-i-connected-3F">connected?</a>,
              </li>
            
              
              <li>
                <a href="Reaper.html#method-i-connection">connection</a>,
              </li>
            
              
              <li>
                <a href="Reaper.html#method-i-connection_cache_key">connection_cache_key</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>D</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="Reaper.html#method-i-disconnect">disconnect</a>,
              </li>
            
              
              <li>
                <a href="Reaper.html#method-i-disconnect-21">disconnect!</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>F</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="Reaper.html#method-i-flush">flush</a>,
              </li>
            
              
              <li>
                <a href="Reaper.html#method-i-flush-21">flush!</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>L</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="Reaper.html#method-i-lock_thread-3D">lock_thread=</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>N</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="Reaper.html#method-c-new">new</a>,
              </li>
            
              
              <li>
                <a href="Reaper.html#method-i-new_connection">new_connection</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>R</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="Reaper.html#method-i-reap">reap</a>,
              </li>
            
              
              <li>
                <a href="Reaper.html#method-i-release_connection">release_connection</a>,
              </li>
            
              
              <li>
                <a href="Reaper.html#method-i-remove">remove</a>,
              </li>
            
              
              <li>
                <a href="Reaper.html#method-i-remove_connection_from_thread_cache">remove_connection_from_thread_cache</a>,
              </li>
            
              
              <li>
                <a href="Reaper.html#method-i-run">run</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>S</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="Reaper.html#method-i-stat">stat</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>T</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="Reaper.html#method-i-try_to_checkout_new_connection">try_to_checkout_new_connection</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>W</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="Reaper.html#method-i-with_connection">with_connection</a>,
              </li>
            
              
              <li>
                <a href="Reaper.html#method-i-with_exclusively_acquired_all_connections">with_exclusively_acquired_all_connections</a>,
              </li>
            
              
              <li>
                <a href="Reaper.html#method-i-with_new_connections_blocked">with_new_connections_blocked</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  
    <!-- Includes -->
    <div class="sectiontitle">Included Modules</div>
    <ul>
      
        <li>
          
            MonitorMixin
          
        </li>
      
        <li>
          
            <a href="../QueryCache/ConnectionPoolConfiguration.html">
              ActiveRecord::ConnectionAdapters::QueryCache::ConnectionPoolConfiguration
            </a>
          
        </li>
      
    </ul>
  



  

    

    

    


    
      <!-- Section attributes -->
      <div class="sectiontitle">Attributes</div>
      <table border='0' cellpadding='5'>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>automatic_reconnect</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>checkout_timeout</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [R]
            </td>
            <td class='attr-name'>connections</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [R]
            </td>
            <td class='attr-name'>frequency</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [R]
            </td>
            <td class='attr-name'>pool</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [R]
            </td>
            <td class='attr-name'>reaper</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>schema_cache</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [R]
            </td>
            <td class='attr-name'>size</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [R]
            </td>
            <td class='attr-name'>spec</td>
            <td class='attr-desc'></td>
          </tr>
        
      </table>
    


    <!-- Methods -->
    
      <div class="sectiontitle">Class Public methods</div>
      
        <div class="method">
          <div class="title method-title" id="method-c-new">
            
              <b>new</b>(pool, frequency)
            
            <a href="Reaper.html#method-c-new" name="method-c-new" class="permalink">Link</a>
          </div>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-c-new_source')" id="l_method-c-new_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L290" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-c-new_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 290</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">initialize</span>(<span class="ruby-identifier">pool</span>, <span class="ruby-identifier">frequency</span>)
  <span class="ruby-ivar">@pool</span>      = <span class="ruby-identifier">pool</span>
  <span class="ruby-ivar">@frequency</span> = <span class="ruby-identifier">frequency</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
    
      <div class="sectiontitle">Instance Public methods</div>
      
        <div class="method">
          <div class="title method-title" id="method-i-acquire_connection">
            
              <b>acquire_connection</b>(checkout_timeout)
            
            <a href="Reaper.html#method-i-acquire_connection" name="method-i-acquire_connection" class="permalink">Link</a>
          </div>

          
            <div class="description">
              <p>Acquire a connection by one of 1) immediately removing one from the queue
of available connections, 2) creating a new connection if the pool is not
at capacity, 3) waiting on the queue for a connection to become available.</p>

<p>Raises:</p>
<ul><li>
<p><a
href="../../ConnectionTimeoutError.html">ActiveRecord::ConnectionTimeoutError</a>
if a connection could not be acquired</p>
</li></ul>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-acquire_connection_source')" id="l_method-i-acquire_connection_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L786" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-acquire_connection_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 786</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">acquire_connection</span>(<span class="ruby-identifier">checkout_timeout</span>)
  <span class="ruby-comment"># NOTE: we rely on &lt;tt&gt;@available.poll&lt;/tt&gt; and +try_to_checkout_new_connection+ to</span>
  <span class="ruby-comment"># +conn.lease+ the returned connection (and to do this in a +synchronized+</span>
  <span class="ruby-comment"># section). This is not the cleanest implementation, as ideally we would</span>
  <span class="ruby-comment"># &lt;tt&gt;synchronize { conn.lease }&lt;/tt&gt; in this method, but by leaving it to &lt;tt&gt;@available.poll&lt;/tt&gt;</span>
  <span class="ruby-comment"># and +try_to_checkout_new_connection+ we can piggyback on +synchronize+ sections</span>
  <span class="ruby-comment"># of the said methods and avoid an additional +synchronize+ overhead.</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">conn</span> = <span class="ruby-ivar">@available</span>.<span class="ruby-identifier">poll</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">try_to_checkout_new_connection</span>
    <span class="ruby-identifier">conn</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">reap</span>
    <span class="ruby-ivar">@available</span>.<span class="ruby-identifier">poll</span>(<span class="ruby-identifier">checkout_timeout</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-active_connection-3F">
            
              <b>active_connection?</b>()
            
            <a href="Reaper.html#method-i-active_connection-3F" name="method-i-active_connection-3F" class="permalink">Link</a>
          </div>

          
            <div class="description">
              <p>Returns true if there is an open connection being used for the current
thread.</p>

<p>This method only works for connections that have been obtained through <a
href="Reaper.html#method-i-connection">connection</a> or <a
href="Reaper.html#method-i-with_connection">with_connection</a> methods.
Connections obtained through <a
href="Reaper.html#method-i-checkout">checkout</a> will not be detected by
<a href="Reaper.html#method-i-active_connection-3F">active_connection?</a></p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-active_connection-3F_source')" id="l_method-i-active_connection-3F_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L388" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-active_connection-3F_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 388</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">active_connection?</span>
  <span class="ruby-ivar">@thread_cached_conns</span>[<span class="ruby-identifier">connection_cache_key</span>(<span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>)]
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-adopt_connection">
            
              <b>adopt_connection</b>(conn)
            
            <a href="Reaper.html#method-i-adopt_connection" name="method-i-adopt_connection" class="permalink">Link</a>
          </div>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-adopt_connection_source')" id="l_method-i-adopt_connection_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L846" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-adopt_connection_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 846</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">adopt_connection</span>(<span class="ruby-identifier">conn</span>)
  <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">pool</span> = <span class="ruby-keyword">self</span>
  <span class="ruby-ivar">@connections</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">conn</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-attempt_to_checkout_all_existing_connections">
            
              <b>attempt_to_checkout_all_existing_connections</b>(raise_on_acquisition_timeout = true)
            
            <a href="Reaper.html#method-i-attempt_to_checkout_all_existing_connections" name="method-i-attempt_to_checkout_all_existing_connections" class="permalink">Link</a>
          </div>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-attempt_to_checkout_all_existing_connections_source')" id="l_method-i-attempt_to_checkout_all_existing_connections_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L680" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-attempt_to_checkout_all_existing_connections_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 680</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">attempt_to_checkout_all_existing_connections</span>(<span class="ruby-identifier">raise_on_acquisition_timeout</span> = <span class="ruby-keyword">true</span>)
      <span class="ruby-identifier">collected_conns</span> = <span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>
        <span class="ruby-comment"># account for our own connections</span>
        <span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">select</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span> <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">owner</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span> }
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">newly_checked_out</span> = []
      <span class="ruby-identifier">timeout_time</span>      = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> <span class="ruby-operator">+</span> (<span class="ruby-ivar">@checkout_timeout</span> <span class="ruby-operator">*</span> <span class="ruby-value">2</span>)

      <span class="ruby-ivar">@available</span>.<span class="ruby-identifier">with_a_bias_for</span>(<span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>) <span class="ruby-keyword">do</span>
        <span class="ruby-identifier">loop</span> <span class="ruby-keyword">do</span>
          <span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>
            <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">collected_conns</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@now_connecting</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
            <span class="ruby-identifier">remaining_timeout</span> = <span class="ruby-identifier">timeout_time</span> <span class="ruby-operator">-</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
            <span class="ruby-identifier">remaining_timeout</span> = <span class="ruby-value">0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">remaining_timeout</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span>
            <span class="ruby-identifier">conn</span> = <span class="ruby-identifier">checkout_for_exclusive_access</span>(<span class="ruby-identifier">remaining_timeout</span>)
            <span class="ruby-identifier">collected_conns</span>   <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">conn</span>
            <span class="ruby-identifier">newly_checked_out</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">conn</span>
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">rescue</span> <span class="ruby-constant">ExclusiveConnectionTimeoutError</span>
      <span class="ruby-comment"># &lt;tt&gt;raise_on_acquisition_timeout == false&lt;/tt&gt; means we are directed to ignore any</span>
      <span class="ruby-comment"># timeouts and are expected to just give up: we&#39;ve obtained as many connections</span>
      <span class="ruby-comment"># as possible, note that in a case like that we don&#39;t return any of the</span>
      <span class="ruby-comment"># +newly_checked_out+ connections.</span>

      <span class="ruby-keyword">if</span> <span class="ruby-identifier">raise_on_acquisition_timeout</span>
        <span class="ruby-identifier">release_newly_checked_out</span> = <span class="ruby-keyword">true</span>
        <span class="ruby-identifier">raise</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Exception</span> <span class="ruby-comment"># if something else went wrong</span>
      <span class="ruby-comment"># this can&#39;t be a &quot;naked&quot; rescue, because we have should return conns</span>
      <span class="ruby-comment"># even for non-StandardErrors</span>
      <span class="ruby-identifier">release_newly_checked_out</span> = <span class="ruby-keyword">true</span>
      <span class="ruby-identifier">raise</span>
    <span class="ruby-keyword">ensure</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">release_newly_checked_out</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">newly_checked_out</span>
        <span class="ruby-comment"># releasing only those conns that were checked out in this method, conns</span>
        <span class="ruby-comment"># checked outside this method (before it was called) are not for us to release</span>
        <span class="ruby-identifier">newly_checked_out</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span> <span class="ruby-identifier">checkin</span>(<span class="ruby-identifier">conn</span>) }
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment">#--</span>
    <span class="ruby-comment"># Must be called in a synchronize block.</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">checkout_for_exclusive_access</span>(<span class="ruby-identifier">checkout_timeout</span>)
      <span class="ruby-identifier">checkout</span>(<span class="ruby-identifier">checkout_timeout</span>)
    <span class="ruby-keyword">rescue</span> <span class="ruby-constant">ConnectionTimeoutError</span>
      <span class="ruby-comment"># this block can&#39;t be easily moved into attempt_to_checkout_all_existing_connections&#39;s</span>
      <span class="ruby-comment"># rescue block, because doing so would put it outside of synchronize section, without</span>
      <span class="ruby-comment"># being in a critical section thread_report might become inaccurate</span>
      <span class="ruby-identifier">msg</span> = <span class="ruby-node">&quot;could not obtain ownership of all database connections in #{checkout_timeout} seconds&quot;</span>.<span class="ruby-identifier">dup</span>

      <span class="ruby-identifier">thread_report</span> = []
      <span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">unless</span> <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">owner</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>
          <span class="ruby-identifier">thread_report</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{conn} is owned by #{conn.owner}&quot;</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">msg</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot; (#{thread_report.join(&#39;, &#39;)})&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">thread_report</span>.<span class="ruby-identifier">any?</span>

      <span class="ruby-identifier">raise</span> <span class="ruby-constant">ExclusiveConnectionTimeoutError</span>, <span class="ruby-identifier">msg</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">with_new_connections_blocked</span>
      <span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>
        <span class="ruby-ivar">@threads_blocking_new_connections</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">yield</span>
    <span class="ruby-keyword">ensure</span>
      <span class="ruby-identifier">num_new_conns_required</span> = <span class="ruby-value">0</span>

      <span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>
        <span class="ruby-ivar">@threads_blocking_new_connections</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>

        <span class="ruby-keyword">if</span> <span class="ruby-ivar">@threads_blocking_new_connections</span>.<span class="ruby-identifier">zero?</span>
          <span class="ruby-ivar">@available</span>.<span class="ruby-identifier">clear</span>

          <span class="ruby-identifier">num_new_conns_required</span> = <span class="ruby-identifier">num_waiting_in_queue</span>

          <span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span>
            <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">in_use?</span>

            <span class="ruby-ivar">@available</span>.<span class="ruby-identifier">add</span> <span class="ruby-identifier">conn</span>
            <span class="ruby-identifier">num_new_conns_required</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">bulk_make_new_connections</span>(<span class="ruby-identifier">num_new_conns_required</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">num_new_conns_required</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Acquire a connection by one of 1) immediately removing one</span>
    <span class="ruby-comment"># from the queue of available connections, 2) creating a new</span>
    <span class="ruby-comment"># connection if the pool is not at capacity, 3) waiting on the</span>
    <span class="ruby-comment"># queue for a connection to become available.</span>
    <span class="ruby-comment">#</span>
    <span class="ruby-comment"># Raises:</span>
    <span class="ruby-comment"># - ActiveRecord::ConnectionTimeoutError if a connection could not be acquired</span>
    <span class="ruby-comment">#</span>
    <span class="ruby-comment">#--</span>
    <span class="ruby-comment"># Implementation detail: the connection returned by +acquire_connection+</span>
    <span class="ruby-comment"># will already be &quot;+connection.lease+ -ed&quot; to the current thread.</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">acquire_connection</span>(<span class="ruby-identifier">checkout_timeout</span>)
      <span class="ruby-comment"># NOTE: we rely on &lt;tt&gt;@available.poll&lt;/tt&gt; and +try_to_checkout_new_connection+ to</span>
      <span class="ruby-comment"># +conn.lease+ the returned connection (and to do this in a +synchronized+</span>
      <span class="ruby-comment"># section). This is not the cleanest implementation, as ideally we would</span>
      <span class="ruby-comment"># &lt;tt&gt;synchronize { conn.lease }&lt;/tt&gt; in this method, but by leaving it to &lt;tt&gt;@available.poll&lt;/tt&gt;</span>
      <span class="ruby-comment"># and +try_to_checkout_new_connection+ we can piggyback on +synchronize+ sections</span>
      <span class="ruby-comment"># of the said methods and avoid an additional +synchronize+ overhead.</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">conn</span> = <span class="ruby-ivar">@available</span>.<span class="ruby-identifier">poll</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">try_to_checkout_new_connection</span>
        <span class="ruby-identifier">conn</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">reap</span>
        <span class="ruby-ivar">@available</span>.<span class="ruby-identifier">poll</span>(<span class="ruby-identifier">checkout_timeout</span>)
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment">#--</span>
    <span class="ruby-comment"># if owner_thread param is omitted, this must be called in synchronize block</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">remove_connection_from_thread_cache</span>(<span class="ruby-identifier">conn</span>, <span class="ruby-identifier">owner_thread</span> = <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">owner</span>)
      <span class="ruby-ivar">@thread_cached_conns</span>.<span class="ruby-identifier">delete_pair</span>(<span class="ruby-identifier">connection_cache_key</span>(<span class="ruby-identifier">owner_thread</span>), <span class="ruby-identifier">conn</span>)
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">alias_method</span> <span class="ruby-value">:release</span>, <span class="ruby-value">:remove_connection_from_thread_cache</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">new_connection</span>
      <span class="ruby-constant">Base</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">adapter_method</span>, <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">config</span>).<span class="ruby-identifier">tap</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">schema_cache</span> = <span class="ruby-identifier">schema_cache</span>.<span class="ruby-identifier">dup</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">schema_cache</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># If the pool is not at a &lt;tt&gt;@size&lt;/tt&gt; limit, establish new connection. Connecting</span>
    <span class="ruby-comment"># to the DB is done outside main synchronized section.</span>
    <span class="ruby-comment">#--</span>
    <span class="ruby-comment"># Implementation constraint: a newly established connection returned by this</span>
    <span class="ruby-comment"># method must be in the +.leased+ state.</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">try_to_checkout_new_connection</span>
      <span class="ruby-comment"># first in synchronized section check if establishing new conns is allowed</span>
      <span class="ruby-comment"># and increment @now_connecting, to prevent overstepping this pool&#39;s @size</span>
      <span class="ruby-comment"># constraint</span>
      <span class="ruby-identifier">do_checkout</span> = <span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>
        <span class="ruby-keyword">if</span> <span class="ruby-ivar">@threads_blocking_new_connections</span>.<span class="ruby-identifier">zero?</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@now_connecting</span>) <span class="ruby-operator">&lt;</span> <span class="ruby-ivar">@size</span>
          <span class="ruby-ivar">@now_connecting</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">do_checkout</span>
        <span class="ruby-keyword">begin</span>
          <span class="ruby-comment"># if successfully incremented @now_connecting establish new connection</span>
          <span class="ruby-comment"># outside of synchronized section</span>
          <span class="ruby-identifier">conn</span> = <span class="ruby-identifier">checkout_new_connection</span>
        <span class="ruby-keyword">ensure</span>
          <span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">conn</span>
              <span class="ruby-identifier">adopt_connection</span>(<span class="ruby-identifier">conn</span>)
              <span class="ruby-comment"># returned conn needs to be already leased</span>
              <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">lease</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-ivar">@now_connecting</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">adopt_connection</span>(<span class="ruby-identifier">conn</span>)
      <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">pool</span> = <span class="ruby-keyword">self</span>
      <span class="ruby-ivar">@connections</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">conn</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">checkout_new_connection</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">ConnectionNotEstablished</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@automatic_reconnect</span>
      <span class="ruby-identifier">new_connection</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">checkout_and_verify</span>(<span class="ruby-identifier">c</span>)
      <span class="ruby-identifier">c</span>.<span class="ruby-identifier">_run_checkout_callbacks</span> <span class="ruby-keyword">do</span>
        <span class="ruby-identifier">c</span>.<span class="ruby-identifier">verify!</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">c</span>
    <span class="ruby-keyword">rescue</span>
      <span class="ruby-identifier">remove</span> <span class="ruby-identifier">c</span>
      <span class="ruby-identifier">c</span>.<span class="ruby-identifier">disconnect!</span>
      <span class="ruby-identifier">raise</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-bulk_make_new_connections">
            
              <b>bulk_make_new_connections</b>(num_new_conns_needed)
            
            <a href="Reaper.html#method-i-bulk_make_new_connections" name="method-i-bulk_make_new_connections" class="permalink">Link</a>
          </div>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-bulk_make_new_connections_source')" id="l_method-i-bulk_make_new_connections_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L650" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-bulk_make_new_connections_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 650</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">bulk_make_new_connections</span>(<span class="ruby-identifier">num_new_conns_needed</span>)
  <span class="ruby-identifier">num_new_conns_needed</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span>
    <span class="ruby-comment"># try_to_checkout_new_connection will not exceed pool&#39;s @size limit</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">new_conn</span> = <span class="ruby-identifier">try_to_checkout_new_connection</span>
      <span class="ruby-comment"># make the new_conn available to the starving threads stuck @available Queue</span>
      <span class="ruby-identifier">checkin</span>(<span class="ruby-identifier">new_conn</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-checkin">
            
              <b>checkin</b>(conn)
            
            <a href="Reaper.html#method-i-checkin" name="method-i-checkin" class="permalink">Link</a>
          </div>

          
            <div class="description">
              <p>Check-in a database connection back into the pool, indicating that you no
longer need this connection.</p>

<p><code>conn</code>: an <a href="../AbstractAdapter.html">AbstractAdapter</a>
object, which was obtained by earlier by calling <a
href="Reaper.html#method-i-checkout">checkout</a> on this pool.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-checkin_source')" id="l_method-i-checkin_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L529" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-checkin_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 529</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">checkin</span>(<span class="ruby-identifier">conn</span>)
  <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">lock</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">remove_connection_from_thread_cache</span> <span class="ruby-identifier">conn</span>

      <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">_run_checkin_callbacks</span> <span class="ruby-keyword">do</span>
        <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">expire</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-ivar">@available</span>.<span class="ruby-identifier">add</span> <span class="ruby-identifier">conn</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-checkout">
            
              <b>checkout</b>(checkout_timeout = @checkout_timeout)
            
            <a href="Reaper.html#method-i-checkout" name="method-i-checkout" class="permalink">Link</a>
          </div>

          
            <div class="description">
              <p>Check-out a database connection from the pool, indicating that you want to
use it. You should call <a href="Reaper.html#method-i-checkin">checkin</a>
when you no longer need this.</p>

<p>This is done by either returning and leasing existing connection, or by
creating a new connection and leasing it.</p>

<p>If all connections are leased and the pool is at capacity (meaning the
number of currently leased connections is greater than or equal to the size
limit set), an <a
href="../../ConnectionTimeoutError.html">ActiveRecord::ConnectionTimeoutError</a>
exception will be raised.</p>

<p>Returns: an <a href="../AbstractAdapter.html">AbstractAdapter</a> object.</p>

<p>Raises:</p>
<ul><li>
<p><a
href="../../ConnectionTimeoutError.html">ActiveRecord::ConnectionTimeoutError</a>
no connection can be obtained from the pool.</p>
</li></ul>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-checkout_source')" id="l_method-i-checkout_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L520" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-checkout_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 520</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">checkout</span>(<span class="ruby-identifier">checkout_timeout</span> = <span class="ruby-ivar">@checkout_timeout</span>)
  <span class="ruby-identifier">checkout_and_verify</span>(<span class="ruby-identifier">acquire_connection</span>(<span class="ruby-identifier">checkout_timeout</span>))
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-checkout_and_verify">
            
              <b>checkout_and_verify</b>(c)
            
            <a href="Reaper.html#method-i-checkout_and_verify" name="method-i-checkout_and_verify" class="permalink">Link</a>
          </div>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-checkout_and_verify_source')" id="l_method-i-checkout_and_verify_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L856" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-checkout_and_verify_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 856</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">checkout_and_verify</span>(<span class="ruby-identifier">c</span>)
  <span class="ruby-identifier">c</span>.<span class="ruby-identifier">_run_checkout_callbacks</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">c</span>.<span class="ruby-identifier">verify!</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">c</span>
<span class="ruby-keyword">rescue</span>
  <span class="ruby-identifier">remove</span> <span class="ruby-identifier">c</span>
  <span class="ruby-identifier">c</span>.<span class="ruby-identifier">disconnect!</span>
  <span class="ruby-identifier">raise</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-checkout_for_exclusive_access">
            
              <b>checkout_for_exclusive_access</b>(checkout_timeout)
            
            <a href="Reaper.html#method-i-checkout_for_exclusive_access" name="method-i-checkout_for_exclusive_access" class="permalink">Link</a>
          </div>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-checkout_for_exclusive_access_source')" id="l_method-i-checkout_for_exclusive_access_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L726" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-checkout_for_exclusive_access_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 726</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">checkout_for_exclusive_access</span>(<span class="ruby-identifier">checkout_timeout</span>)
  <span class="ruby-identifier">checkout</span>(<span class="ruby-identifier">checkout_timeout</span>)
<span class="ruby-keyword">rescue</span> <span class="ruby-constant">ConnectionTimeoutError</span>
  <span class="ruby-comment"># this block can&#39;t be easily moved into attempt_to_checkout_all_existing_connections&#39;s</span>
  <span class="ruby-comment"># rescue block, because doing so would put it outside of synchronize section, without</span>
  <span class="ruby-comment"># being in a critical section thread_report might become inaccurate</span>
  <span class="ruby-identifier">msg</span> = <span class="ruby-node">&quot;could not obtain ownership of all database connections in #{checkout_timeout} seconds&quot;</span>.<span class="ruby-identifier">dup</span>

  <span class="ruby-identifier">thread_report</span> = []
  <span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">owner</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>
      <span class="ruby-identifier">thread_report</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{conn} is owned by #{conn.owner}&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">msg</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot; (#{thread_report.join(&#39;, &#39;)})&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">thread_report</span>.<span class="ruby-identifier">any?</span>

  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ExclusiveConnectionTimeoutError</span>, <span class="ruby-identifier">msg</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-checkout_new_connection">
            
              <b>checkout_new_connection</b>()
            
            <a href="Reaper.html#method-i-checkout_new_connection" name="method-i-checkout_new_connection" class="permalink">Link</a>
          </div>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-checkout_new_connection_source')" id="l_method-i-checkout_new_connection_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L851" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-checkout_new_connection_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 851</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">checkout_new_connection</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ConnectionNotEstablished</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@automatic_reconnect</span>
  <span class="ruby-identifier">new_connection</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-clear_reloadable_connections">
            
              <b>clear_reloadable_connections</b>(raise_on_acquisition_timeout = true)
            
            <a href="Reaper.html#method-i-clear_reloadable_connections" name="method-i-clear_reloadable_connections" class="permalink">Link</a>
          </div>

          
            <div class="description">
              <p>Clears the cache which maps classes and re-connects connections that
require reloading.</p>

<p>Raises:</p>
<ul><li>
<p><a
href="../../ExclusiveConnectionTimeoutError.html">ActiveRecord::ExclusiveConnectionTimeoutError</a>
if unable to gain ownership of all connections in the pool within a timeout
interval (default duration is <code>spec.config[:checkout_timeout] *
2</code> seconds).</p>
</li></ul>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-clear_reloadable_connections_source')" id="l_method-i-clear_reloadable_connections_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L478" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-clear_reloadable_connections_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 478</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">clear_reloadable_connections</span>(<span class="ruby-identifier">raise_on_acquisition_timeout</span> = <span class="ruby-keyword">true</span>)
  <span class="ruby-identifier">with_exclusively_acquired_all_connections</span>(<span class="ruby-identifier">raise_on_acquisition_timeout</span>) <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>
      <span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">in_use?</span>
          <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">steal!</span>
          <span class="ruby-identifier">checkin</span> <span class="ruby-identifier">conn</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">disconnect!</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">requires_reloading?</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">delete_if</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:requires_reloading?</span>)
      <span class="ruby-ivar">@available</span>.<span class="ruby-identifier">clear</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-clear_reloadable_connections-21">
            
              <b>clear_reloadable_connections!</b>()
            
            <a href="Reaper.html#method-i-clear_reloadable_connections-21" name="method-i-clear_reloadable_connections-21" class="permalink">Link</a>
          </div>

          
            <div class="description">
              <p>Clears the cache which maps classes and re-connects connections that
require reloading.</p>

<p>The pool first tries to gain ownership of all connections. If unable to do
so within a timeout interval (default duration is
<code>spec.config[:checkout_timeout] * 2</code> seconds), then the pool
forcefully clears the cache and reloads connections without any regard for
other connection owning threads.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-clear_reloadable_connections-21_source')" id="l_method-i-clear_reloadable_connections-21_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L502" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-clear_reloadable_connections-21_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 502</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">clear_reloadable_connections!</span>
  <span class="ruby-identifier">clear_reloadable_connections</span>(<span class="ruby-keyword">false</span>)
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-connected-3F">
            
              <b>connected?</b>()
            
            <a href="Reaper.html#method-i-connected-3F" name="method-i-connected-3F" class="permalink">Link</a>
          </div>

          
            <div class="description">
              <p>Returns true if a connection has already been opened.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-connected-3F_source')" id="l_method-i-connected-3F_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L420" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-connected-3F_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 420</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">connected?</span>
  <span class="ruby-identifier">synchronize</span> { <span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">any?</span> }
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-connection">
            
              <b>connection</b>()
            
            <a href="Reaper.html#method-i-connection" name="method-i-connection" class="permalink">Link</a>
          </div>

          
            <div class="description">
              <p>Retrieve the connection associated with the current thread, or call <a
href="Reaper.html#method-i-checkout">checkout</a> to obtain one if
necessary.</p>

<p><a href="Reaper.html#method-i-connection">connection</a> can be called any
number of times; the connection is held in a cache keyed by a thread.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-connection_source')" id="l_method-i-connection_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L379" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-connection_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 379</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">connection</span>
  <span class="ruby-ivar">@thread_cached_conns</span>[<span class="ruby-identifier">connection_cache_key</span>(<span class="ruby-ivar">@lock_thread</span> <span class="ruby-operator">||</span> <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>)] <span class="ruby-operator">||=</span> <span class="ruby-identifier">checkout</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-connection_cache_key">
            
              <b>connection_cache_key</b>(thread)
            
            <a href="Reaper.html#method-i-connection_cache_key" name="method-i-connection_cache_key" class="permalink">Link</a>
          </div>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-connection_cache_key_source')" id="l_method-i-connection_cache_key_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L665" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-connection_cache_key_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 665</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">connection_cache_key</span>(<span class="ruby-identifier">thread</span>)
  <span class="ruby-identifier">thread</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-disconnect">
            
              <b>disconnect</b>(raise_on_acquisition_timeout = true)
            
            <a href="Reaper.html#method-i-disconnect" name="method-i-disconnect" class="permalink">Link</a>
          </div>

          
            <div class="description">
              <p>Disconnects all connections in the pool, and clears the pool.</p>

<p>Raises:</p>
<ul><li>
<p><a
href="../../ExclusiveConnectionTimeoutError.html">ActiveRecord::ExclusiveConnectionTimeoutError</a>
if unable to gain ownership of all connections in the pool within a timeout
interval (default duration is <code>spec.config[:checkout_timeout] *
2</code> seconds).</p>
</li></ul>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-disconnect_source')" id="l_method-i-disconnect_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L430" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-disconnect_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 430</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">disconnect</span>(<span class="ruby-identifier">raise_on_acquisition_timeout</span> = <span class="ruby-keyword">true</span>)
  <span class="ruby-identifier">with_exclusively_acquired_all_connections</span>(<span class="ruby-identifier">raise_on_acquisition_timeout</span>) <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>
      <span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">in_use?</span>
          <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">steal!</span>
          <span class="ruby-identifier">checkin</span> <span class="ruby-identifier">conn</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">disconnect!</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-ivar">@connections</span> = []
      <span class="ruby-ivar">@available</span>.<span class="ruby-identifier">clear</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-disconnect-21">
            
              <b>disconnect!</b>()
            
            <a href="Reaper.html#method-i-disconnect-21" name="method-i-disconnect-21" class="permalink">Link</a>
          </div>

          
            <div class="description">
              <p>Disconnects all connections in the pool, and clears the pool.</p>

<p>The pool first tries to gain ownership of all connections. If unable to do
so within a timeout interval (default duration is
<code>spec.config[:checkout_timeout] * 2</code> seconds), then the pool is
forcefully disconnected without any regard for other connection owning
threads.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-disconnect-21_source')" id="l_method-i-disconnect-21_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L452" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-disconnect-21_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 452</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">disconnect!</span>
  <span class="ruby-identifier">disconnect</span>(<span class="ruby-keyword">false</span>)
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-flush">
            
              <b>flush</b>(minimum_idle = @idle_timeout)
            
            <a href="Reaper.html#method-i-flush" name="method-i-flush" class="permalink">Link</a>
          </div>

          
            <div class="description">
              <p>Disconnect all connections that have been idle for at least
<code>minimum_idle</code> seconds. Connections currently checked out, or
that were checked in less than <code>minimum_idle</code> seconds ago, are
unaffected.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-flush_source')" id="l_method-i-flush_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L599" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-flush_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 599</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">flush</span>(<span class="ruby-identifier">minimum_idle</span> = <span class="ruby-ivar">@idle_timeout</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">minimum_idle</span>.<span class="ruby-identifier">nil?</span>

      <span class="ruby-identifier">idle_connections</span> = <span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>
        <span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">select</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span>
          <span class="ruby-operator">!</span><span class="ruby-identifier">conn</span>.<span class="ruby-identifier">in_use?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">seconds_idle</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-identifier">minimum_idle</span>
        <span class="ruby-keyword">end</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span>
          <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">lease</span>

          <span class="ruby-ivar">@available</span>.<span class="ruby-identifier">delete</span> <span class="ruby-identifier">conn</span>
          <span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">delete</span> <span class="ruby-identifier">conn</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">idle_connections</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">disconnect!</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Disconnect all currently idle connections. Connections currently checked</span>
    <span class="ruby-comment"># out are unaffected.</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">flush!</span>
      <span class="ruby-identifier">reap</span>
      <span class="ruby-identifier">flush</span>(<span class="ruby-value">-1</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">num_waiting_in_queue</span> <span class="ruby-comment"># :nodoc:</span>
      <span class="ruby-ivar">@available</span>.<span class="ruby-identifier">num_waiting</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Return connection pool&#39;s usage statistic</span>
    <span class="ruby-comment"># Example:</span>
    <span class="ruby-comment">#</span>
    <span class="ruby-comment">#    ActiveRecord::Base.connection_pool.stat # =&gt; { size: 15, connections: 1, busy: 1, dead: 0, idle: 0, waiting: 0, checkout_timeout: 5 }</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">stat</span>
      <span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>
        {
          <span class="ruby-value">size:</span> <span class="ruby-identifier">size</span>,
          <span class="ruby-value">connections:</span> <span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">size</span>,
          <span class="ruby-value">busy:</span> <span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">count</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">in_use?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">alive?</span> },
          <span class="ruby-value">dead:</span> <span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">count</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">in_use?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">c</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">alive?</span> },
          <span class="ruby-value">idle:</span> <span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">count</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-operator">!</span><span class="ruby-identifier">c</span>.<span class="ruby-identifier">in_use?</span> },
          <span class="ruby-value">waiting:</span> <span class="ruby-identifier">num_waiting_in_queue</span>,
          <span class="ruby-value">checkout_timeout:</span> <span class="ruby-identifier">checkout_timeout</span>
        }
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">private</span>
      <span class="ruby-comment">#--</span>
      <span class="ruby-comment"># this is unfortunately not concurrent</span>
      <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">bulk_make_new_connections</span>(<span class="ruby-identifier">num_new_conns_needed</span>)
        <span class="ruby-identifier">num_new_conns_needed</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span>
          <span class="ruby-comment"># try_to_checkout_new_connection will not exceed pool&#39;s @size limit</span>
          <span class="ruby-keyword">if</span> <span class="ruby-identifier">new_conn</span> = <span class="ruby-identifier">try_to_checkout_new_connection</span>
            <span class="ruby-comment"># make the new_conn available to the starving threads stuck @available Queue</span>
            <span class="ruby-identifier">checkin</span>(<span class="ruby-identifier">new_conn</span>)
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-comment">#--</span>
      <span class="ruby-comment"># From the discussion on GitHub:</span>
      <span class="ruby-comment">#  https://github.com/rails/rails/pull/14938#commitcomment-6601951</span>
      <span class="ruby-comment"># This hook-in method allows for easier monkey-patching fixes needed by</span>
      <span class="ruby-comment"># JRuby users that use Fibers.</span>
      <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">connection_cache_key</span>(<span class="ruby-identifier">thread</span>)
        <span class="ruby-identifier">thread</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-comment"># Take control of all existing connections so a &quot;group&quot; action such as</span>
      <span class="ruby-comment"># reload/disconnect can be performed safely. It is no longer enough to</span>
      <span class="ruby-comment"># wrap it in +synchronize+ because some pool&#39;s actions are allowed</span>
      <span class="ruby-comment"># to be performed outside of the main +synchronize+ block.</span>
      <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">with_exclusively_acquired_all_connections</span>(<span class="ruby-identifier">raise_on_acquisition_timeout</span> = <span class="ruby-keyword">true</span>)
        <span class="ruby-identifier">with_new_connections_blocked</span> <span class="ruby-keyword">do</span>
          <span class="ruby-identifier">attempt_to_checkout_all_existing_connections</span>(<span class="ruby-identifier">raise_on_acquisition_timeout</span>)
          <span class="ruby-keyword">yield</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">attempt_to_checkout_all_existing_connections</span>(<span class="ruby-identifier">raise_on_acquisition_timeout</span> = <span class="ruby-keyword">true</span>)
        <span class="ruby-identifier">collected_conns</span> = <span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>
          <span class="ruby-comment"># account for our own connections</span>
          <span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">select</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span> <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">owner</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span> }
        <span class="ruby-keyword">end</span>

        <span class="ruby-identifier">newly_checked_out</span> = []
        <span class="ruby-identifier">timeout_time</span>      = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> <span class="ruby-operator">+</span> (<span class="ruby-ivar">@checkout_timeout</span> <span class="ruby-operator">*</span> <span class="ruby-value">2</span>)

        <span class="ruby-ivar">@available</span>.<span class="ruby-identifier">with_a_bias_for</span>(<span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>) <span class="ruby-keyword">do</span>
          <span class="ruby-identifier">loop</span> <span class="ruby-keyword">do</span>
            <span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>
              <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">collected_conns</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@now_connecting</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
              <span class="ruby-identifier">remaining_timeout</span> = <span class="ruby-identifier">timeout_time</span> <span class="ruby-operator">-</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
              <span class="ruby-identifier">remaining_timeout</span> = <span class="ruby-value">0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">remaining_timeout</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span>
              <span class="ruby-identifier">conn</span> = <span class="ruby-identifier">checkout_for_exclusive_access</span>(<span class="ruby-identifier">remaining_timeout</span>)
              <span class="ruby-identifier">collected_conns</span>   <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">conn</span>
              <span class="ruby-identifier">newly_checked_out</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">conn</span>
            <span class="ruby-keyword">end</span>
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">rescue</span> <span class="ruby-constant">ExclusiveConnectionTimeoutError</span>
        <span class="ruby-comment"># &lt;tt&gt;raise_on_acquisition_timeout == false&lt;/tt&gt; means we are directed to ignore any</span>
        <span class="ruby-comment"># timeouts and are expected to just give up: we&#39;ve obtained as many connections</span>
        <span class="ruby-comment"># as possible, note that in a case like that we don&#39;t return any of the</span>
        <span class="ruby-comment"># +newly_checked_out+ connections.</span>

        <span class="ruby-keyword">if</span> <span class="ruby-identifier">raise_on_acquisition_timeout</span>
          <span class="ruby-identifier">release_newly_checked_out</span> = <span class="ruby-keyword">true</span>
          <span class="ruby-identifier">raise</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Exception</span> <span class="ruby-comment"># if something else went wrong</span>
        <span class="ruby-comment"># this can&#39;t be a &quot;naked&quot; rescue, because we have should return conns</span>
        <span class="ruby-comment"># even for non-StandardErrors</span>
        <span class="ruby-identifier">release_newly_checked_out</span> = <span class="ruby-keyword">true</span>
        <span class="ruby-identifier">raise</span>
      <span class="ruby-keyword">ensure</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">release_newly_checked_out</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">newly_checked_out</span>
          <span class="ruby-comment"># releasing only those conns that were checked out in this method, conns</span>
          <span class="ruby-comment"># checked outside this method (before it was called) are not for us to release</span>
          <span class="ruby-identifier">newly_checked_out</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span> <span class="ruby-identifier">checkin</span>(<span class="ruby-identifier">conn</span>) }
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-comment">#--</span>
      <span class="ruby-comment"># Must be called in a synchronize block.</span>
      <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">checkout_for_exclusive_access</span>(<span class="ruby-identifier">checkout_timeout</span>)
        <span class="ruby-identifier">checkout</span>(<span class="ruby-identifier">checkout_timeout</span>)
      <span class="ruby-keyword">rescue</span> <span class="ruby-constant">ConnectionTimeoutError</span>
        <span class="ruby-comment"># this block can&#39;t be easily moved into attempt_to_checkout_all_existing_connections&#39;s</span>
        <span class="ruby-comment"># rescue block, because doing so would put it outside of synchronize section, without</span>
        <span class="ruby-comment"># being in a critical section thread_report might become inaccurate</span>
        <span class="ruby-identifier">msg</span> = <span class="ruby-node">&quot;could not obtain ownership of all database connections in #{checkout_timeout} seconds&quot;</span>.<span class="ruby-identifier">dup</span>

        <span class="ruby-identifier">thread_report</span> = []
        <span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span>
          <span class="ruby-keyword">unless</span> <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">owner</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>
            <span class="ruby-identifier">thread_report</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{conn} is owned by #{conn.owner}&quot;</span>
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-identifier">msg</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot; (#{thread_report.join(&#39;, &#39;)})&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">thread_report</span>.<span class="ruby-identifier">any?</span>

        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ExclusiveConnectionTimeoutError</span>, <span class="ruby-identifier">msg</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">with_new_connections_blocked</span>
        <span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>
          <span class="ruby-ivar">@threads_blocking_new_connections</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">yield</span>
      <span class="ruby-keyword">ensure</span>
        <span class="ruby-identifier">num_new_conns_required</span> = <span class="ruby-value">0</span>

        <span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>
          <span class="ruby-ivar">@threads_blocking_new_connections</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>

          <span class="ruby-keyword">if</span> <span class="ruby-ivar">@threads_blocking_new_connections</span>.<span class="ruby-identifier">zero?</span>
            <span class="ruby-ivar">@available</span>.<span class="ruby-identifier">clear</span>

            <span class="ruby-identifier">num_new_conns_required</span> = <span class="ruby-identifier">num_waiting_in_queue</span>

            <span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span>
              <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">in_use?</span>

              <span class="ruby-ivar">@available</span>.<span class="ruby-identifier">add</span> <span class="ruby-identifier">conn</span>
              <span class="ruby-identifier">num_new_conns_required</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>
            <span class="ruby-keyword">end</span>
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-identifier">bulk_make_new_connections</span>(<span class="ruby-identifier">num_new_conns_required</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">num_new_conns_required</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-comment"># Acquire a connection by one of 1) immediately removing one</span>
      <span class="ruby-comment"># from the queue of available connections, 2) creating a new</span>
      <span class="ruby-comment"># connection if the pool is not at capacity, 3) waiting on the</span>
      <span class="ruby-comment"># queue for a connection to become available.</span>
      <span class="ruby-comment">#</span>
      <span class="ruby-comment"># Raises:</span>
      <span class="ruby-comment"># - ActiveRecord::ConnectionTimeoutError if a connection could not be acquired</span>
      <span class="ruby-comment">#</span>
      <span class="ruby-comment">#--</span>
      <span class="ruby-comment"># Implementation detail: the connection returned by +acquire_connection+</span>
      <span class="ruby-comment"># will already be &quot;+connection.lease+ -ed&quot; to the current thread.</span>
      <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">acquire_connection</span>(<span class="ruby-identifier">checkout_timeout</span>)
        <span class="ruby-comment"># NOTE: we rely on &lt;tt&gt;@available.poll&lt;/tt&gt; and +try_to_checkout_new_connection+ to</span>
        <span class="ruby-comment"># +conn.lease+ the returned connection (and to do this in a +synchronized+</span>
        <span class="ruby-comment"># section). This is not the cleanest implementation, as ideally we would</span>
        <span class="ruby-comment"># &lt;tt&gt;synchronize { conn.lease }&lt;/tt&gt; in this method, but by leaving it to &lt;tt&gt;@available.poll&lt;/tt&gt;</span>
        <span class="ruby-comment"># and +try_to_checkout_new_connection+ we can piggyback on +synchronize+ sections</span>
        <span class="ruby-comment"># of the said methods and avoid an additional +synchronize+ overhead.</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">conn</span> = <span class="ruby-ivar">@available</span>.<span class="ruby-identifier">poll</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">try_to_checkout_new_connection</span>
          <span class="ruby-identifier">conn</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">reap</span>
          <span class="ruby-ivar">@available</span>.<span class="ruby-identifier">poll</span>(<span class="ruby-identifier">checkout_timeout</span>)
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-comment">#--</span>
      <span class="ruby-comment"># if owner_thread param is omitted, this must be called in synchronize block</span>
      <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">remove_connection_from_thread_cache</span>(<span class="ruby-identifier">conn</span>, <span class="ruby-identifier">owner_thread</span> = <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">owner</span>)
        <span class="ruby-ivar">@thread_cached_conns</span>.<span class="ruby-identifier">delete_pair</span>(<span class="ruby-identifier">connection_cache_key</span>(<span class="ruby-identifier">owner_thread</span>), <span class="ruby-identifier">conn</span>)
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">alias_method</span> <span class="ruby-value">:release</span>, <span class="ruby-value">:remove_connection_from_thread_cache</span>

      <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">new_connection</span>
        <span class="ruby-constant">Base</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">adapter_method</span>, <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">config</span>).<span class="ruby-identifier">tap</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span>
          <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">schema_cache</span> = <span class="ruby-identifier">schema_cache</span>.<span class="ruby-identifier">dup</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">schema_cache</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-comment"># If the pool is not at a &lt;tt&gt;@size&lt;/tt&gt; limit, establish new connection. Connecting</span>
      <span class="ruby-comment"># to the DB is done outside main synchronized section.</span>
      <span class="ruby-comment">#--</span>
      <span class="ruby-comment"># Implementation constraint: a newly established connection returned by this</span>
      <span class="ruby-comment"># method must be in the +.leased+ state.</span>
      <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">try_to_checkout_new_connection</span>
        <span class="ruby-comment"># first in synchronized section check if establishing new conns is allowed</span>
        <span class="ruby-comment"># and increment @now_connecting, to prevent overstepping this pool&#39;s @size</span>
        <span class="ruby-comment"># constraint</span>
        <span class="ruby-identifier">do_checkout</span> = <span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>
          <span class="ruby-keyword">if</span> <span class="ruby-ivar">@threads_blocking_new_connections</span>.<span class="ruby-identifier">zero?</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@now_connecting</span>) <span class="ruby-operator">&lt;</span> <span class="ruby-ivar">@size</span>
            <span class="ruby-ivar">@now_connecting</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">do_checkout</span>
          <span class="ruby-keyword">begin</span>
            <span class="ruby-comment"># if successfully incremented @now_connecting establish new connection</span>
            <span class="ruby-comment"># outside of synchronized section</span>
            <span class="ruby-identifier">conn</span> = <span class="ruby-identifier">checkout_new_connection</span>
          <span class="ruby-keyword">ensure</span>
            <span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>
              <span class="ruby-keyword">if</span> <span class="ruby-identifier">conn</span>
                <span class="ruby-identifier">adopt_connection</span>(<span class="ruby-identifier">conn</span>)
                <span class="ruby-comment"># returned conn needs to be already leased</span>
                <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">lease</span>
              <span class="ruby-keyword">end</span>
              <span class="ruby-ivar">@now_connecting</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>
            <span class="ruby-keyword">end</span>
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">adopt_connection</span>(<span class="ruby-identifier">conn</span>)
        <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">pool</span> = <span class="ruby-keyword">self</span>
        <span class="ruby-ivar">@connections</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">conn</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">checkout_new_connection</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ConnectionNotEstablished</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@automatic_reconnect</span>
        <span class="ruby-identifier">new_connection</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">checkout_and_verify</span>(<span class="ruby-identifier">c</span>)
        <span class="ruby-identifier">c</span>.<span class="ruby-identifier">_run_checkout_callbacks</span> <span class="ruby-keyword">do</span>
          <span class="ruby-identifier">c</span>.<span class="ruby-identifier">verify!</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">c</span>
      <span class="ruby-keyword">rescue</span>
        <span class="ruby-identifier">remove</span> <span class="ruby-identifier">c</span>
        <span class="ruby-identifier">c</span>.<span class="ruby-identifier">disconnect!</span>
        <span class="ruby-identifier">raise</span>
      <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># ConnectionHandler is a collection of ConnectionPool objects. It is used</span>
  <span class="ruby-comment"># for keeping separate connection pools that connect to different databases.</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-comment"># For example, suppose that you have 5 models, with the following hierarchy:</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-comment">#   class Author &lt; ActiveRecord::Base</span>
  <span class="ruby-comment">#   end</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-comment">#   class BankAccount &lt; ActiveRecord::Base</span>
  <span class="ruby-comment">#   end</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-comment">#   class Book &lt; ActiveRecord::Base</span>
  <span class="ruby-comment">#     establish_connection :library_db</span>
  <span class="ruby-comment">#   end</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-comment">#   class ScaryBook &lt; Book</span>
  <span class="ruby-comment">#   end</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-comment">#   class GoodBook &lt; Book</span>
  <span class="ruby-comment">#   end</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-comment"># And a database.yml that looked like this:</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-comment">#   development:</span>
  <span class="ruby-comment">#     database: my_application</span>
  <span class="ruby-comment">#     host: localhost</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-comment">#   library_db:</span>
  <span class="ruby-comment">#     database: library</span>
  <span class="ruby-comment">#     host: some.library.org</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-comment"># Your primary database in the development environment is &quot;my_application&quot;</span>
  <span class="ruby-comment"># but the Book model connects to a separate database called &quot;library_db&quot;</span>
  <span class="ruby-comment"># (this can even be a database on a different machine).</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-comment"># Book, ScaryBook and GoodBook will all use the same connection pool to</span>
  <span class="ruby-comment"># &quot;library_db&quot; while Author, BankAccount, and any other models you create</span>
  <span class="ruby-comment"># will use the default connection pool to &quot;my_application&quot;.</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-comment"># The various connection pools are managed by a single instance of</span>
  <span class="ruby-comment"># ConnectionHandler accessible via ActiveRecord::Base.connection_handler.</span>
  <span class="ruby-comment"># All Active Record models use this handler to determine the connection pool that they</span>
  <span class="ruby-comment"># should use.</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-comment"># The ConnectionHandler class is not coupled with the Active models, as it has no knowledge</span>
  <span class="ruby-comment"># about the model. The model needs to pass a specification name to the handler,</span>
  <span class="ruby-comment"># in order to look up the correct connection pool.</span>
  <span class="ruby-keyword">class</span> <span class="ruby-constant">ConnectionHandler</span>
    <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">unowned_pool_finalizer</span>(<span class="ruby-identifier">pid_map</span>) <span class="ruby-comment"># :nodoc:</span>
      <span class="ruby-identifier">lambda</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">_</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">discard_unowned_pools</span>(<span class="ruby-identifier">pid_map</span>)
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">discard_unowned_pools</span>(<span class="ruby-identifier">pid_map</span>) <span class="ruby-comment"># :nodoc:</span>
      <span class="ruby-identifier">pid_map</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">pid</span>, <span class="ruby-identifier">pools</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">pools</span>.<span class="ruby-identifier">values</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">each</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:discard!</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">pid</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Process</span>.<span class="ruby-identifier">pid</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">initialize</span>
      <span class="ruby-comment"># These caches are keyed by spec.name (ConnectionSpecification#name).</span>
      <span class="ruby-ivar">@owner_to_pool</span> = <span class="ruby-constant">Concurrent</span><span class="ruby-operator">::</span><span class="ruby-constant">Map</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">initial_capacity:</span> <span class="ruby-value">2</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">h</span>, <span class="ruby-identifier">k</span><span class="ruby-operator">|</span>
        <span class="ruby-comment"># Discard the parent&#39;s connection pools immediately; we have no need</span>
        <span class="ruby-comment"># of them</span>
        <span class="ruby-constant">ConnectionHandler</span>.<span class="ruby-identifier">discard_unowned_pools</span>(<span class="ruby-identifier">h</span>)

        <span class="ruby-identifier">h</span>[<span class="ruby-identifier">k</span>] = <span class="ruby-constant">Concurrent</span><span class="ruby-operator">::</span><span class="ruby-constant">Map</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">initial_capacity:</span> <span class="ruby-value">2</span>)
      <span class="ruby-keyword">end</span>

      <span class="ruby-comment"># Backup finalizer: if the forked child never needed a pool, the above</span>
      <span class="ruby-comment"># early discard has not occurred</span>
      <span class="ruby-constant">ObjectSpace</span>.<span class="ruby-identifier">define_finalizer</span> <span class="ruby-keyword">self</span>, <span class="ruby-constant">ConnectionHandler</span>.<span class="ruby-identifier">unowned_pool_finalizer</span>(<span class="ruby-ivar">@owner_to_pool</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">connection_pool_list</span>
      <span class="ruby-identifier">owner_to_pool</span>.<span class="ruby-identifier">values</span>.<span class="ruby-identifier">compact</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">alias</span> <span class="ruby-value">:connection_pools</span> <span class="ruby-value">:connection_pool_list</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">establish_connection</span>(<span class="ruby-identifier">config</span>)
      <span class="ruby-identifier">resolver</span> = <span class="ruby-constant">ConnectionSpecification</span><span class="ruby-operator">::</span><span class="ruby-constant">Resolver</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">Base</span>.<span class="ruby-identifier">configurations</span>)
      <span class="ruby-identifier">spec</span> = <span class="ruby-identifier">resolver</span>.<span class="ruby-identifier">spec</span>(<span class="ruby-identifier">config</span>)

      <span class="ruby-identifier">remove_connection</span>(<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">name</span>)

      <span class="ruby-identifier">message_bus</span> = <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">Notifications</span>.<span class="ruby-identifier">instrumenter</span>
      <span class="ruby-identifier">payload</span> = {
        <span class="ruby-value">connection_id:</span> <span class="ruby-identifier">object_id</span>
      }
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">spec</span>
        <span class="ruby-identifier">payload</span>[<span class="ruby-value">:spec_name</span>] = <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">name</span>
        <span class="ruby-identifier">payload</span>[<span class="ruby-value">:config</span>] = <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">config</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">message_bus</span>.<span class="ruby-identifier">instrument</span>(<span class="ruby-string">&quot;!connection.active_record&quot;</span>, <span class="ruby-identifier">payload</span>) <span class="ruby-keyword">do</span>
        <span class="ruby-identifier">owner_to_pool</span>[<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">name</span>] = <span class="ruby-constant">ConnectionAdapters</span><span class="ruby-operator">::</span><span class="ruby-constant">ConnectionPool</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">spec</span>)
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">owner_to_pool</span>[<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">name</span>]
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Returns true if there are any active connections among the connection</span>
    <span class="ruby-comment"># pools that the ConnectionHandler is managing.</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">active_connections?</span>
      <span class="ruby-identifier">connection_pool_list</span>.<span class="ruby-identifier">any?</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:active_connection?</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Returns any connections in use by the current thread back to the pool,</span>
    <span class="ruby-comment"># and also returns connections to the pool cached by threads that are no</span>
    <span class="ruby-comment"># longer alive.</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">clear_active_connections!</span>
      <span class="ruby-identifier">connection_pool_list</span>.<span class="ruby-identifier">each</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:release_connection</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Clears the cache which maps classes.</span>
    <span class="ruby-comment">#</span>
    <span class="ruby-comment"># See ConnectionPool#clear_reloadable_connections! for details.</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">clear_reloadable_connections!</span>
      <span class="ruby-identifier">connection_pool_list</span>.<span class="ruby-identifier">each</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:clear_reloadable_connections!</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">clear_all_connections!</span>
      <span class="ruby-identifier">connection_pool_list</span>.<span class="ruby-identifier">each</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:disconnect!</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Disconnects all currently idle connections.</span>
    <span class="ruby-comment">#</span>
    <span class="ruby-comment"># See ConnectionPool#flush! for details.</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">flush_idle_connections!</span>
      <span class="ruby-identifier">connection_pool_list</span>.<span class="ruby-identifier">each</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:flush!</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Locate the connection of the nearest super class. This can be an</span>
    <span class="ruby-comment"># active or defined connection: if it is the latter, it will be</span>
    <span class="ruby-comment"># opened and set as the active connection for the class it was defined</span>
    <span class="ruby-comment"># for (not necessarily the current class).</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">retrieve_connection</span>(<span class="ruby-identifier">spec_name</span>) <span class="ruby-comment">#:nodoc:</span>
      <span class="ruby-identifier">pool</span> = <span class="ruby-identifier">retrieve_connection_pool</span>(<span class="ruby-identifier">spec_name</span>)
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">ConnectionNotEstablished</span>, <span class="ruby-node">&quot;No connection pool with &#39;#{spec_name}&#39; found.&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">pool</span>
      <span class="ruby-identifier">pool</span>.<span class="ruby-identifier">connection</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Returns true if a connection that&#39;s accessible to this class has</span>
    <span class="ruby-comment"># already been opened.</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">connected?</span>(<span class="ruby-identifier">spec_name</span>)
      <span class="ruby-identifier">conn</span> = <span class="ruby-identifier">retrieve_connection_pool</span>(<span class="ruby-identifier">spec_name</span>)
      <span class="ruby-identifier">conn</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">connected?</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Remove the connection for this class. This will close the active</span>
    <span class="ruby-comment"># connection and the defined connection (if they exist). The result</span>
    <span class="ruby-comment"># can be used as an argument for #establish_connection, for easily</span>
    <span class="ruby-comment"># re-establishing the connection.</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">remove_connection</span>(<span class="ruby-identifier">spec_name</span>)
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">pool</span> = <span class="ruby-identifier">owner_to_pool</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">spec_name</span>)
        <span class="ruby-identifier">pool</span>.<span class="ruby-identifier">automatic_reconnect</span> = <span class="ruby-keyword">false</span>
        <span class="ruby-identifier">pool</span>.<span class="ruby-identifier">disconnect!</span>
        <span class="ruby-identifier">pool</span>.<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">config</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Retrieving the connection pool happens a lot, so we cache it in @owner_to_pool.</span>
    <span class="ruby-comment"># This makes retrieving the connection pool O(1) once the process is warm.</span>
    <span class="ruby-comment"># When a connection is established or removed, we invalidate the cache.</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">retrieve_connection_pool</span>(<span class="ruby-identifier">spec_name</span>)
      <span class="ruby-identifier">owner_to_pool</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-identifier">spec_name</span>) <span class="ruby-keyword">do</span>
        <span class="ruby-comment"># Check if a connection was previously established in an ancestor process,</span>
        <span class="ruby-comment"># which may have been forked.</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">ancestor_pool</span> = <span class="ruby-identifier">pool_from_any_process_for</span>(<span class="ruby-identifier">spec_name</span>)
          <span class="ruby-comment"># A connection was established in an ancestor process that must have</span>
          <span class="ruby-comment"># subsequently forked. We can&#39;t reuse the connection, but we can copy</span>
          <span class="ruby-comment"># the specification and establish a new connection with it.</span>
          <span class="ruby-identifier">establish_connection</span>(<span class="ruby-identifier">ancestor_pool</span>.<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">to_hash</span>).<span class="ruby-identifier">tap</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">pool</span><span class="ruby-operator">|</span>
            <span class="ruby-identifier">pool</span>.<span class="ruby-identifier">schema_cache</span> = <span class="ruby-identifier">ancestor_pool</span>.<span class="ruby-identifier">schema_cache</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">ancestor_pool</span>.<span class="ruby-identifier">schema_cache</span>
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">owner_to_pool</span>[<span class="ruby-identifier">spec_name</span>] = <span class="ruby-keyword">nil</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">private</span>

      <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">owner_to_pool</span>
        <span class="ruby-ivar">@owner_to_pool</span>[<span class="ruby-constant">Process</span>.<span class="ruby-identifier">pid</span>]
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">pool_from_any_process_for</span>(<span class="ruby-identifier">spec_name</span>)
        <span class="ruby-identifier">owner_to_pool</span> = <span class="ruby-ivar">@owner_to_pool</span>.<span class="ruby-identifier">values</span>.<span class="ruby-identifier">reverse</span>.<span class="ruby-identifier">find</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">v</span>[<span class="ruby-identifier">spec_name</span>] }
        <span class="ruby-identifier">owner_to_pool</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">owner_to_pool</span>[<span class="ruby-identifier">spec_name</span>]
      <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-flush-21">
            
              <b>flush!</b>()
            
            <a href="Reaper.html#method-i-flush-21" name="method-i-flush-21" class="permalink">Link</a>
          </div>

          
            <div class="description">
              <p>Disconnect all currently idle connections. Connections currently checked
out are unaffected.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-flush-21_source')" id="l_method-i-flush-21_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L620" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-flush-21_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 620</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">flush!</span>
  <span class="ruby-identifier">reap</span>
  <span class="ruby-identifier">flush</span>(<span class="ruby-value">-1</span>)
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-lock_thread-3D">
            
              <b>lock_thread=</b>(lock_thread)
            
            <a href="Reaper.html#method-i-lock_thread-3D" name="method-i-lock_thread-3D" class="permalink">Link</a>
          </div>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-lock_thread-3D_source')" id="l_method-i-lock_thread-3D_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L366" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-lock_thread-3D_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 366</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">lock_thread=</span>(<span class="ruby-identifier">lock_thread</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">lock_thread</span>
    <span class="ruby-ivar">@lock_thread</span> = <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-ivar">@lock_thread</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-new_connection">
            
              <b>new_connection</b>()
            
            <a href="Reaper.html#method-i-new_connection" name="method-i-new_connection" class="permalink">Link</a>
          </div>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-new_connection_source')" id="l_method-i-new_connection_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L808" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-new_connection_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 808</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">new_connection</span>
  <span class="ruby-constant">Base</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">adapter_method</span>, <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">config</span>).<span class="ruby-identifier">tap</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">schema_cache</span> = <span class="ruby-identifier">schema_cache</span>.<span class="ruby-identifier">dup</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">schema_cache</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-reap">
            
              <b>reap</b>()
            
            <a href="Reaper.html#method-i-reap" name="method-i-reap" class="permalink">Link</a>
          </div>

          
            <div class="description">
              <p>Recover lost connections for the pool. A lost connection can occur if a
programmer forgets to checkin a connection at the end of a thread or a
thread dies unexpectedly.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-reap_source')" id="l_method-i-reap_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L577" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-reap_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 577</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">reap</span>
  <span class="ruby-identifier">stale_connections</span> = <span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>
    <span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">select</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">in_use?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">conn</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">alive?</span>
    <span class="ruby-keyword">end</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">steal!</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">stale_connections</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">active?</span>
      <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">reset!</span>
      <span class="ruby-identifier">checkin</span> <span class="ruby-identifier">conn</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">remove</span> <span class="ruby-identifier">conn</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-release_connection">
            
              <b>release_connection</b>(owner_thread = Thread.current)
            
            <a href="Reaper.html#method-i-release_connection" name="method-i-release_connection" class="permalink">Link</a>
          </div>

          
            <div class="description">
              <p>Signal that the thread is finished with the current connection. <a
href="Reaper.html#method-i-release_connection">release_connection</a>
releases the connection-thread association and returns the connection to
the pool.</p>

<p>This method only works for connections that have been obtained through <a
href="Reaper.html#method-i-connection">connection</a> or <a
href="Reaper.html#method-i-with_connection">with_connection</a> methods,
connections obtained through <a
href="Reaper.html#method-i-checkout">checkout</a> will not be automatically
released.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-release_connection_source')" id="l_method-i-release_connection_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L399" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-release_connection_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 399</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">release_connection</span>(<span class="ruby-identifier">owner_thread</span> = <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">conn</span> = <span class="ruby-ivar">@thread_cached_conns</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">connection_cache_key</span>(<span class="ruby-identifier">owner_thread</span>))
    <span class="ruby-identifier">checkin</span> <span class="ruby-identifier">conn</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-remove">
            
              <b>remove</b>(conn)
            
            <a href="Reaper.html#method-i-remove" name="method-i-remove" class="permalink">Link</a>
          </div>

          
            <div class="description">
              <p>Remove a connection from the connection pool. The connection will remain
open and active but will no longer be managed by this pool.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-remove_source')" id="l_method-i-remove_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L545" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-remove_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 545</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">remove</span>(<span class="ruby-identifier">conn</span>)
  <span class="ruby-identifier">needs_new_connection</span> = <span class="ruby-keyword">false</span>

  <span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">remove_connection_from_thread_cache</span> <span class="ruby-identifier">conn</span>

    <span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">delete</span> <span class="ruby-identifier">conn</span>
    <span class="ruby-ivar">@available</span>.<span class="ruby-identifier">delete</span> <span class="ruby-identifier">conn</span>

    <span class="ruby-comment"># @available.any_waiting? =&gt; true means that prior to removing this</span>
    <span class="ruby-comment"># conn, the pool was at its max size (@connections.size == @size).</span>
    <span class="ruby-comment"># This would mean that any threads stuck waiting in the queue wouldn&#39;t</span>
    <span class="ruby-comment"># know they could checkout_new_connection, so let&#39;s do it for them.</span>
    <span class="ruby-comment"># Because condition-wait loop is encapsulated in the Queue class</span>
    <span class="ruby-comment"># (that in turn is oblivious to ConnectionPool implementation), threads</span>
    <span class="ruby-comment"># that are &quot;stuck&quot; there are helpless. They have no way of creating</span>
    <span class="ruby-comment"># new connections and are completely reliant on us feeding available</span>
    <span class="ruby-comment"># connections into the Queue.</span>
    <span class="ruby-identifier">needs_new_connection</span> = <span class="ruby-ivar">@available</span>.<span class="ruby-identifier">any_waiting?</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># This is intentionally done outside of the synchronized section as we</span>
  <span class="ruby-comment"># would like not to hold the main mutex while checking out new connections.</span>
  <span class="ruby-comment"># Thus there is some chance that needs_new_connection information is now</span>
  <span class="ruby-comment"># stale, we can live with that (bulk_make_new_connections will make</span>
  <span class="ruby-comment"># sure not to exceed the pool&#39;s @size limit).</span>
  <span class="ruby-identifier">bulk_make_new_connections</span>(<span class="ruby-value">1</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">needs_new_connection</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-remove_connection_from_thread_cache">
            
              <b>remove_connection_from_thread_cache</b>(conn, owner_thread = conn.owner)
            
            <a href="Reaper.html#method-i-remove_connection_from_thread_cache" name="method-i-remove_connection_from_thread_cache" class="permalink">Link</a>
          </div>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-remove_connection_from_thread_cache_source')" id="l_method-i-remove_connection_from_thread_cache_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L803" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-remove_connection_from_thread_cache_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 803</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">remove_connection_from_thread_cache</span>(<span class="ruby-identifier">conn</span>, <span class="ruby-identifier">owner_thread</span> = <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">owner</span>)
  <span class="ruby-ivar">@thread_cached_conns</span>.<span class="ruby-identifier">delete_pair</span>(<span class="ruby-identifier">connection_cache_key</span>(<span class="ruby-identifier">owner_thread</span>), <span class="ruby-identifier">conn</span>)
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-run">
            
              <b>run</b>()
            
            <a href="Reaper.html#method-i-run" name="method-i-run" class="permalink">Link</a>
          </div>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-run_source')" id="l_method-i-run_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L295" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-run_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 295</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">run</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">frequency</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">frequency</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
    <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">frequency</span>, <span class="ruby-identifier">pool</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span>, <span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">loop</span> <span class="ruby-keyword">do</span>
        <span class="ruby-identifier">sleep</span> <span class="ruby-identifier">t</span>
        <span class="ruby-identifier">p</span>.<span class="ruby-identifier">reap</span>
        <span class="ruby-identifier">p</span>.<span class="ruby-identifier">flush</span>
      <span class="ruby-keyword">end</span>
    }
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-stat">
            
              <b>stat</b>()
            
            <a href="Reaper.html#method-i-stat" name="method-i-stat" class="permalink">Link</a>
          </div>

          
            <div class="description">
              <p>Return connection pool&#39;s usage statistic Example:</p>

<pre><code>ActiveRecord::Base.connection_pool.stat # =&gt; { size: 15, connections: 1, busy: 1, dead: 0, idle: 0, waiting: 0, checkout_timeout: 5 }
</code></pre>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-stat_source')" id="l_method-i-stat_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L633" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-stat_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 633</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">stat</span>
  <span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>
    {
      <span class="ruby-value">size:</span> <span class="ruby-identifier">size</span>,
      <span class="ruby-value">connections:</span> <span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">size</span>,
      <span class="ruby-value">busy:</span> <span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">count</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">in_use?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">alive?</span> },
      <span class="ruby-value">dead:</span> <span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">count</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">in_use?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">c</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">alive?</span> },
      <span class="ruby-value">idle:</span> <span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">count</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-operator">!</span><span class="ruby-identifier">c</span>.<span class="ruby-identifier">in_use?</span> },
      <span class="ruby-value">waiting:</span> <span class="ruby-identifier">num_waiting_in_queue</span>,
      <span class="ruby-value">checkout_timeout:</span> <span class="ruby-identifier">checkout_timeout</span>
    }
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-try_to_checkout_new_connection">
            
              <b>try_to_checkout_new_connection</b>()
            
            <a href="Reaper.html#method-i-try_to_checkout_new_connection" name="method-i-try_to_checkout_new_connection" class="permalink">Link</a>
          </div>

          
            <div class="description">
              <p>If the pool is not at a <code>@size</code> limit, establish new connection.
Connecting to the DB is done outside main synchronized section.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-try_to_checkout_new_connection_source')" id="l_method-i-try_to_checkout_new_connection_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L819" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-try_to_checkout_new_connection_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 819</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">try_to_checkout_new_connection</span>
  <span class="ruby-comment"># first in synchronized section check if establishing new conns is allowed</span>
  <span class="ruby-comment"># and increment @now_connecting, to prevent overstepping this pool&#39;s @size</span>
  <span class="ruby-comment"># constraint</span>
  <span class="ruby-identifier">do_checkout</span> = <span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>
    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@threads_blocking_new_connections</span>.<span class="ruby-identifier">zero?</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@now_connecting</span>) <span class="ruby-operator">&lt;</span> <span class="ruby-ivar">@size</span>
      <span class="ruby-ivar">@now_connecting</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">do_checkout</span>
    <span class="ruby-keyword">begin</span>
      <span class="ruby-comment"># if successfully incremented @now_connecting establish new connection</span>
      <span class="ruby-comment"># outside of synchronized section</span>
      <span class="ruby-identifier">conn</span> = <span class="ruby-identifier">checkout_new_connection</span>
    <span class="ruby-keyword">ensure</span>
      <span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">conn</span>
          <span class="ruby-identifier">adopt_connection</span>(<span class="ruby-identifier">conn</span>)
          <span class="ruby-comment"># returned conn needs to be already leased</span>
          <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">lease</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-ivar">@now_connecting</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-with_connection">
            
              <b>with_connection</b>()
            
            <a href="Reaper.html#method-i-with_connection" name="method-i-with_connection" class="permalink">Link</a>
          </div>

          
            <div class="description">
              <p>If a connection obtained through <a
href="Reaper.html#method-i-connection">connection</a> or <a
href="Reaper.html#method-i-with_connection">with_connection</a> methods
already exists yield it to the block. If no such connection exists checkout
a connection, yield it to the block, and checkin the connection when
finished.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-with_connection_source')" id="l_method-i-with_connection_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L409" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-with_connection_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 409</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">with_connection</span>
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">conn</span> = <span class="ruby-ivar">@thread_cached_conns</span>[<span class="ruby-identifier">connection_cache_key</span>(<span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>)]
    <span class="ruby-identifier">conn</span> = <span class="ruby-identifier">connection</span>
    <span class="ruby-identifier">fresh_connection</span> = <span class="ruby-keyword">true</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">yield</span> <span class="ruby-identifier">conn</span>
<span class="ruby-keyword">ensure</span>
  <span class="ruby-identifier">release_connection</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">fresh_connection</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-with_exclusively_acquired_all_connections">
            
              <b>with_exclusively_acquired_all_connections</b>(raise_on_acquisition_timeout = true)
            
            <a href="Reaper.html#method-i-with_exclusively_acquired_all_connections" name="method-i-with_exclusively_acquired_all_connections" class="permalink">Link</a>
          </div>

          
            <div class="description">
              <p>Take control of all existing connections so a “group” action such as
reload/disconnect can be performed safely. It is no longer enough to wrap
it in <code>synchronize</code> because some pool&#39;s actions are allowed
to be performed outside of the main <code>synchronize</code> block.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-with_exclusively_acquired_all_connections_source')" id="l_method-i-with_exclusively_acquired_all_connections_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L673" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-with_exclusively_acquired_all_connections_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 673</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">with_exclusively_acquired_all_connections</span>(<span class="ruby-identifier">raise_on_acquisition_timeout</span> = <span class="ruby-keyword">true</span>)
  <span class="ruby-identifier">with_new_connections_blocked</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">attempt_to_checkout_all_existing_connections</span>(<span class="ruby-identifier">raise_on_acquisition_timeout</span>)
    <span class="ruby-keyword">yield</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-with_new_connections_blocked">
            
              <b>with_new_connections_blocked</b>()
            
            <a href="Reaper.html#method-i-with_new_connections_blocked" name="method-i-with_new_connections_blocked" class="permalink">Link</a>
          </div>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-with_new_connections_blocked_source')" id="l_method-i-with_new_connections_blocked_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L746" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-with_new_connections_blocked_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 746</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">with_new_connections_blocked</span>
  <span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>
    <span class="ruby-ivar">@threads_blocking_new_connections</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">yield</span>
<span class="ruby-keyword">ensure</span>
  <span class="ruby-identifier">num_new_conns_required</span> = <span class="ruby-value">0</span>

  <span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>
    <span class="ruby-ivar">@threads_blocking_new_connections</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>

    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@threads_blocking_new_connections</span>.<span class="ruby-identifier">zero?</span>
      <span class="ruby-ivar">@available</span>.<span class="ruby-identifier">clear</span>

      <span class="ruby-identifier">num_new_conns_required</span> = <span class="ruby-identifier">num_waiting_in_queue</span>

      <span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">in_use?</span>

        <span class="ruby-ivar">@available</span>.<span class="ruby-identifier">add</span> <span class="ruby-identifier">conn</span>
        <span class="ruby-identifier">num_new_conns_required</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">bulk_make_new_connections</span>(<span class="ruby-identifier">num_new_conns_required</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">num_new_conns_required</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
    
  
</div>

    </div>
  </body>
</html>
