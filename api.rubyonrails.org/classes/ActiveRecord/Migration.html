<!DOCTYPE html>
<html lang="en">
<head>
    <title>ActiveRecord::Migration</title>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="https://api.rubyonrails.org/css/reset.css" type="text/css" media="screen" />
<link rel="stylesheet" href="https://api.rubyonrails.org/css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="https://api.rubyonrails.org/css/github.css" type="text/css" media="screen" />
<script src="https://api.rubyonrails.org/js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://api.rubyonrails.org/js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="https://api.rubyonrails.org/js/highlight.pack.js" type="text/javascript" charset="utf-8"></script>


    <meta property="og:title" value="ActiveRecord::Migration">

  
    
    <meta name="description" content="Active Record Migrations  Migrations can manage the evolution of a schema used by several physical databases.">
    <meta property="og:description" content="Active Record Migrations  Migrations can manage the evolution of a schema used by several physical databases.">
  

    <meta name="keywords" content="ActiveRecord::Migration class">
  
    <meta name="keywords" content="[], current_version, check_pending!, load_schema_if_pending!, migrate, disable_ddl_transaction!, new, revert, reverting?, reversible, up_only, run, up, down, migrate, exec_migration, write, announce, say, say_with_time, suppress_messages, connection, method_missing, copy, proper_table_name, next_migration_number, execute_block">
  
</head>

<body>
    <div class="banner">
        
            <span>Ruby on Rails 5.2.1</span><br />
        
        <h1>
            <span class="type">Class</span>
            ActiveRecord::Migration
            
                <span class="parent">&lt;
                    
                    <a href="https://api.rubyonrails.org/classes/Object.html">Object</a>
                    
                </span>
            
        </h1>
        <ul class="files">
            
            <li><a href="../../files/activerecord/lib/active_record/migration_rb.html">activerecord/lib/active_record/migration.rb</a></li>
            
            <li><a href="../../files/activerecord/lib/active_record/migration/command_recorder_rb.html">activerecord/lib/active_record/migration/command_recorder.rb</a></li>
            
            <li><a href="../../files/activerecord/lib/active_record/migration/compatibility_rb.html">activerecord/lib/active_record/migration/compatibility.rb</a></li>
            
            <li><a href="../../files/activerecord/lib/active_record/migration/join_table_rb.html">activerecord/lib/active_record/migration/join_table.rb</a></li>
            
            <li><a href="../../files/activerecord/lib/active_record/railtie_rb.html">activerecord/lib/active_record/railtie.rb</a></li>
            
            <li><a href="../../files/activerecord/lib/active_record/tasks/database_tasks_rb.html">activerecord/lib/active_record/tasks/database_tasks.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
  
    <div class="description">
      
<h1 id="class-ActiveRecord::Migration-label-Active+Record+Migrations">Active Record Migrations</h1>

<p>Migrations can manage the evolution of a schema used by several physical
databases. It&#39;s a solution to the common problem of adding a field to
make a new feature work in your local database, but being unsure of how to
push that change to other developers and to the production server. With
migrations, you can describe the transformations in self-contained classes
that can be checked into version control systems and executed against
another database that might be one, two, or five versions behind.</p>

<p>Example of a simple migration:</p>

<pre><code>class AddSsl &lt; ActiveRecord::Migration[5.0]
  def up
    add_column :accounts, :ssl_enabled, :boolean, default: true
  end

  def down
    remove_column :accounts, :ssl_enabled
  end
end
</code></pre>

<p>This migration will add a boolean flag to the accounts table and remove it
if you&#39;re backing out of the migration. It shows how all migrations
have two methods <code>up</code> and <code>down</code> that describes the
transformations required to implement or remove the migration. These
methods can consist of both the migration specific methods like
<code>add_column</code> and <code>remove_column</code>, but may also
contain regular Ruby code for generating data needed for the
transformations.</p>

<p>Example of a more complex migration that also needs to initialize data:</p>

<pre><code>class AddSystemSettings &lt; ActiveRecord::Migration[5.0]
  def up
    create_table :system_settings do |t|
      t.string  :name
      t.string  :label
      t.text    :value
      t.string  :type
      t.integer :position
    end

    SystemSetting.create  name:  &#39;notice&#39;,
                          label: &#39;Use notice?&#39;,
                          value: 1
  end

  def down
    drop_table :system_settings
  end
end
</code></pre>

<p>This migration first adds the <code>system_settings</code> table, then
creates the very first row in it using the Active Record model that relies
on the table. It also uses the more advanced <code>create_table</code>
syntax where you can specify a complete table schema in one block call.</p>

<h2 id="class-ActiveRecord::Migration-label-Available+transformations">Available transformations</h2>

<h3 id="class-ActiveRecord::Migration-label-Creation">Creation</h3>
<ul><li>
<p><code>create_join_table(table_1, table_2, options)</code>: Creates a join
table having its name as the lexical order of the first two arguments. See
<a
href="ConnectionAdapters/SchemaStatements.html#method-i-create_join_table">ActiveRecord::ConnectionAdapters::SchemaStatements#create_join_table</a>
for details.</p>
</li><li>
<p><code>create_table(name, options)</code>: Creates a table called
<code>name</code> and makes the table object available to a block that can
then add columns to it, following the same format as
<code>add_column</code>. See example above. The options hash is for
fragments like “DEFAULT CHARSET=UTF-8” that are appended to the create
table definition.</p>
</li><li>
<p><code>add_column(table_name, column_name, type, options)</code>: Adds a new
column to the table called <code>table_name</code> named
<code>column_name</code> specified to be one of the following types:
<code>:string</code>, <code>:text</code>, <code>:integer</code>,
<code>:float</code>, <code>:decimal</code>, <code>:datetime</code>,
<code>:timestamp</code>, <code>:time</code>, <code>:date</code>,
<code>:binary</code>, <code>:boolean</code>. A default value can be
specified by passing an <code>options</code> hash like <code>{ default: 11
}</code>. Other options include <code>:limit</code> and <code>:null</code>
(e.g. <code>{ limit: 50, null: false }</code>) – see <a
href="ConnectionAdapters/TableDefinition.html#method-i-column">ActiveRecord::ConnectionAdapters::TableDefinition#column</a>
for details.</p>
</li><li>
<p><code>add_foreign_key(from_table, to_table, options)</code>: Adds a new
foreign key. <code>from_table</code> is the table with the key column,
<code>to_table</code> contains the referenced primary key.</p>
</li><li>
<p><code>add_index(table_name, column_names, options)</code>: Adds a new index
with the name of the column. Other options include <code>:name</code>,
<code>:unique</code> (e.g. <code>{ name: &#39;users_name_index&#39;,
unique: true }</code>) and <code>:order</code> (e.g. <code>{ order: { name:
:desc } }</code>).</p>
</li><li>
<p><code>add_reference(:table_name, :reference_name)</code>: Adds a new column
<code>reference_name_id</code> by default an integer. See <a
href="ConnectionAdapters/SchemaStatements.html#method-i-add_reference">ActiveRecord::ConnectionAdapters::SchemaStatements#add_reference</a>
for details.</p>
</li><li>
<p><code>add_timestamps(table_name, options)</code>: Adds timestamps
(<code>created_at</code> and <code>updated_at</code>) columns to
<code>table_name</code>.</p>
</li></ul>

<h3 id="class-ActiveRecord::Migration-label-Modification">Modification</h3>
<ul><li>
<p><code>change_column(table_name, column_name, type, options)</code>: 
Changes the column to a different type using the same parameters as
add_column.</p>
</li><li>
<p><code>change_column_default(table_name, column_name,
default_or_changes)</code>: Sets a default value for
<code>column_name</code> defined by <code>default_or_changes</code> on
<code>table_name</code>. Passing a hash containing <code>:from</code> and
<code>:to</code> as <code>default_or_changes</code> will make this change
reversible in the migration.</p>
</li><li>
<p><code>change_column_null(table_name, column_name, null, default =
nil)</code>: Sets or removes a +NOT NULL+ constraint on
<code>column_name</code>. The <code>null</code> flag indicates whether the
value can be <code>NULL</code>. See <a
href="ConnectionAdapters/SchemaStatements.html#method-i-change_column_null">ActiveRecord::ConnectionAdapters::SchemaStatements#change_column_null</a>
for details.</p>
</li><li>
<p><code>change_table(name, options)</code>: Allows to make column alterations
to the table called <code>name</code>. It makes the table object available
to a block that can then add/remove columns, indexes or foreign keys to it.</p>
</li><li>
<p><code>rename_column(table_name, column_name, new_column_name)</code>:
Renames a column but keeps the type and content.</p>
</li><li>
<p><code>rename_index(table_name, old_name, new_name)</code>: Renames an
index.</p>
</li><li>
<p><code>rename_table(old_name, new_name)</code>: Renames the table called
<code>old_name</code> to <code>new_name</code>.</p>
</li></ul>

<h3 id="class-ActiveRecord::Migration-label-Deletion">Deletion</h3>
<ul><li>
<p><code>drop_table(name)</code>: Drops the table called <code>name</code>.</p>
</li><li>
<p><code>drop_join_table(table_1, table_2, options)</code>: Drops the join
table specified by the given arguments.</p>
</li><li>
<p><code>remove_column(table_name, column_name, type, options)</code>: Removes
the column named <code>column_name</code> from the table called
<code>table_name</code>.</p>
</li><li>
<p><code>remove_columns(table_name, *column_names)</code>: Removes the given
columns from the table definition.</p>
</li><li>
<p><code>remove_foreign_key(from_table, options_or_to_table)</code>: Removes
the given foreign key from the table called <code>table_name</code>.</p>
</li><li>
<p><code>remove_index(table_name, column: column_names)</code>: Removes the
index specified by <code>column_names</code>.</p>
</li><li>
<p><code>remove_index(table_name, name: index_name)</code>: Removes the index
specified by <code>index_name</code>.</p>
</li><li>
<p><code>remove_reference(table_name, ref_name, options)</code>: Removes the
reference(s) on <code>table_name</code> specified by <code>ref_name</code>.</p>
</li><li>
<p><code>remove_timestamps(table_name, options)</code>: Removes the timestamp
columns (<code>created_at</code> and <code>updated_at</code>) from the
table definition.</p>
</li></ul>

<h2 id="class-ActiveRecord::Migration-label-Irreversible+transformations">Irreversible transformations</h2>

<p>Some transformations are destructive in a manner that cannot be reversed.
Migrations of that kind should raise an
<code>ActiveRecord::IrreversibleMigration</code> exception in their
<code>down</code> method.</p>

<h2 id="class-ActiveRecord::Migration-label-Running+migrations+from+within+Rails">Running migrations from within Rails</h2>

<p>The Rails package has several tools to help create and apply migrations.</p>

<p>To generate a new migration, you can use</p>

<pre><code>rails generate migration MyNewMigration
</code></pre>

<p>where MyNewMigration is the name of your migration. The generator will
create an empty migration file <code>timestamp_my_new_migration.rb</code>
in the <code>db/migrate/</code> directory where <code>timestamp</code> is
the UTC formatted date and time that the migration was generated.</p>

<p>There is a special syntactic shortcut to generate migrations that add
fields to a table.</p>

<pre><code>rails generate migration add_fieldname_to_tablename fieldname:string
</code></pre>

<p>This will generate the file
<code>timestamp_add_fieldname_to_tablename.rb</code>, which will look like
this:</p>

<pre><code>class AddFieldnameToTablename &lt; ActiveRecord::Migration[5.0]
  def change
    add_column :tablenames, :fieldname, :string
  end
end
</code></pre>

<p>To run migrations against the currently configured database, use
<code>rails db:migrate</code>. This will update the database by running all
of the pending migrations, creating the <code>schema_migrations</code>
table (see “About the schema_migrations table” section below) if missing.
It will also invoke the db:schema:dump task, which will update your
db/schema.rb file to match the structure of your database.</p>

<p>To roll the database back to a previous migration version, use <code>rails
db:rollback VERSION=X</code> where <code>X</code> is the version to which
you wish to downgrade. Alternatively, you can also use the STEP option if
you wish to rollback last few migrations. <code>rails db:rollback
STEP=2</code> will rollback the latest two migrations.</p>

<p>If any of the migrations throw an
<code>ActiveRecord::IrreversibleMigration</code> exception, that step will
fail and you&#39;ll have some manual work to do.</p>

<h2 id="class-ActiveRecord::Migration-label-Database+support">Database support</h2>

<p>Migrations are currently supported in MySQL, PostgreSQL, SQLite, SQL
Server, and Oracle (all supported databases except DB2).</p>

<h2 id="class-ActiveRecord::Migration-label-More+examples">More examples</h2>

<p>Not all migrations change the schema. Some just fix the data:</p>

<pre><code>class RemoveEmptyTags &lt; ActiveRecord::Migration[5.0]
  def up
    Tag.all.each { |tag| tag.destroy if tag.pages.empty? }
  end

  def down
    # not much we can do to restore deleted data
    raise ActiveRecord::IrreversibleMigration, &quot;Can&#39;t recover the deleted tags&quot;
  end
end
</code></pre>

<p>Others remove columns when they migrate up instead of down:</p>

<pre><code>class RemoveUnnecessaryItemAttributes &lt; ActiveRecord::Migration[5.0]
  def up
    remove_column :items, :incomplete_items_count
    remove_column :items, :completed_items_count
  end

  def down
    add_column :items, :incomplete_items_count
    add_column :items, :completed_items_count
  end
end
</code></pre>

<p>And sometimes you need to do something in SQL not abstracted directly by
migrations:</p>

<pre><code>class MakeJoinUnique &lt; ActiveRecord::Migration[5.0]
  def up
    execute &quot;ALTER TABLE `pages_linked_pages` ADD UNIQUE `page_id_linked_page_id` (`page_id`,`linked_page_id`)&quot;
  end

  def down
    execute &quot;ALTER TABLE `pages_linked_pages` DROP INDEX `page_id_linked_page_id`&quot;
  end
end
</code></pre>

<h2 id="class-ActiveRecord::Migration-label-Using+a+model+after+changing+its+table">Using a model after changing its table</h2>

<p>Sometimes you&#39;ll want to add a column in a migration and populate it
immediately after. In that case, you&#39;ll need to make a call to
<code>Base#reset_column_information</code> in order to ensure that the
model has the latest column data from after the new column was added.
Example:</p>

<pre><code>class AddPeopleSalary &lt; ActiveRecord::Migration[5.0]
  def up
    add_column :people, :salary, :integer
    Person.reset_column_information
    Person.all.each do |p|
      p.update_attribute :salary, SalaryCalculator.compute(p)
    end
  end
end
</code></pre>

<h2 id="class-ActiveRecord::Migration-label-Controlling+verbosity">Controlling verbosity</h2>

<p>By default, migrations will describe the actions they are taking, writing
them to the console as they happen, along with benchmarks describing how
long each step took.</p>

<p>You can quiet them down by setting ActiveRecord::Migration.verbose = false.</p>

<p>You can also insert your own messages and benchmarks by using the
<code>say_with_time</code> method:</p>

<pre><code>def up
  ...
  say_with_time &quot;Updating salaries...&quot; do
    Person.all.each do |p|
      p.update_attribute :salary, SalaryCalculator.compute(p)
    end
  end
  ...
end
</code></pre>

<p>The phrase “Updating salaries…” would then be printed, along with the
benchmark for the block when the block completes.</p>

<h2 id="class-ActiveRecord::Migration-label-Timestamped+Migrations">Timestamped Migrations</h2>

<p>By default, Rails generates migrations that look like:</p>

<pre><code>20080717013526_your_migration_name.rb
</code></pre>

<p>The prefix is a generation timestamp (in UTC).</p>

<p>If you&#39;d prefer to use numeric prefixes, you can turn timestamped
migrations off by setting:</p>

<pre><code>config.active_record.timestamped_migrations = false
</code></pre>

<p>In application.rb.</p>

<h2 id="class-ActiveRecord::Migration-label-Reversible+Migrations">Reversible Migrations</h2>

<p>Reversible migrations are migrations that know how to go <code>down</code>
for you. You simply supply the <code>up</code> logic, and the <a
href="Migration.html">Migration</a> system figures out how to execute the
down commands for you.</p>

<p>To define a reversible migration, define the <code>change</code> method in
your migration like this:</p>

<pre><code>class TenderloveMigration &lt; ActiveRecord::Migration[5.0]
  def change
    create_table(:horses) do |t|
      t.column :content, :text
      t.column :remind_at, :datetime
    end
  end
end
</code></pre>

<p>This migration will create the horses table for you on the way up, and
automatically figure out how to drop the table on the way down.</p>

<p>Some commands like <code>remove_column</code> cannot be reversed.  If you
care to define how to move up and down in these cases, you should define
the <code>up</code> and <code>down</code> methods as before.</p>

<p>If a command cannot be reversed, an
<code>ActiveRecord::IrreversibleMigration</code> exception will be raised
when the migration is moving down.</p>

<p>For a list of commands that are reversible, please see
<code>ActiveRecord::Migration::CommandRecorder</code>.</p>

<h2 id="class-ActiveRecord::Migration-label-Transactional+Migrations">Transactional Migrations</h2>

<p>If the database adapter supports DDL transactions, all migrations will
automatically be wrapped in a transaction. There are queries that you
can&#39;t execute inside a transaction though, and for these situations you
can turn the automatic transactions off.</p>

<pre><code>class ChangeEnum &lt; ActiveRecord::Migration[5.0]
  disable_ddl_transaction!

  def up
    execute &quot;ALTER TYPE model_size ADD VALUE &#39;new_value&#39;&quot;
  end
end
</code></pre>

<p>Remember that you can still open your own transactions, even if you are in
a <a href="Migration.html">Migration</a> with
<code>self.disable_ddl_transaction!</code>.</p>

    </div>
  


  


  
  


  
    <!-- Namespace -->
    <div class="sectiontitle">Namespace</div>
    <ul>
      
        <li>
          <span class="type">MODULE</span>
          <a href="Migration/Compatibility.html">ActiveRecord::Migration::Compatibility</a>
        </li>
      
        <li>
          <span class="type">CLASS</span>
          <a href="Migration/CheckPending.html">ActiveRecord::Migration::CheckPending</a>
        </li>
      
        <li>
          <span class="type">CLASS</span>
          <a href="Migration/CommandRecorder.html">ActiveRecord::Migration::CommandRecorder</a>
        </li>
      
    </ul>
  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>#</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="Migration.html#method-c-5B-5D">[]</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>A</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="Migration.html#method-i-announce">announce</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>C</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="Migration.html#method-c-check_pending-21">check_pending!</a>,
              </li>
            
              
              <li>
                <a href="Migration.html#method-i-connection">connection</a>,
              </li>
            
              
              <li>
                <a href="Migration.html#method-i-copy">copy</a>,
              </li>
            
              
              <li>
                <a href="Migration.html#method-c-current_version">current_version</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>D</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="Migration.html#method-c-disable_ddl_transaction-21">disable_ddl_transaction!</a>,
              </li>
            
              
              <li>
                <a href="Migration.html#method-i-down">down</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>E</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="Migration.html#method-i-exec_migration">exec_migration</a>,
              </li>
            
              
              <li>
                <a href="Migration.html#method-i-execute_block">execute_block</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>L</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="Migration.html#method-c-load_schema_if_pending-21">load_schema_if_pending!</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>M</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="Migration.html#method-i-method_missing">method_missing</a>,
              </li>
            
              
              <li>
                <a href="Migration.html#method-c-migrate">migrate</a>,
              </li>
            
              
              <li>
                <a href="Migration.html#method-i-migrate">migrate</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>N</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="Migration.html#method-c-new">new</a>,
              </li>
            
              
              <li>
                <a href="Migration.html#method-i-next_migration_number">next_migration_number</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>P</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="Migration.html#method-i-proper_table_name">proper_table_name</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>R</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="Migration.html#method-i-reversible">reversible</a>,
              </li>
            
              
              <li>
                <a href="Migration.html#method-i-revert">revert</a>,
              </li>
            
              
              <li>
                <a href="Migration.html#method-i-reverting-3F">reverting?</a>,
              </li>
            
              
              <li>
                <a href="Migration.html#method-i-run">run</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>S</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="Migration.html#method-i-say">say</a>,
              </li>
            
              
              <li>
                <a href="Migration.html#method-i-say_with_time">say_with_time</a>,
              </li>
            
              
              <li>
                <a href="Migration.html#method-i-suppress_messages">suppress_messages</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>U</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="Migration.html#method-i-up">up</a>,
              </li>
            
              
              <li>
                <a href="Migration.html#method-i-up_only">up_only</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>W</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="Migration.html#method-i-write">write</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  



  

    

    

    
      <!-- Section constants -->
      <div class="sectiontitle">Constants</div>
      <table border='0' cellpadding='5'>
        
          <tr valign='top'>
            <td class="attr-name">MigrationProxy</td>
            <td>=</td>
            <td class="attr-value">Struct.new(:name, :version, :filename, :scope) do
def initialize(name, version, filename, scope)
super
@migration = nil
end

def basename
File.basename(filename)
end

def mtime
File.mtime filename
end

delegate :migrate, :announce, :write, :disable_ddl_transaction, to: :migration

private

def migration
@migration ||= load_migration
end

def load_migration
require(File.expand_path(filename))
name.constantize.new(name, version)
end
end</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"><p><a href="Migration.html#MigrationProxy">MigrationProxy</a> is used to defer
loading of the actual migration classes until they are needed</p></td>
            </tr>
          
        
      </table>
    


    
      <!-- Section attributes -->
      <div class="sectiontitle">Attributes</div>
      <table border='0' cellpadding='5'>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>name</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>version</td>
            <td class='attr-desc'></td>
          </tr>
        
      </table>
    


    <!-- Methods -->
    
      <div class="sectiontitle">Class Public methods</div>
      
        <div class="method">
          <div class="title method-title" id="method-c-5B-5D">
            
              <b>[]</b>(version)
            
            <a href="Migration.html#method-c-5B-5D" name="method-c-5B-5D" class="permalink">Link</a>
          </div>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-c-5B-5D_source')" id="l_method-c-5B-5D_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/migration.rb#L535" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-c-5B-5D_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/migration.rb, line 535</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">[]</span>(<span class="ruby-identifier">version</span>)
  <span class="ruby-constant">Compatibility</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">version</span>)
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-c-check_pending-21">
            
              <b>check_pending!</b>(connection = Base.connection)
            
            <a href="Migration.html#method-c-check_pending-21" name="method-c-check_pending-21" class="permalink">Link</a>
          </div>

          
            <div class="description">
              <p>Raises <code>ActiveRecord::PendingMigrationError</code> error if any
migrations are pending.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-c-check_pending-21_source')" id="l_method-c-check_pending-21_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/migration.rb#L578" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-c-check_pending-21_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/migration.rb, line 578</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">check_pending!</span>(<span class="ruby-identifier">connection</span> = <span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">PendingMigrationError</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">migration_context</span>.<span class="ruby-identifier">needs_migration?</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-c-current_version">
            
              <b>current_version</b>()
            
            <a href="Migration.html#method-c-current_version" name="method-c-current_version" class="permalink">Link</a>
          </div>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-c-current_version_source')" id="l_method-c-current_version_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/migration.rb#L539" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-c-current_version_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/migration.rb, line 539</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">current_version</span>
  <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">VERSION</span><span class="ruby-operator">::</span><span class="ruby-constant">STRING</span>.<span class="ruby-identifier">to_f</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-c-disable_ddl_transaction-21">
            
              <b>disable_ddl_transaction!</b>()
            
            <a href="Migration.html#method-c-disable_ddl_transaction-21" name="method-c-disable_ddl_transaction-21" class="permalink">Link</a>
          </div>

          
            <div class="description">
              <p>Disable the transaction wrapping this migration. You can still create your
own transactions even after calling disable_ddl_transaction!</p>

<p>For more details read the <a href="Migration.html">“Transactional
Migrations” section above</a>.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-c-disable_ddl_transaction-21_source')" id="l_method-c-disable_ddl_transaction-21_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/migration.rb#L615" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-c-disable_ddl_transaction-21_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/migration.rb, line 615</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">disable_ddl_transaction!</span>
  <span class="ruby-ivar">@disable_ddl_transaction</span> = <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-c-load_schema_if_pending-21">
            
              <b>load_schema_if_pending!</b>()
            
            <a href="Migration.html#method-c-load_schema_if_pending-21" name="method-c-load_schema_if_pending-21" class="permalink">Link</a>
          </div>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-c-load_schema_if_pending-21_source')" id="l_method-c-load_schema_if_pending-21_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/migration.rb#L582" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-c-load_schema_if_pending-21_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/migration.rb, line 582</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">load_schema_if_pending!</span>
  <span class="ruby-keyword">if</span> <span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">migration_context</span>.<span class="ruby-identifier">needs_migration?</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">migration_context</span>.<span class="ruby-identifier">any_migrations?</span>
    <span class="ruby-comment"># Roundtrip to Rake to allow plugins to hook into database initialization.</span>
    <span class="ruby-identifier">root</span> = <span class="ruby-keyword">defined?</span>(<span class="ruby-constant">ENGINE_ROOT</span>) <span class="ruby-operator">?</span> <span class="ruby-constant">ENGINE_ROOT</span> <span class="ruby-operator">:</span> <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">root</span>
    <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">cd</span>(<span class="ruby-identifier">root</span>) <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">current_config</span> = <span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection_config</span>
      <span class="ruby-constant">Base</span>.<span class="ruby-identifier">clear_all_connections!</span>
      <span class="ruby-identifier">system</span>(<span class="ruby-string">&quot;bin/rails db:test:prepare&quot;</span>)
      <span class="ruby-comment"># Establish a new connection, the old database may be gone (db:test:prepare uses purge)</span>
      <span class="ruby-constant">Base</span>.<span class="ruby-identifier">establish_connection</span>(<span class="ruby-identifier">current_config</span>)
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">check_pending!</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-c-migrate">
            
              <b>migrate</b>(direction)
            
            <a href="Migration.html#method-c-migrate" name="method-c-migrate" class="permalink">Link</a>
          </div>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-c-migrate_source')" id="l_method-c-migrate_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/migration.rb#L607" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-c-migrate_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/migration.rb, line 607</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">migrate</span>(<span class="ruby-identifier">direction</span>)
  <span class="ruby-identifier">new</span>.<span class="ruby-identifier">migrate</span> <span class="ruby-identifier">direction</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-c-new">
            
              <b>new</b>(name = self.class.name, version = nil)
            
            <a href="Migration.html#method-c-new" name="method-c-new" class="permalink">Link</a>
          </div>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-c-new_source')" id="l_method-c-new_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/migration.rb#L627" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-c-new_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/migration.rb, line 627</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">initialize</span>(<span class="ruby-identifier">name</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">version</span> = <span class="ruby-keyword">nil</span>)
  <span class="ruby-ivar">@name</span>       = <span class="ruby-identifier">name</span>
  <span class="ruby-ivar">@version</span>    = <span class="ruby-identifier">version</span>
  <span class="ruby-ivar">@connection</span> = <span class="ruby-keyword">nil</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
    
      <div class="sectiontitle">Instance Public methods</div>
      
        <div class="method">
          <div class="title method-title" id="method-i-announce">
            
              <b>announce</b>(message)
            
            <a href="Migration.html#method-i-announce" name="method-i-announce" class="permalink">Link</a>
          </div>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-announce_source')" id="l_method-i-announce_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/migration.rb#L827" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-announce_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/migration.rb, line 827</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">announce</span>(<span class="ruby-identifier">message</span>)
  <span class="ruby-identifier">text</span> = <span class="ruby-node">&quot;#{version} #{name}: #{message}&quot;</span>
  <span class="ruby-identifier">length</span> = [<span class="ruby-value">0</span>, <span class="ruby-value">75</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">text</span>.<span class="ruby-identifier">length</span>].<span class="ruby-identifier">max</span>
  <span class="ruby-identifier">write</span> <span class="ruby-string">&quot;== %s %s&quot;</span> <span class="ruby-operator">%</span> [<span class="ruby-identifier">text</span>, <span class="ruby-string">&quot;=&quot;</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">length</span>]
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-connection">
            
              <b>connection</b>()
            
            <a href="Migration.html#method-i-connection" name="method-i-connection" class="permalink">Link</a>
          </div>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-connection_source')" id="l_method-i-connection_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/migration.rb#L853" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-connection_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/migration.rb, line 853</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">connection</span>
  <span class="ruby-ivar">@connection</span> <span class="ruby-operator">||</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-copy">
            
              <b>copy</b>(destination, sources, options = {})
            
            <a href="Migration.html#method-i-copy" name="method-i-copy" class="permalink">Link</a>
          </div>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-copy_source')" id="l_method-i-copy_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/migration.rb#L875" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-copy_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/migration.rb, line 875</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">copy</span>(<span class="ruby-identifier">destination</span>, <span class="ruby-identifier">sources</span>, <span class="ruby-identifier">options</span> = {})
  <span class="ruby-identifier">copied</span> = []

  <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span>(<span class="ruby-identifier">destination</span>) <span class="ruby-keyword">unless</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span>(<span class="ruby-identifier">destination</span>)

  <span class="ruby-identifier">destination_migrations</span> = <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">MigrationContext</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">destination</span>).<span class="ruby-identifier">migrations</span>
  <span class="ruby-identifier">last</span> = <span class="ruby-identifier">destination_migrations</span>.<span class="ruby-identifier">last</span>
  <span class="ruby-identifier">sources</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">scope</span>, <span class="ruby-identifier">path</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">source_migrations</span> = <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">MigrationContext</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">path</span>).<span class="ruby-identifier">migrations</span>

    <span class="ruby-identifier">source_migrations</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">migration</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">source</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">binread</span>(<span class="ruby-identifier">migration</span>.<span class="ruby-identifier">filename</span>)
      <span class="ruby-identifier">inserted_comment</span> = <span class="ruby-node">&quot;# This migration comes from #{scope} (originally #{migration.version})\n&quot;</span>
      <span class="ruby-identifier">magic_comments</span> = <span class="ruby-string">&quot;&quot;</span>.<span class="ruby-identifier">dup</span>
      <span class="ruby-identifier">loop</span> <span class="ruby-keyword">do</span>
        <span class="ruby-comment"># If we have a magic comment in the original migration,</span>
        <span class="ruby-comment"># insert our comment after the first newline(end of the magic comment line)</span>
        <span class="ruby-comment"># so the magic keep working.</span>
        <span class="ruby-comment"># Note that magic comments must be at the first line(except sh-bang).</span>
        <span class="ruby-identifier">source</span>.<span class="ruby-identifier">sub!</span>(<span class="ruby-regexp">/\A(?:#.*\b(?:en)?coding:\s*\S+|#\s*frozen_string_literal:\s*(?:true|false)).*\n/</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">magic_comment</span><span class="ruby-operator">|</span>
          <span class="ruby-identifier">magic_comments</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">magic_comment</span>; <span class="ruby-string">&quot;&quot;</span>
        <span class="ruby-keyword">end</span> <span class="ruby-operator">||</span> <span class="ruby-keyword">break</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">source</span> = <span class="ruby-node">&quot;#{magic_comments}#{inserted_comment}#{source}&quot;</span>

      <span class="ruby-keyword">if</span> <span class="ruby-identifier">duplicate</span> = <span class="ruby-identifier">destination_migrations</span>.<span class="ruby-identifier">detect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">migration</span>.<span class="ruby-identifier">name</span> }
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:on_skip</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">duplicate</span>.<span class="ruby-identifier">scope</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">to_s</span>
          <span class="ruby-identifier">options</span>[<span class="ruby-value">:on_skip</span>].<span class="ruby-identifier">call</span>(<span class="ruby-identifier">scope</span>, <span class="ruby-identifier">migration</span>)
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">next</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">migration</span>.<span class="ruby-identifier">version</span> = <span class="ruby-identifier">next_migration_number</span>(<span class="ruby-identifier">last</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">last</span>.<span class="ruby-identifier">version</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span> <span class="ruby-operator">:</span> <span class="ruby-value">0</span>).<span class="ruby-identifier">to_i</span>
      <span class="ruby-identifier">new_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">destination</span>, <span class="ruby-node">&quot;#{migration.version}_#{migration.name.underscore}.#{scope}.rb&quot;</span>)
      <span class="ruby-identifier">old_path</span>, <span class="ruby-identifier">migration</span>.<span class="ruby-identifier">filename</span> = <span class="ruby-identifier">migration</span>.<span class="ruby-identifier">filename</span>, <span class="ruby-identifier">new_path</span>
      <span class="ruby-identifier">last</span> = <span class="ruby-identifier">migration</span>

      <span class="ruby-constant">File</span>.<span class="ruby-identifier">binwrite</span>(<span class="ruby-identifier">migration</span>.<span class="ruby-identifier">filename</span>, <span class="ruby-identifier">source</span>)
      <span class="ruby-identifier">copied</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">migration</span>
      <span class="ruby-identifier">options</span>[<span class="ruby-value">:on_copy</span>].<span class="ruby-identifier">call</span>(<span class="ruby-identifier">scope</span>, <span class="ruby-identifier">migration</span>, <span class="ruby-identifier">old_path</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:on_copy</span>]
      <span class="ruby-identifier">destination_migrations</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">migration</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">copied</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-down">
            
              <b>down</b>()
            
            <a href="Migration.html#method-i-down" name="method-i-down" class="permalink">Link</a>
          </div>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-down_source')" id="l_method-i-down_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/migration.rb#L780" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-down_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/migration.rb, line 780</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">down</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">delegate</span> = <span class="ruby-keyword">self</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:down</span>)
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">down</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Execute this migration in the named direction</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">migrate</span>(<span class="ruby-identifier">direction</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">direction</span>)

    <span class="ruby-keyword">case</span> <span class="ruby-identifier">direction</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:up</span>   <span class="ruby-keyword">then</span> <span class="ruby-identifier">announce</span> <span class="ruby-string">&quot;migrating&quot;</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:down</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">announce</span> <span class="ruby-string">&quot;reverting&quot;</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">time</span> = <span class="ruby-keyword">nil</span>
    <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection_pool</span>.<span class="ruby-identifier">with_connection</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">time</span> = <span class="ruby-constant">Benchmark</span>.<span class="ruby-identifier">measure</span> <span class="ruby-keyword">do</span>
        <span class="ruby-identifier">exec_migration</span>(<span class="ruby-identifier">conn</span>, <span class="ruby-identifier">direction</span>)
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">case</span> <span class="ruby-identifier">direction</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:up</span>   <span class="ruby-keyword">then</span> <span class="ruby-identifier">announce</span> <span class="ruby-string">&quot;migrated (%.4fs)&quot;</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">time</span>.<span class="ruby-identifier">real</span>; <span class="ruby-identifier">write</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:down</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">announce</span> <span class="ruby-string">&quot;reverted (%.4fs)&quot;</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">time</span>.<span class="ruby-identifier">real</span>; <span class="ruby-identifier">write</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">exec_migration</span>(<span class="ruby-identifier">conn</span>, <span class="ruby-identifier">direction</span>)
    <span class="ruby-ivar">@connection</span> = <span class="ruby-identifier">conn</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:change</span>)
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">direction</span> <span class="ruby-operator">==</span> <span class="ruby-value">:down</span>
        <span class="ruby-identifier">revert</span> { <span class="ruby-identifier">change</span> }
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">change</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">send</span>(<span class="ruby-identifier">direction</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">ensure</span>
    <span class="ruby-ivar">@connection</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">write</span>(<span class="ruby-identifier">text</span> = <span class="ruby-string">&quot;&quot;</span>)
    <span class="ruby-identifier">puts</span>(<span class="ruby-identifier">text</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">verbose</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">announce</span>(<span class="ruby-identifier">message</span>)
    <span class="ruby-identifier">text</span> = <span class="ruby-node">&quot;#{version} #{name}: #{message}&quot;</span>
    <span class="ruby-identifier">length</span> = [<span class="ruby-value">0</span>, <span class="ruby-value">75</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">text</span>.<span class="ruby-identifier">length</span>].<span class="ruby-identifier">max</span>
    <span class="ruby-identifier">write</span> <span class="ruby-string">&quot;== %s %s&quot;</span> <span class="ruby-operator">%</span> [<span class="ruby-identifier">text</span>, <span class="ruby-string">&quot;=&quot;</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">length</span>]
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">say</span>(<span class="ruby-identifier">message</span>, <span class="ruby-identifier">subitem</span> = <span class="ruby-keyword">false</span>)
    <span class="ruby-identifier">write</span> <span class="ruby-node">&quot;#{subitem ? &quot;   -&gt;&quot; : &quot;--&quot;} #{message}&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">say_with_time</span>(<span class="ruby-identifier">message</span>)
    <span class="ruby-identifier">say</span>(<span class="ruby-identifier">message</span>)
    <span class="ruby-identifier">result</span> = <span class="ruby-keyword">nil</span>
    <span class="ruby-identifier">time</span> = <span class="ruby-constant">Benchmark</span>.<span class="ruby-identifier">measure</span> { <span class="ruby-identifier">result</span> = <span class="ruby-keyword">yield</span> }
    <span class="ruby-identifier">say</span> <span class="ruby-string">&quot;%.4fs&quot;</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">time</span>.<span class="ruby-identifier">real</span>, <span class="ruby-value">:subitem</span>
    <span class="ruby-identifier">say</span>(<span class="ruby-node">&quot;#{result} rows&quot;</span>, <span class="ruby-value">:subitem</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Integer</span>)
    <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">suppress_messages</span>
    <span class="ruby-identifier">save</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">verbose</span> = <span class="ruby-identifier">verbose</span>, <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">yield</span>
  <span class="ruby-keyword">ensure</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">verbose</span> = <span class="ruby-identifier">save</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">connection</span>
    <span class="ruby-ivar">@connection</span> <span class="ruby-operator">||</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">method_missing</span>(<span class="ruby-identifier">method</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">arguments</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
    <span class="ruby-identifier">arg_list</span> = <span class="ruby-identifier">arguments</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:inspect</span>) <span class="ruby-operator">*</span> <span class="ruby-string">&quot;, &quot;</span>

    <span class="ruby-identifier">say_with_time</span> <span class="ruby-node">&quot;#{method}(#{arg_list})&quot;</span> <span class="ruby-keyword">do</span>
      <span class="ruby-keyword">unless</span> <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">respond_to?</span> <span class="ruby-value">:revert</span>
        <span class="ruby-keyword">unless</span> <span class="ruby-identifier">arguments</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-operator">||</span> [<span class="ruby-value">:execute</span>, <span class="ruby-value">:enable_extension</span>, <span class="ruby-value">:disable_extension</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">method</span>)
          <span class="ruby-identifier">arguments</span>[<span class="ruby-value">0</span>] = <span class="ruby-identifier">proper_table_name</span>(<span class="ruby-identifier">arguments</span>.<span class="ruby-identifier">first</span>, <span class="ruby-identifier">table_name_options</span>)
          <span class="ruby-keyword">if</span> [<span class="ruby-value">:rename_table</span>, <span class="ruby-value">:add_foreign_key</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">method</span>) <span class="ruby-operator">||</span>
            (<span class="ruby-identifier">method</span> <span class="ruby-operator">==</span> <span class="ruby-value">:remove_foreign_key</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">arguments</span>.<span class="ruby-identifier">second</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Hash</span>))
            <span class="ruby-identifier">arguments</span>[<span class="ruby-value">1</span>] = <span class="ruby-identifier">proper_table_name</span>(<span class="ruby-identifier">arguments</span>.<span class="ruby-identifier">second</span>, <span class="ruby-identifier">table_name_options</span>)
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">return</span> <span class="ruby-keyword">super</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">method</span>)
      <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">method</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">arguments</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">copy</span>(<span class="ruby-identifier">destination</span>, <span class="ruby-identifier">sources</span>, <span class="ruby-identifier">options</span> = {})
    <span class="ruby-identifier">copied</span> = []

    <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span>(<span class="ruby-identifier">destination</span>) <span class="ruby-keyword">unless</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span>(<span class="ruby-identifier">destination</span>)

    <span class="ruby-identifier">destination_migrations</span> = <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">MigrationContext</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">destination</span>).<span class="ruby-identifier">migrations</span>
    <span class="ruby-identifier">last</span> = <span class="ruby-identifier">destination_migrations</span>.<span class="ruby-identifier">last</span>
    <span class="ruby-identifier">sources</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">scope</span>, <span class="ruby-identifier">path</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">source_migrations</span> = <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">MigrationContext</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">path</span>).<span class="ruby-identifier">migrations</span>

      <span class="ruby-identifier">source_migrations</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">migration</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">source</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">binread</span>(<span class="ruby-identifier">migration</span>.<span class="ruby-identifier">filename</span>)
        <span class="ruby-identifier">inserted_comment</span> = <span class="ruby-node">&quot;# This migration comes from #{scope} (originally #{migration.version})\n&quot;</span>
        <span class="ruby-identifier">magic_comments</span> = <span class="ruby-string">&quot;&quot;</span>.<span class="ruby-identifier">dup</span>
        <span class="ruby-identifier">loop</span> <span class="ruby-keyword">do</span>
          <span class="ruby-comment"># If we have a magic comment in the original migration,</span>
          <span class="ruby-comment"># insert our comment after the first newline(end of the magic comment line)</span>
          <span class="ruby-comment"># so the magic keep working.</span>
          <span class="ruby-comment"># Note that magic comments must be at the first line(except sh-bang).</span>
          <span class="ruby-identifier">source</span>.<span class="ruby-identifier">sub!</span>(<span class="ruby-regexp">/\A(?:#.*\b(?:en)?coding:\s*\S+|#\s*frozen_string_literal:\s*(?:true|false)).*\n/</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">magic_comment</span><span class="ruby-operator">|</span>
            <span class="ruby-identifier">magic_comments</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">magic_comment</span>; <span class="ruby-string">&quot;&quot;</span>
          <span class="ruby-keyword">end</span> <span class="ruby-operator">||</span> <span class="ruby-keyword">break</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">source</span> = <span class="ruby-node">&quot;#{magic_comments}#{inserted_comment}#{source}&quot;</span>

        <span class="ruby-keyword">if</span> <span class="ruby-identifier">duplicate</span> = <span class="ruby-identifier">destination_migrations</span>.<span class="ruby-identifier">detect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">migration</span>.<span class="ruby-identifier">name</span> }
          <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:on_skip</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">duplicate</span>.<span class="ruby-identifier">scope</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">to_s</span>
            <span class="ruby-identifier">options</span>[<span class="ruby-value">:on_skip</span>].<span class="ruby-identifier">call</span>(<span class="ruby-identifier">scope</span>, <span class="ruby-identifier">migration</span>)
          <span class="ruby-keyword">end</span>
          <span class="ruby-keyword">next</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-identifier">migration</span>.<span class="ruby-identifier">version</span> = <span class="ruby-identifier">next_migration_number</span>(<span class="ruby-identifier">last</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">last</span>.<span class="ruby-identifier">version</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span> <span class="ruby-operator">:</span> <span class="ruby-value">0</span>).<span class="ruby-identifier">to_i</span>
        <span class="ruby-identifier">new_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">destination</span>, <span class="ruby-node">&quot;#{migration.version}_#{migration.name.underscore}.#{scope}.rb&quot;</span>)
        <span class="ruby-identifier">old_path</span>, <span class="ruby-identifier">migration</span>.<span class="ruby-identifier">filename</span> = <span class="ruby-identifier">migration</span>.<span class="ruby-identifier">filename</span>, <span class="ruby-identifier">new_path</span>
        <span class="ruby-identifier">last</span> = <span class="ruby-identifier">migration</span>

        <span class="ruby-constant">File</span>.<span class="ruby-identifier">binwrite</span>(<span class="ruby-identifier">migration</span>.<span class="ruby-identifier">filename</span>, <span class="ruby-identifier">source</span>)
        <span class="ruby-identifier">copied</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">migration</span>
        <span class="ruby-identifier">options</span>[<span class="ruby-value">:on_copy</span>].<span class="ruby-identifier">call</span>(<span class="ruby-identifier">scope</span>, <span class="ruby-identifier">migration</span>, <span class="ruby-identifier">old_path</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:on_copy</span>]
        <span class="ruby-identifier">destination_migrations</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">migration</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">copied</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Finds the correct table name given an Active Record object.</span>
  <span class="ruby-comment"># Uses the Active Record object&#39;s own table_name, or pre/suffix from the</span>
  <span class="ruby-comment"># options passed in.</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">proper_table_name</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">options</span> = {})
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">name</span>.<span class="ruby-identifier">respond_to?</span> <span class="ruby-value">:table_name</span>
      <span class="ruby-identifier">name</span>.<span class="ruby-identifier">table_name</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-node">&quot;#{options[:table_name_prefix]}#{name}#{options[:table_name_suffix]}&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Determines the version number of the next migration.</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">next_migration_number</span>(<span class="ruby-identifier">number</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">timestamped_migrations</span>
      [<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%Y%m%d%H%M%S&quot;</span>), <span class="ruby-string">&quot;%.14d&quot;</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">number</span>].<span class="ruby-identifier">max</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-constant">SchemaMigration</span>.<span class="ruby-identifier">normalize_migration_number</span>(<span class="ruby-identifier">number</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Builds a hash for use in ActiveRecord::Migration#proper_table_name using</span>
  <span class="ruby-comment"># the Active Record object&#39;s table_name prefix and suffix</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">table_name_options</span>(<span class="ruby-identifier">config</span> = <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>) <span class="ruby-comment">#:nodoc:</span>
    {
      <span class="ruby-value">table_name_prefix:</span> <span class="ruby-identifier">config</span>.<span class="ruby-identifier">table_name_prefix</span>,
      <span class="ruby-value">table_name_suffix:</span> <span class="ruby-identifier">config</span>.<span class="ruby-identifier">table_name_suffix</span>
    }
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">private</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">execute_block</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">respond_to?</span> <span class="ruby-value">:execute_block</span>
        <span class="ruby-keyword">super</span> <span class="ruby-comment"># use normal delegation to record the block</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-keyword">yield</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>

<span class="ruby-comment"># MigrationProxy is used to defer loading of the actual migration classes</span>
<span class="ruby-comment"># until they are needed</span>
<span class="ruby-constant">MigrationProxy</span> = <span class="ruby-constant">Struct</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">:name</span>, <span class="ruby-value">:version</span>, <span class="ruby-value">:filename</span>, <span class="ruby-value">:scope</span>) <span class="ruby-keyword">do</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">initialize</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">version</span>, <span class="ruby-identifier">filename</span>, <span class="ruby-identifier">scope</span>)
    <span class="ruby-keyword">super</span>
    <span class="ruby-ivar">@migration</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">basename</span>
    <span class="ruby-constant">File</span>.<span class="ruby-identifier">basename</span>(<span class="ruby-identifier">filename</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mtime</span>
    <span class="ruby-constant">File</span>.<span class="ruby-identifier">mtime</span> <span class="ruby-identifier">filename</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">delegate</span> <span class="ruby-value">:migrate</span>, <span class="ruby-value">:announce</span>, <span class="ruby-value">:write</span>, <span class="ruby-value">:disable_ddl_transaction</span>, <span class="ruby-value">to:</span> <span class="ruby-value">:migration</span>

  <span class="ruby-identifier">private</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">migration</span>
      <span class="ruby-ivar">@migration</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">load_migration</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">load_migration</span>
      <span class="ruby-identifier">require</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-identifier">filename</span>))
      <span class="ruby-identifier">name</span>.<span class="ruby-identifier">constantize</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">version</span>)
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">NullMigration</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">MigrationProxy</span> <span class="ruby-comment">#:nodoc:</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">initialize</span>
    <span class="ruby-keyword">super</span>(<span class="ruby-keyword">nil</span>, <span class="ruby-value">0</span>, <span class="ruby-keyword">nil</span>, <span class="ruby-keyword">nil</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mtime</span>
    <span class="ruby-value">0</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">MigrationContext</span> <span class="ruby-comment"># :nodoc:</span>
  <span class="ruby-identifier">attr_reader</span> <span class="ruby-value">:migrations_paths</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">initialize</span>(<span class="ruby-identifier">migrations_paths</span>)
    <span class="ruby-ivar">@migrations_paths</span> = <span class="ruby-identifier">migrations_paths</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">migrate</span>(<span class="ruby-identifier">target_version</span> = <span class="ruby-keyword">nil</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
    <span class="ruby-keyword">case</span>
    <span class="ruby-keyword">when</span> <span class="ruby-identifier">target_version</span>.<span class="ruby-identifier">nil?</span>
      <span class="ruby-identifier">up</span>(<span class="ruby-identifier">target_version</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
    <span class="ruby-keyword">when</span> <span class="ruby-identifier">current_version</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">target_version</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
      []
    <span class="ruby-keyword">when</span> <span class="ruby-identifier">current_version</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">target_version</span>
      <span class="ruby-identifier">down</span>(<span class="ruby-identifier">target_version</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">up</span>(<span class="ruby-identifier">target_version</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">rollback</span>(<span class="ruby-identifier">steps</span> = <span class="ruby-value">1</span>)
    <span class="ruby-identifier">move</span>(<span class="ruby-value">:down</span>, <span class="ruby-identifier">steps</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">forward</span>(<span class="ruby-identifier">steps</span> = <span class="ruby-value">1</span>)
    <span class="ruby-identifier">move</span>(<span class="ruby-value">:up</span>, <span class="ruby-identifier">steps</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">up</span>(<span class="ruby-identifier">target_version</span> = <span class="ruby-keyword">nil</span>)
    <span class="ruby-identifier">selected_migrations</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">block_given?</span>
      <span class="ruby-identifier">migrations</span>.<span class="ruby-identifier">select</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-keyword">yield</span> <span class="ruby-identifier">m</span> }
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">migrations</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-constant">Migrator</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">:up</span>, <span class="ruby-identifier">selected_migrations</span>, <span class="ruby-identifier">target_version</span>).<span class="ruby-identifier">migrate</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">down</span>(<span class="ruby-identifier">target_version</span> = <span class="ruby-keyword">nil</span>)
    <span class="ruby-identifier">selected_migrations</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">block_given?</span>
      <span class="ruby-identifier">migrations</span>.<span class="ruby-identifier">select</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-keyword">yield</span> <span class="ruby-identifier">m</span> }
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">migrations</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-constant">Migrator</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">:down</span>, <span class="ruby-identifier">selected_migrations</span>, <span class="ruby-identifier">target_version</span>).<span class="ruby-identifier">migrate</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">run</span>(<span class="ruby-identifier">direction</span>, <span class="ruby-identifier">target_version</span>)
    <span class="ruby-constant">Migrator</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">direction</span>, <span class="ruby-identifier">migrations</span>, <span class="ruby-identifier">target_version</span>).<span class="ruby-identifier">run</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">open</span>
    <span class="ruby-constant">Migrator</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">:up</span>, <span class="ruby-identifier">migrations</span>, <span class="ruby-keyword">nil</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">get_all_versions</span>
    <span class="ruby-keyword">if</span> <span class="ruby-constant">SchemaMigration</span>.<span class="ruby-identifier">table_exists?</span>
      <span class="ruby-constant">SchemaMigration</span>.<span class="ruby-identifier">all_versions</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:to_i</span>)
    <span class="ruby-keyword">else</span>
      []
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">current_version</span>
    <span class="ruby-identifier">get_all_versions</span>.<span class="ruby-identifier">max</span> <span class="ruby-operator">||</span> <span class="ruby-value">0</span>
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">NoDatabaseError</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">needs_migration?</span>
    (<span class="ruby-identifier">migrations</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:version</span>) <span class="ruby-operator">-</span> <span class="ruby-identifier">get_all_versions</span>).<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">any_migrations?</span>
    <span class="ruby-identifier">migrations</span>.<span class="ruby-identifier">any?</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">last_migration</span> <span class="ruby-comment">#:nodoc:</span>
    <span class="ruby-identifier">migrations</span>.<span class="ruby-identifier">last</span> <span class="ruby-operator">||</span> <span class="ruby-constant">NullMigration</span>.<span class="ruby-identifier">new</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">parse_migration_filename</span>(<span class="ruby-identifier">filename</span>) <span class="ruby-comment"># :nodoc:</span>
    <span class="ruby-constant">File</span>.<span class="ruby-identifier">basename</span>(<span class="ruby-identifier">filename</span>).<span class="ruby-identifier">scan</span>(<span class="ruby-constant">Migration</span><span class="ruby-operator">::</span><span class="ruby-constant">MigrationFilenameRegexp</span>).<span class="ruby-identifier">first</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">migrations</span>
    <span class="ruby-identifier">migrations</span> = <span class="ruby-identifier">migration_files</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">file</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">version</span>, <span class="ruby-identifier">name</span>, <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">parse_migration_filename</span>(<span class="ruby-identifier">file</span>)
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">IllegalMigrationNameError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">file</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">version</span>
      <span class="ruby-identifier">version</span> = <span class="ruby-identifier">version</span>.<span class="ruby-identifier">to_i</span>
      <span class="ruby-identifier">name</span> = <span class="ruby-identifier">name</span>.<span class="ruby-identifier">camelize</span>

      <span class="ruby-constant">MigrationProxy</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">version</span>, <span class="ruby-identifier">file</span>, <span class="ruby-identifier">scope</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">migrations</span>.<span class="ruby-identifier">sort_by</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:version</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">migrations_status</span>
    <span class="ruby-identifier">db_list</span> = <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">SchemaMigration</span>.<span class="ruby-identifier">normalized_versions</span>

    <span class="ruby-identifier">file_list</span> = <span class="ruby-identifier">migration_files</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">file</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">version</span>, <span class="ruby-identifier">name</span>, <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">parse_migration_filename</span>(<span class="ruby-identifier">file</span>)
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">IllegalMigrationNameError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">file</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">version</span>
      <span class="ruby-identifier">version</span> = <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">SchemaMigration</span>.<span class="ruby-identifier">normalize_migration_number</span>(<span class="ruby-identifier">version</span>)
      <span class="ruby-identifier">status</span> = <span class="ruby-identifier">db_list</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">version</span>) <span class="ruby-operator">?</span> <span class="ruby-string">&quot;up&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-string">&quot;down&quot;</span>
      [<span class="ruby-identifier">status</span>, <span class="ruby-identifier">version</span>, (<span class="ruby-identifier">name</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">scope</span>).<span class="ruby-identifier">humanize</span>]
    <span class="ruby-keyword">end</span>.<span class="ruby-identifier">compact</span>

    <span class="ruby-identifier">db_list</span>.<span class="ruby-identifier">map!</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">version</span><span class="ruby-operator">|</span>
      [<span class="ruby-string">&quot;up&quot;</span>, <span class="ruby-identifier">version</span>, <span class="ruby-string">&quot;********** NO FILE **********&quot;</span>]
    <span class="ruby-keyword">end</span>

    (<span class="ruby-identifier">db_list</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">file_list</span>).<span class="ruby-identifier">sort_by</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">_</span>, <span class="ruby-identifier">version</span>, <span class="ruby-identifier">_</span><span class="ruby-operator">|</span> <span class="ruby-identifier">version</span> }
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">migration_files</span>
    <span class="ruby-identifier">paths</span> = <span class="ruby-constant">Array</span>(<span class="ruby-identifier">migrations_paths</span>)
    <span class="ruby-constant">Dir</span>[<span class="ruby-operator">*</span><span class="ruby-identifier">paths</span>.<span class="ruby-identifier">flat_map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">path</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;#{path}/**/[0-9]*_*.rb&quot;</span> }]
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">current_environment</span>
    <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">ConnectionHandling</span><span class="ruby-operator">::</span><span class="ruby-constant">DEFAULT_ENV</span>.<span class="ruby-identifier">call</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">protected_environment?</span>
    <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">protected_environments</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">last_stored_environment</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">last_stored_environment</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">last_stored_environment</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_version</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">NoEnvironmentInSchemaError</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">InternalMetadata</span>.<span class="ruby-identifier">table_exists?</span>

    <span class="ruby-identifier">environment</span> = <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">InternalMetadata</span>[<span class="ruby-value">:environment</span>]
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">NoEnvironmentInSchemaError</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">environment</span>
    <span class="ruby-identifier">environment</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">private</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">move</span>(<span class="ruby-identifier">direction</span>, <span class="ruby-identifier">steps</span>)
      <span class="ruby-identifier">migrator</span> = <span class="ruby-constant">Migrator</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">direction</span>, <span class="ruby-identifier">migrations</span>)

      <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_version</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">migrator</span>.<span class="ruby-identifier">current_migration</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">UnknownMigrationVersionError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">current_version</span>)
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">start_index</span> =
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_version</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
          <span class="ruby-value">0</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">migrator</span>.<span class="ruby-identifier">migrations</span>.<span class="ruby-identifier">index</span>(<span class="ruby-identifier">migrator</span>.<span class="ruby-identifier">current_migration</span>)
        <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">finish</span> = <span class="ruby-identifier">migrator</span>.<span class="ruby-identifier">migrations</span>[<span class="ruby-identifier">start_index</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">steps</span>]
      <span class="ruby-identifier">version</span> = <span class="ruby-identifier">finish</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">finish</span>.<span class="ruby-identifier">version</span> <span class="ruby-operator">:</span> <span class="ruby-value">0</span>
      <span class="ruby-identifier">send</span>(<span class="ruby-identifier">direction</span>, <span class="ruby-identifier">version</span>)
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Migrator</span> <span class="ruby-comment"># :nodoc:</span>
  <span class="ruby-keyword">class</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-keyword">self</span>
    <span class="ruby-identifier">attr_accessor</span> <span class="ruby-value">:migrations_paths</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">migrations_path=</span>(<span class="ruby-identifier">path</span>)
      <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">Deprecation</span>.<span class="ruby-identifier">warn</span> \
        <span class="ruby-string">&quot;ActiveRecord::Migrator.migrations_paths= is now deprecated and will be removed in Rails 6.0.&quot;</span> \
        <span class="ruby-string">&quot;You can set the `migrations_paths` on the `connection` instead through the `database.yml`.&quot;</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">migrations_paths</span> = [<span class="ruby-identifier">path</span>]
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># For cases where a table doesn&#39;t exist like loading from schema cache</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">current_version</span>
      <span class="ruby-constant">MigrationContext</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">migrations_paths</span>).<span class="ruby-identifier">current_version</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">migrations_paths</span> = [<span class="ruby-string">&quot;db/migrate&quot;</span>]

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">initialize</span>(<span class="ruby-identifier">direction</span>, <span class="ruby-identifier">migrations</span>, <span class="ruby-identifier">target_version</span> = <span class="ruby-keyword">nil</span>)
    <span class="ruby-ivar">@direction</span>         = <span class="ruby-identifier">direction</span>
    <span class="ruby-ivar">@target_version</span>    = <span class="ruby-identifier">target_version</span>
    <span class="ruby-ivar">@migrated_versions</span> = <span class="ruby-keyword">nil</span>
    <span class="ruby-ivar">@migrations</span>        = <span class="ruby-identifier">migrations</span>

    <span class="ruby-identifier">validate</span>(<span class="ruby-ivar">@migrations</span>)

    <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">SchemaMigration</span>.<span class="ruby-identifier">create_table</span>
    <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">InternalMetadata</span>.<span class="ruby-identifier">create_table</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">current_version</span>
    <span class="ruby-identifier">migrated</span>.<span class="ruby-identifier">max</span> <span class="ruby-operator">||</span> <span class="ruby-value">0</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">current_migration</span>
    <span class="ruby-identifier">migrations</span>.<span class="ruby-identifier">detect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">version</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">current_version</span> }
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">alias</span> <span class="ruby-value">:current</span> <span class="ruby-value">:current_migration</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">run</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">use_advisory_lock?</span>
      <span class="ruby-identifier">with_advisory_lock</span> { <span class="ruby-identifier">run_without_lock</span> }
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">run_without_lock</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">migrate</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">use_advisory_lock?</span>
      <span class="ruby-identifier">with_advisory_lock</span> { <span class="ruby-identifier">migrate_without_lock</span> }
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">migrate_without_lock</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">runnable</span>
    <span class="ruby-identifier">runnable</span> = <span class="ruby-identifier">migrations</span>[<span class="ruby-identifier">start</span><span class="ruby-operator">..</span><span class="ruby-identifier">finish</span>]
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">up?</span>
      <span class="ruby-identifier">runnable</span>.<span class="ruby-identifier">reject</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ran?</span>(<span class="ruby-identifier">m</span>) }
    <span class="ruby-keyword">else</span>
      <span class="ruby-comment"># skip the last migration if we&#39;re headed down, but not ALL the way down</span>
      <span class="ruby-identifier">runnable</span>.<span class="ruby-identifier">pop</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">target</span>
      <span class="ruby-identifier">runnable</span>.<span class="ruby-identifier">find_all</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ran?</span>(<span class="ruby-identifier">m</span>) }
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">migrations</span>
    <span class="ruby-identifier">down?</span> <span class="ruby-operator">?</span> <span class="ruby-ivar">@migrations</span>.<span class="ruby-identifier">reverse</span> <span class="ruby-operator">:</span> <span class="ruby-ivar">@migrations</span>.<span class="ruby-identifier">sort_by</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:version</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">pending_migrations</span>
    <span class="ruby-identifier">already_migrated</span> = <span class="ruby-identifier">migrated</span>
    <span class="ruby-identifier">migrations</span>.<span class="ruby-identifier">reject</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">already_migrated</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">m</span>.<span class="ruby-identifier">version</span>) }
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">migrated</span>
    <span class="ruby-ivar">@migrated_versions</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">load_migrated</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">load_migrated</span>
    <span class="ruby-ivar">@migrated_versions</span> = <span class="ruby-constant">Set</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">migration_context</span>.<span class="ruby-identifier">get_all_versions</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">private</span>

    <span class="ruby-comment"># Used for running a specific migration.</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">run_without_lock</span>
      <span class="ruby-identifier">migration</span> = <span class="ruby-identifier">migrations</span>.<span class="ruby-identifier">detect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">version</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@target_version</span> }
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">UnknownMigrationVersionError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@target_version</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">migration</span>.<span class="ruby-identifier">nil?</span>
      <span class="ruby-identifier">result</span> = <span class="ruby-identifier">execute_migration_in_transaction</span>(<span class="ruby-identifier">migration</span>, <span class="ruby-ivar">@direction</span>)

      <span class="ruby-identifier">record_environment</span>
      <span class="ruby-identifier">result</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Used for running multiple migrations up to or down to a certain value.</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">migrate_without_lock</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">invalid_target?</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">UnknownMigrationVersionError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@target_version</span>)
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">result</span> = <span class="ruby-identifier">runnable</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">migration</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">execute_migration_in_transaction</span>(<span class="ruby-identifier">migration</span>, <span class="ruby-ivar">@direction</span>)
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">record_environment</span>
      <span class="ruby-identifier">result</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Stores the current environment in the database.</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">record_environment</span>
      <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">down?</span>
      <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">InternalMetadata</span>[<span class="ruby-value">:environment</span>] = <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">migration_context</span>.<span class="ruby-identifier">current_environment</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">ran?</span>(<span class="ruby-identifier">migration</span>)
      <span class="ruby-identifier">migrated</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">migration</span>.<span class="ruby-identifier">version</span>.<span class="ruby-identifier">to_i</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Return true if a valid version is not provided.</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">invalid_target?</span>
      <span class="ruby-ivar">@target_version</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@target_version</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">target</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">execute_migration_in_transaction</span>(<span class="ruby-identifier">migration</span>, <span class="ruby-identifier">direction</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">down?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">migrated</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">migration</span>.<span class="ruby-identifier">version</span>.<span class="ruby-identifier">to_i</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">up?</span>   <span class="ruby-operator">&amp;&amp;</span>  <span class="ruby-identifier">migrated</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">migration</span>.<span class="ruby-identifier">version</span>.<span class="ruby-identifier">to_i</span>)

      <span class="ruby-constant">Base</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;Migrating to #{migration.name} (#{migration.version})&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">Base</span>.<span class="ruby-identifier">logger</span>

      <span class="ruby-identifier">ddl_transaction</span>(<span class="ruby-identifier">migration</span>) <span class="ruby-keyword">do</span>
        <span class="ruby-identifier">migration</span>.<span class="ruby-identifier">migrate</span>(<span class="ruby-identifier">direction</span>)
        <span class="ruby-identifier">record_version_state_after_migrating</span>(<span class="ruby-identifier">migration</span>.<span class="ruby-identifier">version</span>)
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">rescue</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
      <span class="ruby-identifier">msg</span> = <span class="ruby-string">&quot;An error has occurred, &quot;</span>.<span class="ruby-identifier">dup</span>
      <span class="ruby-identifier">msg</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;this and &quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">use_transaction?</span>(<span class="ruby-identifier">migration</span>)
      <span class="ruby-identifier">msg</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;all later migrations canceled:\n\n#{e}&quot;</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">StandardError</span>, <span class="ruby-identifier">msg</span>, <span class="ruby-identifier">e</span>.<span class="ruby-identifier">backtrace</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">target</span>
      <span class="ruby-identifier">migrations</span>.<span class="ruby-identifier">detect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">version</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@target_version</span> }
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">finish</span>
      <span class="ruby-identifier">migrations</span>.<span class="ruby-identifier">index</span>(<span class="ruby-identifier">target</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">migrations</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">start</span>
      <span class="ruby-identifier">up?</span> <span class="ruby-operator">?</span> <span class="ruby-value">0</span> <span class="ruby-operator">:</span> (<span class="ruby-identifier">migrations</span>.<span class="ruby-identifier">index</span>(<span class="ruby-identifier">current</span>) <span class="ruby-operator">||</span> <span class="ruby-value">0</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">validate</span>(<span class="ruby-identifier">migrations</span>)
      <span class="ruby-identifier">name</span>, = <span class="ruby-identifier">migrations</span>.<span class="ruby-identifier">group_by</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:name</span>).<span class="ruby-identifier">find</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">_</span>, <span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">v</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> }
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">DuplicateMigrationNameError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">name</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">name</span>

      <span class="ruby-identifier">version</span>, = <span class="ruby-identifier">migrations</span>.<span class="ruby-identifier">group_by</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:version</span>).<span class="ruby-identifier">find</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">_</span>, <span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">v</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> }
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">DuplicateMigrationVersionError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">version</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">version</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">record_version_state_after_migrating</span>(<span class="ruby-identifier">version</span>)
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">down?</span>
        <span class="ruby-identifier">migrated</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">version</span>)
        <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">SchemaMigration</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">version:</span> <span class="ruby-identifier">version</span>.<span class="ruby-identifier">to_s</span>).<span class="ruby-identifier">delete_all</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">migrated</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">version</span>
        <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">SchemaMigration</span>.<span class="ruby-identifier">create!</span>(<span class="ruby-value">version:</span> <span class="ruby-identifier">version</span>.<span class="ruby-identifier">to_s</span>)
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">up?</span>
      <span class="ruby-ivar">@direction</span> <span class="ruby-operator">==</span> <span class="ruby-value">:up</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">down?</span>
      <span class="ruby-ivar">@direction</span> <span class="ruby-operator">==</span> <span class="ruby-value">:down</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Wrap the migration in a transaction only if supported by the adapter.</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">ddl_transaction</span>(<span class="ruby-identifier">migration</span>)
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">use_transaction?</span>(<span class="ruby-identifier">migration</span>)
        <span class="ruby-constant">Base</span>.<span class="ruby-identifier">transaction</span> { <span class="ruby-keyword">yield</span> }
      <span class="ruby-keyword">else</span>
        <span class="ruby-keyword">yield</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">use_transaction?</span>(<span class="ruby-identifier">migration</span>)
      <span class="ruby-operator">!</span><span class="ruby-identifier">migration</span>.<span class="ruby-identifier">disable_ddl_transaction</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">supports_ddl_transactions?</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">use_advisory_lock?</span>
      <span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">supports_advisory_locks?</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">with_advisory_lock</span>
      <span class="ruby-identifier">lock_id</span> = <span class="ruby-identifier">generate_migrator_advisory_lock_id</span>
      <span class="ruby-identifier">connection</span> = <span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection</span>
      <span class="ruby-identifier">got_lock</span> = <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">get_advisory_lock</span>(<span class="ruby-identifier">lock_id</span>)
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">ConcurrentMigrationError</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">got_lock</span>
      <span class="ruby-identifier">load_migrated</span> <span class="ruby-comment"># reload schema_migrations to be sure it wasn&#39;t changed by another process before we got the lock</span>
      <span class="ruby-keyword">yield</span>
    <span class="ruby-keyword">ensure</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">got_lock</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">connection</span>.<span class="ruby-identifier">release_advisory_lock</span>(<span class="ruby-identifier">lock_id</span>)
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ConcurrentMigrationError</span>.<span class="ruby-identifier">new</span>(
          <span class="ruby-constant">ConcurrentMigrationError</span><span class="ruby-operator">::</span><span class="ruby-constant">RELEASE_LOCK_FAILED_MESSAGE</span>
        )
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-constant">MIGRATOR_SALT</span> = <span class="ruby-value">2053462845</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">generate_migrator_advisory_lock_id</span>
      <span class="ruby-identifier">db_name_hash</span> = <span class="ruby-constant">Zlib</span>.<span class="ruby-identifier">crc32</span>(<span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">current_database</span>)
      <span class="ruby-constant">MIGRATOR_SALT</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">db_name_hash</span>
    </pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-exec_migration">
            
              <b>exec_migration</b>(conn, direction)
            
            <a href="Migration.html#method-i-exec_migration" name="method-i-exec_migration" class="permalink">Link</a>
          </div>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-exec_migration_source')" id="l_method-i-exec_migration_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/migration.rb#L808" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-exec_migration_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/migration.rb, line 808</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">exec_migration</span>(<span class="ruby-identifier">conn</span>, <span class="ruby-identifier">direction</span>)
  <span class="ruby-ivar">@connection</span> = <span class="ruby-identifier">conn</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:change</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">direction</span> <span class="ruby-operator">==</span> <span class="ruby-value">:down</span>
      <span class="ruby-identifier">revert</span> { <span class="ruby-identifier">change</span> }
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">change</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">send</span>(<span class="ruby-identifier">direction</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">ensure</span>
  <span class="ruby-ivar">@connection</span> = <span class="ruby-keyword">nil</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-execute_block">
            
              <b>execute_block</b>()
            
            <a href="Migration.html#method-i-execute_block" name="method-i-execute_block" class="permalink">Link</a>
          </div>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-execute_block_source')" id="l_method-i-execute_block_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/migration.rb#L952" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-execute_block_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/migration.rb, line 952</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">execute_block</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">respond_to?</span> <span class="ruby-value">:execute_block</span>
    <span class="ruby-keyword">super</span> <span class="ruby-comment"># use normal delegation to record the block</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">yield</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-method_missing">
            
              <b>method_missing</b>(method, *arguments, &amp;block)
            
            <a href="Migration.html#method-i-method_missing" name="method-i-method_missing" class="permalink">Link</a>
          </div>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-method_missing_source')" id="l_method-i-method_missing_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/migration.rb#L857" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-method_missing_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/migration.rb, line 857</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">method_missing</span>(<span class="ruby-identifier">method</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">arguments</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
  <span class="ruby-identifier">arg_list</span> = <span class="ruby-identifier">arguments</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:inspect</span>) <span class="ruby-operator">*</span> <span class="ruby-string">&quot;, &quot;</span>

  <span class="ruby-identifier">say_with_time</span> <span class="ruby-node">&quot;#{method}(#{arg_list})&quot;</span> <span class="ruby-keyword">do</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">respond_to?</span> <span class="ruby-value">:revert</span>
      <span class="ruby-keyword">unless</span> <span class="ruby-identifier">arguments</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-operator">||</span> [<span class="ruby-value">:execute</span>, <span class="ruby-value">:enable_extension</span>, <span class="ruby-value">:disable_extension</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">method</span>)
        <span class="ruby-identifier">arguments</span>[<span class="ruby-value">0</span>] = <span class="ruby-identifier">proper_table_name</span>(<span class="ruby-identifier">arguments</span>.<span class="ruby-identifier">first</span>, <span class="ruby-identifier">table_name_options</span>)
        <span class="ruby-keyword">if</span> [<span class="ruby-value">:rename_table</span>, <span class="ruby-value">:add_foreign_key</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">method</span>) <span class="ruby-operator">||</span>
          (<span class="ruby-identifier">method</span> <span class="ruby-operator">==</span> <span class="ruby-value">:remove_foreign_key</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">arguments</span>.<span class="ruby-identifier">second</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Hash</span>))
          <span class="ruby-identifier">arguments</span>[<span class="ruby-value">1</span>] = <span class="ruby-identifier">proper_table_name</span>(<span class="ruby-identifier">arguments</span>.<span class="ruby-identifier">second</span>, <span class="ruby-identifier">table_name_options</span>)
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">super</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">method</span>)
    <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">method</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">arguments</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-migrate">
            
              <b>migrate</b>(direction)
            
            <a href="Migration.html#method-i-migrate" name="method-i-migrate" class="permalink">Link</a>
          </div>

          
            <div class="description">
              <p>Execute this migration in the named direction</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-migrate_source')" id="l_method-i-migrate_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/migration.rb#L787" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-migrate_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/migration.rb, line 787</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">migrate</span>(<span class="ruby-identifier">direction</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">direction</span>)

    <span class="ruby-keyword">case</span> <span class="ruby-identifier">direction</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:up</span>   <span class="ruby-keyword">then</span> <span class="ruby-identifier">announce</span> <span class="ruby-string">&quot;migrating&quot;</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:down</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">announce</span> <span class="ruby-string">&quot;reverting&quot;</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">time</span> = <span class="ruby-keyword">nil</span>
    <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection_pool</span>.<span class="ruby-identifier">with_connection</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">time</span> = <span class="ruby-constant">Benchmark</span>.<span class="ruby-identifier">measure</span> <span class="ruby-keyword">do</span>
        <span class="ruby-identifier">exec_migration</span>(<span class="ruby-identifier">conn</span>, <span class="ruby-identifier">direction</span>)
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">case</span> <span class="ruby-identifier">direction</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:up</span>   <span class="ruby-keyword">then</span> <span class="ruby-identifier">announce</span> <span class="ruby-string">&quot;migrated (%.4fs)&quot;</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">time</span>.<span class="ruby-identifier">real</span>; <span class="ruby-identifier">write</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:down</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">announce</span> <span class="ruby-string">&quot;reverted (%.4fs)&quot;</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">time</span>.<span class="ruby-identifier">real</span>; <span class="ruby-identifier">write</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">exec_migration</span>(<span class="ruby-identifier">conn</span>, <span class="ruby-identifier">direction</span>)
    <span class="ruby-ivar">@connection</span> = <span class="ruby-identifier">conn</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:change</span>)
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">direction</span> <span class="ruby-operator">==</span> <span class="ruby-value">:down</span>
        <span class="ruby-identifier">revert</span> { <span class="ruby-identifier">change</span> }
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">change</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">send</span>(<span class="ruby-identifier">direction</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">ensure</span>
    <span class="ruby-ivar">@connection</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">write</span>(<span class="ruby-identifier">text</span> = <span class="ruby-string">&quot;&quot;</span>)
    <span class="ruby-identifier">puts</span>(<span class="ruby-identifier">text</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">verbose</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">announce</span>(<span class="ruby-identifier">message</span>)
    <span class="ruby-identifier">text</span> = <span class="ruby-node">&quot;#{version} #{name}: #{message}&quot;</span>
    <span class="ruby-identifier">length</span> = [<span class="ruby-value">0</span>, <span class="ruby-value">75</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">text</span>.<span class="ruby-identifier">length</span>].<span class="ruby-identifier">max</span>
    <span class="ruby-identifier">write</span> <span class="ruby-string">&quot;== %s %s&quot;</span> <span class="ruby-operator">%</span> [<span class="ruby-identifier">text</span>, <span class="ruby-string">&quot;=&quot;</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">length</span>]
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">say</span>(<span class="ruby-identifier">message</span>, <span class="ruby-identifier">subitem</span> = <span class="ruby-keyword">false</span>)
    <span class="ruby-identifier">write</span> <span class="ruby-node">&quot;#{subitem ? &quot;   -&gt;&quot; : &quot;--&quot;} #{message}&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">say_with_time</span>(<span class="ruby-identifier">message</span>)
    <span class="ruby-identifier">say</span>(<span class="ruby-identifier">message</span>)
    <span class="ruby-identifier">result</span> = <span class="ruby-keyword">nil</span>
    <span class="ruby-identifier">time</span> = <span class="ruby-constant">Benchmark</span>.<span class="ruby-identifier">measure</span> { <span class="ruby-identifier">result</span> = <span class="ruby-keyword">yield</span> }
    <span class="ruby-identifier">say</span> <span class="ruby-string">&quot;%.4fs&quot;</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">time</span>.<span class="ruby-identifier">real</span>, <span class="ruby-value">:subitem</span>
    <span class="ruby-identifier">say</span>(<span class="ruby-node">&quot;#{result} rows&quot;</span>, <span class="ruby-value">:subitem</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Integer</span>)
    <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">suppress_messages</span>
    <span class="ruby-identifier">save</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">verbose</span> = <span class="ruby-identifier">verbose</span>, <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">yield</span>
  <span class="ruby-keyword">ensure</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">verbose</span> = <span class="ruby-identifier">save</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">connection</span>
    <span class="ruby-ivar">@connection</span> <span class="ruby-operator">||</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">method_missing</span>(<span class="ruby-identifier">method</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">arguments</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
    <span class="ruby-identifier">arg_list</span> = <span class="ruby-identifier">arguments</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:inspect</span>) <span class="ruby-operator">*</span> <span class="ruby-string">&quot;, &quot;</span>

    <span class="ruby-identifier">say_with_time</span> <span class="ruby-node">&quot;#{method}(#{arg_list})&quot;</span> <span class="ruby-keyword">do</span>
      <span class="ruby-keyword">unless</span> <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">respond_to?</span> <span class="ruby-value">:revert</span>
        <span class="ruby-keyword">unless</span> <span class="ruby-identifier">arguments</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-operator">||</span> [<span class="ruby-value">:execute</span>, <span class="ruby-value">:enable_extension</span>, <span class="ruby-value">:disable_extension</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">method</span>)
          <span class="ruby-identifier">arguments</span>[<span class="ruby-value">0</span>] = <span class="ruby-identifier">proper_table_name</span>(<span class="ruby-identifier">arguments</span>.<span class="ruby-identifier">first</span>, <span class="ruby-identifier">table_name_options</span>)
          <span class="ruby-keyword">if</span> [<span class="ruby-value">:rename_table</span>, <span class="ruby-value">:add_foreign_key</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">method</span>) <span class="ruby-operator">||</span>
            (<span class="ruby-identifier">method</span> <span class="ruby-operator">==</span> <span class="ruby-value">:remove_foreign_key</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">arguments</span>.<span class="ruby-identifier">second</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Hash</span>))
            <span class="ruby-identifier">arguments</span>[<span class="ruby-value">1</span>] = <span class="ruby-identifier">proper_table_name</span>(<span class="ruby-identifier">arguments</span>.<span class="ruby-identifier">second</span>, <span class="ruby-identifier">table_name_options</span>)
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">return</span> <span class="ruby-keyword">super</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">method</span>)
      <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">method</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">arguments</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">copy</span>(<span class="ruby-identifier">destination</span>, <span class="ruby-identifier">sources</span>, <span class="ruby-identifier">options</span> = {})
    <span class="ruby-identifier">copied</span> = []

    <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span>(<span class="ruby-identifier">destination</span>) <span class="ruby-keyword">unless</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span>(<span class="ruby-identifier">destination</span>)

    <span class="ruby-identifier">destination_migrations</span> = <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">MigrationContext</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">destination</span>).<span class="ruby-identifier">migrations</span>
    <span class="ruby-identifier">last</span> = <span class="ruby-identifier">destination_migrations</span>.<span class="ruby-identifier">last</span>
    <span class="ruby-identifier">sources</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">scope</span>, <span class="ruby-identifier">path</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">source_migrations</span> = <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">MigrationContext</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">path</span>).<span class="ruby-identifier">migrations</span>

      <span class="ruby-identifier">source_migrations</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">migration</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">source</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">binread</span>(<span class="ruby-identifier">migration</span>.<span class="ruby-identifier">filename</span>)
        <span class="ruby-identifier">inserted_comment</span> = <span class="ruby-node">&quot;# This migration comes from #{scope} (originally #{migration.version})\n&quot;</span>
        <span class="ruby-identifier">magic_comments</span> = <span class="ruby-string">&quot;&quot;</span>.<span class="ruby-identifier">dup</span>
        <span class="ruby-identifier">loop</span> <span class="ruby-keyword">do</span>
          <span class="ruby-comment"># If we have a magic comment in the original migration,</span>
          <span class="ruby-comment"># insert our comment after the first newline(end of the magic comment line)</span>
          <span class="ruby-comment"># so the magic keep working.</span>
          <span class="ruby-comment"># Note that magic comments must be at the first line(except sh-bang).</span>
          <span class="ruby-identifier">source</span>.<span class="ruby-identifier">sub!</span>(<span class="ruby-regexp">/\A(?:#.*\b(?:en)?coding:\s*\S+|#\s*frozen_string_literal:\s*(?:true|false)).*\n/</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">magic_comment</span><span class="ruby-operator">|</span>
            <span class="ruby-identifier">magic_comments</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">magic_comment</span>; <span class="ruby-string">&quot;&quot;</span>
          <span class="ruby-keyword">end</span> <span class="ruby-operator">||</span> <span class="ruby-keyword">break</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">source</span> = <span class="ruby-node">&quot;#{magic_comments}#{inserted_comment}#{source}&quot;</span>

        <span class="ruby-keyword">if</span> <span class="ruby-identifier">duplicate</span> = <span class="ruby-identifier">destination_migrations</span>.<span class="ruby-identifier">detect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">migration</span>.<span class="ruby-identifier">name</span> }
          <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:on_skip</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">duplicate</span>.<span class="ruby-identifier">scope</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">to_s</span>
            <span class="ruby-identifier">options</span>[<span class="ruby-value">:on_skip</span>].<span class="ruby-identifier">call</span>(<span class="ruby-identifier">scope</span>, <span class="ruby-identifier">migration</span>)
          <span class="ruby-keyword">end</span>
          <span class="ruby-keyword">next</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-identifier">migration</span>.<span class="ruby-identifier">version</span> = <span class="ruby-identifier">next_migration_number</span>(<span class="ruby-identifier">last</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">last</span>.<span class="ruby-identifier">version</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span> <span class="ruby-operator">:</span> <span class="ruby-value">0</span>).<span class="ruby-identifier">to_i</span>
        <span class="ruby-identifier">new_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">destination</span>, <span class="ruby-node">&quot;#{migration.version}_#{migration.name.underscore}.#{scope}.rb&quot;</span>)
        <span class="ruby-identifier">old_path</span>, <span class="ruby-identifier">migration</span>.<span class="ruby-identifier">filename</span> = <span class="ruby-identifier">migration</span>.<span class="ruby-identifier">filename</span>, <span class="ruby-identifier">new_path</span>
        <span class="ruby-identifier">last</span> = <span class="ruby-identifier">migration</span>

        <span class="ruby-constant">File</span>.<span class="ruby-identifier">binwrite</span>(<span class="ruby-identifier">migration</span>.<span class="ruby-identifier">filename</span>, <span class="ruby-identifier">source</span>)
        <span class="ruby-identifier">copied</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">migration</span>
        <span class="ruby-identifier">options</span>[<span class="ruby-value">:on_copy</span>].<span class="ruby-identifier">call</span>(<span class="ruby-identifier">scope</span>, <span class="ruby-identifier">migration</span>, <span class="ruby-identifier">old_path</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:on_copy</span>]
        <span class="ruby-identifier">destination_migrations</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">migration</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">copied</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Finds the correct table name given an Active Record object.</span>
  <span class="ruby-comment"># Uses the Active Record object&#39;s own table_name, or pre/suffix from the</span>
  <span class="ruby-comment"># options passed in.</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">proper_table_name</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">options</span> = {})
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">name</span>.<span class="ruby-identifier">respond_to?</span> <span class="ruby-value">:table_name</span>
      <span class="ruby-identifier">name</span>.<span class="ruby-identifier">table_name</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-node">&quot;#{options[:table_name_prefix]}#{name}#{options[:table_name_suffix]}&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Determines the version number of the next migration.</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">next_migration_number</span>(<span class="ruby-identifier">number</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">timestamped_migrations</span>
      [<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%Y%m%d%H%M%S&quot;</span>), <span class="ruby-string">&quot;%.14d&quot;</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">number</span>].<span class="ruby-identifier">max</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-constant">SchemaMigration</span>.<span class="ruby-identifier">normalize_migration_number</span>(<span class="ruby-identifier">number</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Builds a hash for use in ActiveRecord::Migration#proper_table_name using</span>
  <span class="ruby-comment"># the Active Record object&#39;s table_name prefix and suffix</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">table_name_options</span>(<span class="ruby-identifier">config</span> = <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>) <span class="ruby-comment">#:nodoc:</span>
    {
      <span class="ruby-value">table_name_prefix:</span> <span class="ruby-identifier">config</span>.<span class="ruby-identifier">table_name_prefix</span>,
      <span class="ruby-value">table_name_suffix:</span> <span class="ruby-identifier">config</span>.<span class="ruby-identifier">table_name_suffix</span>
    }
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">private</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">execute_block</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">respond_to?</span> <span class="ruby-value">:execute_block</span>
        <span class="ruby-keyword">super</span> <span class="ruby-comment"># use normal delegation to record the block</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-keyword">yield</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-next_migration_number">
            
              <b>next_migration_number</b>(number)
            
            <a href="Migration.html#method-i-next_migration_number" name="method-i-next_migration_number" class="permalink">Link</a>
          </div>

          
            <div class="description">
              <p>Determines the version number of the next migration.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-next_migration_number_source')" id="l_method-i-next_migration_number_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/migration.rb#L934" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-next_migration_number_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/migration.rb, line 934</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">next_migration_number</span>(<span class="ruby-identifier">number</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">timestamped_migrations</span>
    [<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%Y%m%d%H%M%S&quot;</span>), <span class="ruby-string">&quot;%.14d&quot;</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">number</span>].<span class="ruby-identifier">max</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-constant">SchemaMigration</span>.<span class="ruby-identifier">normalize_migration_number</span>(<span class="ruby-identifier">number</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-proper_table_name">
            
              <b>proper_table_name</b>(name, options = {})
            
            <a href="Migration.html#method-i-proper_table_name" name="method-i-proper_table_name" class="permalink">Link</a>
          </div>

          
            <div class="description">
              <p>Finds the correct table name given an Active Record object. Uses the Active
Record object&#39;s own table_name, or pre/suffix from the options passed
in.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-proper_table_name_source')" id="l_method-i-proper_table_name_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/migration.rb#L925" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-proper_table_name_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/migration.rb, line 925</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">proper_table_name</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">options</span> = {})
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">name</span>.<span class="ruby-identifier">respond_to?</span> <span class="ruby-value">:table_name</span>
    <span class="ruby-identifier">name</span>.<span class="ruby-identifier">table_name</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-node">&quot;#{options[:table_name_prefix]}#{name}#{options[:table_name_suffix]}&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-reversible">
            
              <b>reversible</b>()
            
            <a href="Migration.html#method-i-reversible" name="method-i-reversible" class="permalink">Link</a>
          </div>

          
            <div class="description">
              <p>Used to specify an operation that can be run in one direction or another.
Call the methods <code>up</code> and <code>down</code> of the yielded
object to run a block only in one given direction. The whole block will be
called in the right order within the migration.</p>

<p>In the following example, the looping on users will always be done when the
three columns &#39;first_name&#39;, &#39;last_name&#39; and
&#39;full_name&#39; exist, even when migrating down:</p>

<pre><code>class SplitNameMigration &lt; ActiveRecord::Migration[5.0]
  def change
    add_column :users, :first_name, :string
    add_column :users, :last_name, :string

    reversible do |dir|
      User.reset_column_information
      User.all.each do |u|
        dir.up   { u.first_name, u.last_name = u.full_name.split(&#39; &#39;) }
        dir.down { u.full_name = &quot;#{u.first_name} #{u.last_name}&quot; }
        u.save
      end
    end

    revert { add_column :users, :full_name, :string }
  end
end
</code></pre>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-reversible_source')" id="l_method-i-reversible_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/migration.rb#L733" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-reversible_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/migration.rb, line 733</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">reversible</span>
  <span class="ruby-identifier">helper</span> = <span class="ruby-constant">ReversibleBlockHelper</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">reverting?</span>)
  <span class="ruby-identifier">execute_block</span> { <span class="ruby-keyword">yield</span> <span class="ruby-identifier">helper</span> }
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-revert">
            
              <b>revert</b>(*migration_classes)
            
            <a href="Migration.html#method-i-revert" name="method-i-revert" class="permalink">Link</a>
          </div>

          
            <div class="description">
              <p>Reverses the migration commands for the given block and the given
migrations.</p>

<p>The following migration will remove the table &#39;horses&#39; and create
the table &#39;apples&#39; on the way up, and the reverse on the way down.</p>

<pre><code>class FixTLMigration &lt; ActiveRecord::Migration[5.0]
  def change
    revert do
      create_table(:horses) do |t|
        t.text :content
        t.datetime :remind_at
      end
    end
    create_table(:apples) do |t|
      t.string :variety
    end
  end
end
</code></pre>

<p>Or equivalently, if <code>TenderloveMigration</code> is defined as in the
documentation for Migration:</p>

<pre><code>require_relative &#39;20121212123456_tenderlove_migration&#39;

class FixupTLMigration &lt; ActiveRecord::Migration[5.0]
  def change
    revert TenderloveMigration

    create_table(:apples) do |t|
      t.string :variety
    end
  end
end
</code></pre>

<p>This command can be nested.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-revert_source')" id="l_method-i-revert_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/migration.rb#L674" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-revert_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/migration.rb, line 674</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">revert</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">migration_classes</span>)
  <span class="ruby-identifier">run</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">migration_classes</span>.<span class="ruby-identifier">reverse</span>, <span class="ruby-value">revert:</span> <span class="ruby-keyword">true</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">migration_classes</span>.<span class="ruby-identifier">empty?</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">block_given?</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">respond_to?</span> <span class="ruby-value">:revert</span>
      <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">revert</span> { <span class="ruby-keyword">yield</span> }
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">recorder</span> = <span class="ruby-constant">CommandRecorder</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">connection</span>)
      <span class="ruby-ivar">@connection</span> = <span class="ruby-identifier">recorder</span>
      <span class="ruby-identifier">suppress_messages</span> <span class="ruby-keyword">do</span>
        <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">revert</span> { <span class="ruby-keyword">yield</span> }
      <span class="ruby-keyword">end</span>
      <span class="ruby-ivar">@connection</span> = <span class="ruby-identifier">recorder</span>.<span class="ruby-identifier">delegate</span>
      <span class="ruby-identifier">recorder</span>.<span class="ruby-identifier">commands</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">cmd</span>, <span class="ruby-identifier">args</span>, <span class="ruby-identifier">block</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">send</span>(<span class="ruby-identifier">cmd</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-reverting-3F">
            
              <b>reverting?</b>()
            
            <a href="Migration.html#method-i-reverting-3F" name="method-i-reverting-3F" class="permalink">Link</a>
          </div>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-reverting-3F_source')" id="l_method-i-reverting-3F_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/migration.rb#L693" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-reverting-3F_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/migration.rb, line 693</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">reverting?</span>
  <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:reverting</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">reverting</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-run">
            
              <b>run</b>(*migration_classes)
            
            <a href="Migration.html#method-i-run" name="method-i-run" class="permalink">Link</a>
          </div>

          
            <div class="description">
              <p>Runs the given migration classes. Last argument can specify options:</p>
<ul><li>
<p>:direction (default is :up)</p>
</li><li>
<p>:revert (default is false)</p>
</li></ul>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-run_source')" id="l_method-i-run_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/migration.rb#L760" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-run_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/migration.rb, line 760</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">run</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">migration_classes</span>)
  <span class="ruby-identifier">opts</span> = <span class="ruby-identifier">migration_classes</span>.<span class="ruby-identifier">extract_options!</span>
  <span class="ruby-identifier">dir</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-value">:direction</span>] <span class="ruby-operator">||</span> <span class="ruby-value">:up</span>
  <span class="ruby-identifier">dir</span> = (<span class="ruby-identifier">dir</span> <span class="ruby-operator">==</span> <span class="ruby-value">:down</span> <span class="ruby-operator">?</span> <span class="ruby-value">:up</span> <span class="ruby-operator">:</span> <span class="ruby-value">:down</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">opts</span>[<span class="ruby-value">:revert</span>]
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">reverting?</span>
    <span class="ruby-comment"># If in revert and going :up, say, we want to execute :down without reverting, so</span>
    <span class="ruby-identifier">revert</span> { <span class="ruby-identifier">run</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">migration_classes</span>, <span class="ruby-value">direction:</span> <span class="ruby-identifier">dir</span>, <span class="ruby-value">revert:</span> <span class="ruby-keyword">true</span>) }
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">migration_classes</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">migration_class</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">migration_class</span>.<span class="ruby-identifier">new</span>.<span class="ruby-identifier">exec_migration</span>(<span class="ruby-identifier">connection</span>, <span class="ruby-identifier">dir</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-say">
            
              <b>say</b>(message, subitem = false)
            
            <a href="Migration.html#method-i-say" name="method-i-say" class="permalink">Link</a>
          </div>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-say_source')" id="l_method-i-say_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/migration.rb#L833" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-say_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/migration.rb, line 833</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">say</span>(<span class="ruby-identifier">message</span>, <span class="ruby-identifier">subitem</span> = <span class="ruby-keyword">false</span>)
  <span class="ruby-identifier">write</span> <span class="ruby-node">&quot;#{subitem ? &quot;   -&gt;&quot; : &quot;--&quot;} #{message}&quot;</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-say_with_time">
            
              <b>say_with_time</b>(message)
            
            <a href="Migration.html#method-i-say_with_time" name="method-i-say_with_time" class="permalink">Link</a>
          </div>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-say_with_time_source')" id="l_method-i-say_with_time_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/migration.rb#L837" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-say_with_time_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/migration.rb, line 837</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">say_with_time</span>(<span class="ruby-identifier">message</span>)
  <span class="ruby-identifier">say</span>(<span class="ruby-identifier">message</span>)
  <span class="ruby-identifier">result</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-identifier">time</span> = <span class="ruby-constant">Benchmark</span>.<span class="ruby-identifier">measure</span> { <span class="ruby-identifier">result</span> = <span class="ruby-keyword">yield</span> }
  <span class="ruby-identifier">say</span> <span class="ruby-string">&quot;%.4fs&quot;</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">time</span>.<span class="ruby-identifier">real</span>, <span class="ruby-value">:subitem</span>
  <span class="ruby-identifier">say</span>(<span class="ruby-node">&quot;#{result} rows&quot;</span>, <span class="ruby-value">:subitem</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Integer</span>)
  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-suppress_messages">
            
              <b>suppress_messages</b>()
            
            <a href="Migration.html#method-i-suppress_messages" name="method-i-suppress_messages" class="permalink">Link</a>
          </div>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-suppress_messages_source')" id="l_method-i-suppress_messages_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/migration.rb#L846" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-suppress_messages_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/migration.rb, line 846</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">suppress_messages</span>
  <span class="ruby-identifier">save</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">verbose</span> = <span class="ruby-identifier">verbose</span>, <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">yield</span>
<span class="ruby-keyword">ensure</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">verbose</span> = <span class="ruby-identifier">save</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-up">
            
              <b>up</b>()
            
            <a href="Migration.html#method-i-up" name="method-i-up" class="permalink">Link</a>
          </div>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-up_source')" id="l_method-i-up_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/migration.rb#L774" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-up_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/migration.rb, line 774</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">up</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">delegate</span> = <span class="ruby-keyword">self</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:up</span>)
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">up</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">down</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">delegate</span> = <span class="ruby-keyword">self</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:down</span>)
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">down</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Execute this migration in the named direction</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">migrate</span>(<span class="ruby-identifier">direction</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">direction</span>)

    <span class="ruby-keyword">case</span> <span class="ruby-identifier">direction</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:up</span>   <span class="ruby-keyword">then</span> <span class="ruby-identifier">announce</span> <span class="ruby-string">&quot;migrating&quot;</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:down</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">announce</span> <span class="ruby-string">&quot;reverting&quot;</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">time</span> = <span class="ruby-keyword">nil</span>
    <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection_pool</span>.<span class="ruby-identifier">with_connection</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">time</span> = <span class="ruby-constant">Benchmark</span>.<span class="ruby-identifier">measure</span> <span class="ruby-keyword">do</span>
        <span class="ruby-identifier">exec_migration</span>(<span class="ruby-identifier">conn</span>, <span class="ruby-identifier">direction</span>)
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">case</span> <span class="ruby-identifier">direction</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:up</span>   <span class="ruby-keyword">then</span> <span class="ruby-identifier">announce</span> <span class="ruby-string">&quot;migrated (%.4fs)&quot;</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">time</span>.<span class="ruby-identifier">real</span>; <span class="ruby-identifier">write</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:down</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">announce</span> <span class="ruby-string">&quot;reverted (%.4fs)&quot;</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">time</span>.<span class="ruby-identifier">real</span>; <span class="ruby-identifier">write</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">exec_migration</span>(<span class="ruby-identifier">conn</span>, <span class="ruby-identifier">direction</span>)
    <span class="ruby-ivar">@connection</span> = <span class="ruby-identifier">conn</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:change</span>)
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">direction</span> <span class="ruby-operator">==</span> <span class="ruby-value">:down</span>
        <span class="ruby-identifier">revert</span> { <span class="ruby-identifier">change</span> }
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">change</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">send</span>(<span class="ruby-identifier">direction</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">ensure</span>
    <span class="ruby-ivar">@connection</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">write</span>(<span class="ruby-identifier">text</span> = <span class="ruby-string">&quot;&quot;</span>)
    <span class="ruby-identifier">puts</span>(<span class="ruby-identifier">text</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">verbose</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">announce</span>(<span class="ruby-identifier">message</span>)
    <span class="ruby-identifier">text</span> = <span class="ruby-node">&quot;#{version} #{name}: #{message}&quot;</span>
    <span class="ruby-identifier">length</span> = [<span class="ruby-value">0</span>, <span class="ruby-value">75</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">text</span>.<span class="ruby-identifier">length</span>].<span class="ruby-identifier">max</span>
    <span class="ruby-identifier">write</span> <span class="ruby-string">&quot;== %s %s&quot;</span> <span class="ruby-operator">%</span> [<span class="ruby-identifier">text</span>, <span class="ruby-string">&quot;=&quot;</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">length</span>]
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">say</span>(<span class="ruby-identifier">message</span>, <span class="ruby-identifier">subitem</span> = <span class="ruby-keyword">false</span>)
    <span class="ruby-identifier">write</span> <span class="ruby-node">&quot;#{subitem ? &quot;   -&gt;&quot; : &quot;--&quot;} #{message}&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">say_with_time</span>(<span class="ruby-identifier">message</span>)
    <span class="ruby-identifier">say</span>(<span class="ruby-identifier">message</span>)
    <span class="ruby-identifier">result</span> = <span class="ruby-keyword">nil</span>
    <span class="ruby-identifier">time</span> = <span class="ruby-constant">Benchmark</span>.<span class="ruby-identifier">measure</span> { <span class="ruby-identifier">result</span> = <span class="ruby-keyword">yield</span> }
    <span class="ruby-identifier">say</span> <span class="ruby-string">&quot;%.4fs&quot;</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">time</span>.<span class="ruby-identifier">real</span>, <span class="ruby-value">:subitem</span>
    <span class="ruby-identifier">say</span>(<span class="ruby-node">&quot;#{result} rows&quot;</span>, <span class="ruby-value">:subitem</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Integer</span>)
    <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">suppress_messages</span>
    <span class="ruby-identifier">save</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">verbose</span> = <span class="ruby-identifier">verbose</span>, <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">yield</span>
  <span class="ruby-keyword">ensure</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">verbose</span> = <span class="ruby-identifier">save</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">connection</span>
    <span class="ruby-ivar">@connection</span> <span class="ruby-operator">||</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">method_missing</span>(<span class="ruby-identifier">method</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">arguments</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
    <span class="ruby-identifier">arg_list</span> = <span class="ruby-identifier">arguments</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:inspect</span>) <span class="ruby-operator">*</span> <span class="ruby-string">&quot;, &quot;</span>

    <span class="ruby-identifier">say_with_time</span> <span class="ruby-node">&quot;#{method}(#{arg_list})&quot;</span> <span class="ruby-keyword">do</span>
      <span class="ruby-keyword">unless</span> <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">respond_to?</span> <span class="ruby-value">:revert</span>
        <span class="ruby-keyword">unless</span> <span class="ruby-identifier">arguments</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-operator">||</span> [<span class="ruby-value">:execute</span>, <span class="ruby-value">:enable_extension</span>, <span class="ruby-value">:disable_extension</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">method</span>)
          <span class="ruby-identifier">arguments</span>[<span class="ruby-value">0</span>] = <span class="ruby-identifier">proper_table_name</span>(<span class="ruby-identifier">arguments</span>.<span class="ruby-identifier">first</span>, <span class="ruby-identifier">table_name_options</span>)
          <span class="ruby-keyword">if</span> [<span class="ruby-value">:rename_table</span>, <span class="ruby-value">:add_foreign_key</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">method</span>) <span class="ruby-operator">||</span>
            (<span class="ruby-identifier">method</span> <span class="ruby-operator">==</span> <span class="ruby-value">:remove_foreign_key</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">arguments</span>.<span class="ruby-identifier">second</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Hash</span>))
            <span class="ruby-identifier">arguments</span>[<span class="ruby-value">1</span>] = <span class="ruby-identifier">proper_table_name</span>(<span class="ruby-identifier">arguments</span>.<span class="ruby-identifier">second</span>, <span class="ruby-identifier">table_name_options</span>)
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">return</span> <span class="ruby-keyword">super</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">method</span>)
      <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">method</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">arguments</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">copy</span>(<span class="ruby-identifier">destination</span>, <span class="ruby-identifier">sources</span>, <span class="ruby-identifier">options</span> = {})
    <span class="ruby-identifier">copied</span> = []

    <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span>(<span class="ruby-identifier">destination</span>) <span class="ruby-keyword">unless</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span>(<span class="ruby-identifier">destination</span>)

    <span class="ruby-identifier">destination_migrations</span> = <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">MigrationContext</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">destination</span>).<span class="ruby-identifier">migrations</span>
    <span class="ruby-identifier">last</span> = <span class="ruby-identifier">destination_migrations</span>.<span class="ruby-identifier">last</span>
    <span class="ruby-identifier">sources</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">scope</span>, <span class="ruby-identifier">path</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">source_migrations</span> = <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">MigrationContext</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">path</span>).<span class="ruby-identifier">migrations</span>

      <span class="ruby-identifier">source_migrations</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">migration</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">source</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">binread</span>(<span class="ruby-identifier">migration</span>.<span class="ruby-identifier">filename</span>)
        <span class="ruby-identifier">inserted_comment</span> = <span class="ruby-node">&quot;# This migration comes from #{scope} (originally #{migration.version})\n&quot;</span>
        <span class="ruby-identifier">magic_comments</span> = <span class="ruby-string">&quot;&quot;</span>.<span class="ruby-identifier">dup</span>
        <span class="ruby-identifier">loop</span> <span class="ruby-keyword">do</span>
          <span class="ruby-comment"># If we have a magic comment in the original migration,</span>
          <span class="ruby-comment"># insert our comment after the first newline(end of the magic comment line)</span>
          <span class="ruby-comment"># so the magic keep working.</span>
          <span class="ruby-comment"># Note that magic comments must be at the first line(except sh-bang).</span>
          <span class="ruby-identifier">source</span>.<span class="ruby-identifier">sub!</span>(<span class="ruby-regexp">/\A(?:#.*\b(?:en)?coding:\s*\S+|#\s*frozen_string_literal:\s*(?:true|false)).*\n/</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">magic_comment</span><span class="ruby-operator">|</span>
            <span class="ruby-identifier">magic_comments</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">magic_comment</span>; <span class="ruby-string">&quot;&quot;</span>
          <span class="ruby-keyword">end</span> <span class="ruby-operator">||</span> <span class="ruby-keyword">break</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">source</span> = <span class="ruby-node">&quot;#{magic_comments}#{inserted_comment}#{source}&quot;</span>

        <span class="ruby-keyword">if</span> <span class="ruby-identifier">duplicate</span> = <span class="ruby-identifier">destination_migrations</span>.<span class="ruby-identifier">detect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">migration</span>.<span class="ruby-identifier">name</span> }
          <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:on_skip</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">duplicate</span>.<span class="ruby-identifier">scope</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">to_s</span>
            <span class="ruby-identifier">options</span>[<span class="ruby-value">:on_skip</span>].<span class="ruby-identifier">call</span>(<span class="ruby-identifier">scope</span>, <span class="ruby-identifier">migration</span>)
          <span class="ruby-keyword">end</span>
          <span class="ruby-keyword">next</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-identifier">migration</span>.<span class="ruby-identifier">version</span> = <span class="ruby-identifier">next_migration_number</span>(<span class="ruby-identifier">last</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">last</span>.<span class="ruby-identifier">version</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span> <span class="ruby-operator">:</span> <span class="ruby-value">0</span>).<span class="ruby-identifier">to_i</span>
        <span class="ruby-identifier">new_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">destination</span>, <span class="ruby-node">&quot;#{migration.version}_#{migration.name.underscore}.#{scope}.rb&quot;</span>)
        <span class="ruby-identifier">old_path</span>, <span class="ruby-identifier">migration</span>.<span class="ruby-identifier">filename</span> = <span class="ruby-identifier">migration</span>.<span class="ruby-identifier">filename</span>, <span class="ruby-identifier">new_path</span>
        <span class="ruby-identifier">last</span> = <span class="ruby-identifier">migration</span>

        <span class="ruby-constant">File</span>.<span class="ruby-identifier">binwrite</span>(<span class="ruby-identifier">migration</span>.<span class="ruby-identifier">filename</span>, <span class="ruby-identifier">source</span>)
        <span class="ruby-identifier">copied</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">migration</span>
        <span class="ruby-identifier">options</span>[<span class="ruby-value">:on_copy</span>].<span class="ruby-identifier">call</span>(<span class="ruby-identifier">scope</span>, <span class="ruby-identifier">migration</span>, <span class="ruby-identifier">old_path</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:on_copy</span>]
        <span class="ruby-identifier">destination_migrations</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">migration</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">copied</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Finds the correct table name given an Active Record object.</span>
  <span class="ruby-comment"># Uses the Active Record object&#39;s own table_name, or pre/suffix from the</span>
  <span class="ruby-comment"># options passed in.</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">proper_table_name</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">options</span> = {})
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">name</span>.<span class="ruby-identifier">respond_to?</span> <span class="ruby-value">:table_name</span>
      <span class="ruby-identifier">name</span>.<span class="ruby-identifier">table_name</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-node">&quot;#{options[:table_name_prefix]}#{name}#{options[:table_name_suffix]}&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Determines the version number of the next migration.</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">next_migration_number</span>(<span class="ruby-identifier">number</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">timestamped_migrations</span>
      [<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%Y%m%d%H%M%S&quot;</span>), <span class="ruby-string">&quot;%.14d&quot;</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">number</span>].<span class="ruby-identifier">max</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-constant">SchemaMigration</span>.<span class="ruby-identifier">normalize_migration_number</span>(<span class="ruby-identifier">number</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Builds a hash for use in ActiveRecord::Migration#proper_table_name using</span>
  <span class="ruby-comment"># the Active Record object&#39;s table_name prefix and suffix</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">table_name_options</span>(<span class="ruby-identifier">config</span> = <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>) <span class="ruby-comment">#:nodoc:</span>
    {
      <span class="ruby-value">table_name_prefix:</span> <span class="ruby-identifier">config</span>.<span class="ruby-identifier">table_name_prefix</span>,
      <span class="ruby-value">table_name_suffix:</span> <span class="ruby-identifier">config</span>.<span class="ruby-identifier">table_name_suffix</span>
    }
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">private</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">execute_block</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">respond_to?</span> <span class="ruby-value">:execute_block</span>
        <span class="ruby-keyword">super</span> <span class="ruby-comment"># use normal delegation to record the block</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-keyword">yield</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>

<span class="ruby-comment"># MigrationProxy is used to defer loading of the actual migration classes</span>
<span class="ruby-comment"># until they are needed</span>
<span class="ruby-constant">MigrationProxy</span> = <span class="ruby-constant">Struct</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">:name</span>, <span class="ruby-value">:version</span>, <span class="ruby-value">:filename</span>, <span class="ruby-value">:scope</span>) <span class="ruby-keyword">do</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">initialize</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">version</span>, <span class="ruby-identifier">filename</span>, <span class="ruby-identifier">scope</span>)
    <span class="ruby-keyword">super</span>
    <span class="ruby-ivar">@migration</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">basename</span>
    <span class="ruby-constant">File</span>.<span class="ruby-identifier">basename</span>(<span class="ruby-identifier">filename</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mtime</span>
    <span class="ruby-constant">File</span>.<span class="ruby-identifier">mtime</span> <span class="ruby-identifier">filename</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">delegate</span> <span class="ruby-value">:migrate</span>, <span class="ruby-value">:announce</span>, <span class="ruby-value">:write</span>, <span class="ruby-value">:disable_ddl_transaction</span>, <span class="ruby-value">to:</span> <span class="ruby-value">:migration</span>

  <span class="ruby-identifier">private</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">migration</span>
      <span class="ruby-ivar">@migration</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">load_migration</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">load_migration</span>
      <span class="ruby-identifier">require</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-identifier">filename</span>))
      <span class="ruby-identifier">name</span>.<span class="ruby-identifier">constantize</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">version</span>)
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">NullMigration</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">MigrationProxy</span> <span class="ruby-comment">#:nodoc:</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">initialize</span>
    <span class="ruby-keyword">super</span>(<span class="ruby-keyword">nil</span>, <span class="ruby-value">0</span>, <span class="ruby-keyword">nil</span>, <span class="ruby-keyword">nil</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mtime</span>
    <span class="ruby-value">0</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">MigrationContext</span> <span class="ruby-comment"># :nodoc:</span>
  <span class="ruby-identifier">attr_reader</span> <span class="ruby-value">:migrations_paths</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">initialize</span>(<span class="ruby-identifier">migrations_paths</span>)
    <span class="ruby-ivar">@migrations_paths</span> = <span class="ruby-identifier">migrations_paths</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">migrate</span>(<span class="ruby-identifier">target_version</span> = <span class="ruby-keyword">nil</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
    <span class="ruby-keyword">case</span>
    <span class="ruby-keyword">when</span> <span class="ruby-identifier">target_version</span>.<span class="ruby-identifier">nil?</span>
      <span class="ruby-identifier">up</span>(<span class="ruby-identifier">target_version</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
    <span class="ruby-keyword">when</span> <span class="ruby-identifier">current_version</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">target_version</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
      []
    <span class="ruby-keyword">when</span> <span class="ruby-identifier">current_version</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">target_version</span>
      <span class="ruby-identifier">down</span>(<span class="ruby-identifier">target_version</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">up</span>(<span class="ruby-identifier">target_version</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">rollback</span>(<span class="ruby-identifier">steps</span> = <span class="ruby-value">1</span>)
    <span class="ruby-identifier">move</span>(<span class="ruby-value">:down</span>, <span class="ruby-identifier">steps</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">forward</span>(<span class="ruby-identifier">steps</span> = <span class="ruby-value">1</span>)
    <span class="ruby-identifier">move</span>(<span class="ruby-value">:up</span>, <span class="ruby-identifier">steps</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">up</span>(<span class="ruby-identifier">target_version</span> = <span class="ruby-keyword">nil</span>)
    <span class="ruby-identifier">selected_migrations</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">block_given?</span>
      <span class="ruby-identifier">migrations</span>.<span class="ruby-identifier">select</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-keyword">yield</span> <span class="ruby-identifier">m</span> }
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">migrations</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-constant">Migrator</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">:up</span>, <span class="ruby-identifier">selected_migrations</span>, <span class="ruby-identifier">target_version</span>).<span class="ruby-identifier">migrate</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">down</span>(<span class="ruby-identifier">target_version</span> = <span class="ruby-keyword">nil</span>)
    <span class="ruby-identifier">selected_migrations</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">block_given?</span>
      <span class="ruby-identifier">migrations</span>.<span class="ruby-identifier">select</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-keyword">yield</span> <span class="ruby-identifier">m</span> }
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">migrations</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-constant">Migrator</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">:down</span>, <span class="ruby-identifier">selected_migrations</span>, <span class="ruby-identifier">target_version</span>).<span class="ruby-identifier">migrate</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">run</span>(<span class="ruby-identifier">direction</span>, <span class="ruby-identifier">target_version</span>)
    <span class="ruby-constant">Migrator</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">direction</span>, <span class="ruby-identifier">migrations</span>, <span class="ruby-identifier">target_version</span>).<span class="ruby-identifier">run</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">open</span>
    <span class="ruby-constant">Migrator</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">:up</span>, <span class="ruby-identifier">migrations</span>, <span class="ruby-keyword">nil</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">get_all_versions</span>
    <span class="ruby-keyword">if</span> <span class="ruby-constant">SchemaMigration</span>.<span class="ruby-identifier">table_exists?</span>
      <span class="ruby-constant">SchemaMigration</span>.<span class="ruby-identifier">all_versions</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:to_i</span>)
    <span class="ruby-keyword">else</span>
      []
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">current_version</span>
    <span class="ruby-identifier">get_all_versions</span>.<span class="ruby-identifier">max</span> <span class="ruby-operator">||</span> <span class="ruby-value">0</span>
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">NoDatabaseError</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">needs_migration?</span>
    (<span class="ruby-identifier">migrations</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:version</span>) <span class="ruby-operator">-</span> <span class="ruby-identifier">get_all_versions</span>).<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">any_migrations?</span>
    <span class="ruby-identifier">migrations</span>.<span class="ruby-identifier">any?</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">last_migration</span> <span class="ruby-comment">#:nodoc:</span>
    <span class="ruby-identifier">migrations</span>.<span class="ruby-identifier">last</span> <span class="ruby-operator">||</span> <span class="ruby-constant">NullMigration</span>.<span class="ruby-identifier">new</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">parse_migration_filename</span>(<span class="ruby-identifier">filename</span>) <span class="ruby-comment"># :nodoc:</span>
    <span class="ruby-constant">File</span>.<span class="ruby-identifier">basename</span>(<span class="ruby-identifier">filename</span>).<span class="ruby-identifier">scan</span>(<span class="ruby-constant">Migration</span><span class="ruby-operator">::</span><span class="ruby-constant">MigrationFilenameRegexp</span>).<span class="ruby-identifier">first</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">migrations</span>
    <span class="ruby-identifier">migrations</span> = <span class="ruby-identifier">migration_files</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">file</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">version</span>, <span class="ruby-identifier">name</span>, <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">parse_migration_filename</span>(<span class="ruby-identifier">file</span>)
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">IllegalMigrationNameError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">file</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">version</span>
      <span class="ruby-identifier">version</span> = <span class="ruby-identifier">version</span>.<span class="ruby-identifier">to_i</span>
      <span class="ruby-identifier">name</span> = <span class="ruby-identifier">name</span>.<span class="ruby-identifier">camelize</span>

      <span class="ruby-constant">MigrationProxy</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">version</span>, <span class="ruby-identifier">file</span>, <span class="ruby-identifier">scope</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">migrations</span>.<span class="ruby-identifier">sort_by</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:version</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">migrations_status</span>
    <span class="ruby-identifier">db_list</span> = <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">SchemaMigration</span>.<span class="ruby-identifier">normalized_versions</span>

    <span class="ruby-identifier">file_list</span> = <span class="ruby-identifier">migration_files</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">file</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">version</span>, <span class="ruby-identifier">name</span>, <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">parse_migration_filename</span>(<span class="ruby-identifier">file</span>)
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">IllegalMigrationNameError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">file</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">version</span>
      <span class="ruby-identifier">version</span> = <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">SchemaMigration</span>.<span class="ruby-identifier">normalize_migration_number</span>(<span class="ruby-identifier">version</span>)
      <span class="ruby-identifier">status</span> = <span class="ruby-identifier">db_list</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">version</span>) <span class="ruby-operator">?</span> <span class="ruby-string">&quot;up&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-string">&quot;down&quot;</span>
      [<span class="ruby-identifier">status</span>, <span class="ruby-identifier">version</span>, (<span class="ruby-identifier">name</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">scope</span>).<span class="ruby-identifier">humanize</span>]
    <span class="ruby-keyword">end</span>.<span class="ruby-identifier">compact</span>

    <span class="ruby-identifier">db_list</span>.<span class="ruby-identifier">map!</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">version</span><span class="ruby-operator">|</span>
      [<span class="ruby-string">&quot;up&quot;</span>, <span class="ruby-identifier">version</span>, <span class="ruby-string">&quot;********** NO FILE **********&quot;</span>]
    <span class="ruby-keyword">end</span>

    (<span class="ruby-identifier">db_list</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">file_list</span>).<span class="ruby-identifier">sort_by</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">_</span>, <span class="ruby-identifier">version</span>, <span class="ruby-identifier">_</span><span class="ruby-operator">|</span> <span class="ruby-identifier">version</span> }
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">migration_files</span>
    <span class="ruby-identifier">paths</span> = <span class="ruby-constant">Array</span>(<span class="ruby-identifier">migrations_paths</span>)
    <span class="ruby-constant">Dir</span>[<span class="ruby-operator">*</span><span class="ruby-identifier">paths</span>.<span class="ruby-identifier">flat_map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">path</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;#{path}/**/[0-9]*_*.rb&quot;</span> }]
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">current_environment</span>
    <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">ConnectionHandling</span><span class="ruby-operator">::</span><span class="ruby-constant">DEFAULT_ENV</span>.<span class="ruby-identifier">call</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">protected_environment?</span>
    <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">protected_environments</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">last_stored_environment</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">last_stored_environment</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">last_stored_environment</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_version</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">NoEnvironmentInSchemaError</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">InternalMetadata</span>.<span class="ruby-identifier">table_exists?</span>

    <span class="ruby-identifier">environment</span> = <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">InternalMetadata</span>[<span class="ruby-value">:environment</span>]
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">NoEnvironmentInSchemaError</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">environment</span>
    <span class="ruby-identifier">environment</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">private</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">move</span>(<span class="ruby-identifier">direction</span>, <span class="ruby-identifier">steps</span>)
      <span class="ruby-identifier">migrator</span> = <span class="ruby-constant">Migrator</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">direction</span>, <span class="ruby-identifier">migrations</span>)

      <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_version</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">migrator</span>.<span class="ruby-identifier">current_migration</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">UnknownMigrationVersionError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">current_version</span>)
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">start_index</span> =
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_version</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
          <span class="ruby-value">0</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">migrator</span>.<span class="ruby-identifier">migrations</span>.<span class="ruby-identifier">index</span>(<span class="ruby-identifier">migrator</span>.<span class="ruby-identifier">current_migration</span>)
        <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">finish</span> = <span class="ruby-identifier">migrator</span>.<span class="ruby-identifier">migrations</span>[<span class="ruby-identifier">start_index</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">steps</span>]
      <span class="ruby-identifier">version</span> = <span class="ruby-identifier">finish</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">finish</span>.<span class="ruby-identifier">version</span> <span class="ruby-operator">:</span> <span class="ruby-value">0</span>
      <span class="ruby-identifier">send</span>(<span class="ruby-identifier">direction</span>, <span class="ruby-identifier">version</span>)
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Migrator</span> <span class="ruby-comment"># :nodoc:</span>
  <span class="ruby-keyword">class</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-keyword">self</span>
    <span class="ruby-identifier">attr_accessor</span> <span class="ruby-value">:migrations_paths</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">migrations_path=</span>(<span class="ruby-identifier">path</span>)
      <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">Deprecation</span>.<span class="ruby-identifier">warn</span> \
        <span class="ruby-string">&quot;ActiveRecord::Migrator.migrations_paths= is now deprecated and will be removed in Rails 6.0.&quot;</span> \
        <span class="ruby-string">&quot;You can set the `migrations_paths` on the `connection` instead through the `database.yml`.&quot;</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">migrations_paths</span> = [<span class="ruby-identifier">path</span>]
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># For cases where a table doesn&#39;t exist like loading from schema cache</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">current_version</span>
      <span class="ruby-constant">MigrationContext</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">migrations_paths</span>).<span class="ruby-identifier">current_version</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">migrations_paths</span> = [<span class="ruby-string">&quot;db/migrate&quot;</span>]

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">initialize</span>(<span class="ruby-identifier">direction</span>, <span class="ruby-identifier">migrations</span>, <span class="ruby-identifier">target_version</span> = <span class="ruby-keyword">nil</span>)
    <span class="ruby-ivar">@direction</span>         = <span class="ruby-identifier">direction</span>
    <span class="ruby-ivar">@target_version</span>    = <span class="ruby-identifier">target_version</span>
    <span class="ruby-ivar">@migrated_versions</span> = <span class="ruby-keyword">nil</span>
    <span class="ruby-ivar">@migrations</span>        = <span class="ruby-identifier">migrations</span>

    <span class="ruby-identifier">validate</span>(<span class="ruby-ivar">@migrations</span>)

    <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">SchemaMigration</span>.<span class="ruby-identifier">create_table</span>
    <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">InternalMetadata</span>.<span class="ruby-identifier">create_table</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">current_version</span>
    <span class="ruby-identifier">migrated</span>.<span class="ruby-identifier">max</span> <span class="ruby-operator">||</span> <span class="ruby-value">0</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">current_migration</span>
    <span class="ruby-identifier">migrations</span>.<span class="ruby-identifier">detect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">version</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">current_version</span> }
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">alias</span> <span class="ruby-value">:current</span> <span class="ruby-value">:current_migration</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">run</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">use_advisory_lock?</span>
      <span class="ruby-identifier">with_advisory_lock</span> { <span class="ruby-identifier">run_without_lock</span> }
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">run_without_lock</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">migrate</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">use_advisory_lock?</span>
      <span class="ruby-identifier">with_advisory_lock</span> { <span class="ruby-identifier">migrate_without_lock</span> }
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">migrate_without_lock</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">runnable</span>
    <span class="ruby-identifier">runnable</span> = <span class="ruby-identifier">migrations</span>[<span class="ruby-identifier">start</span><span class="ruby-operator">..</span><span class="ruby-identifier">finish</span>]
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">up?</span>
      <span class="ruby-identifier">runnable</span>.<span class="ruby-identifier">reject</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ran?</span>(<span class="ruby-identifier">m</span>) }
    <span class="ruby-keyword">else</span>
      <span class="ruby-comment"># skip the last migration if we&#39;re headed down, but not ALL the way down</span>
      <span class="ruby-identifier">runnable</span>.<span class="ruby-identifier">pop</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">target</span>
      <span class="ruby-identifier">runnable</span>.<span class="ruby-identifier">find_all</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ran?</span>(<span class="ruby-identifier">m</span>) }
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">migrations</span>
    <span class="ruby-identifier">down?</span> <span class="ruby-operator">?</span> <span class="ruby-ivar">@migrations</span>.<span class="ruby-identifier">reverse</span> <span class="ruby-operator">:</span> <span class="ruby-ivar">@migrations</span>.<span class="ruby-identifier">sort_by</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:version</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">pending_migrations</span>
    <span class="ruby-identifier">already_migrated</span> = <span class="ruby-identifier">migrated</span>
    <span class="ruby-identifier">migrations</span>.<span class="ruby-identifier">reject</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">already_migrated</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">m</span>.<span class="ruby-identifier">version</span>) }
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">migrated</span>
    <span class="ruby-ivar">@migrated_versions</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">load_migrated</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">load_migrated</span>
    <span class="ruby-ivar">@migrated_versions</span> = <span class="ruby-constant">Set</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">migration_context</span>.<span class="ruby-identifier">get_all_versions</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">private</span>

    <span class="ruby-comment"># Used for running a specific migration.</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">run_without_lock</span>
      <span class="ruby-identifier">migration</span> = <span class="ruby-identifier">migrations</span>.<span class="ruby-identifier">detect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">version</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@target_version</span> }
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">UnknownMigrationVersionError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@target_version</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">migration</span>.<span class="ruby-identifier">nil?</span>
      <span class="ruby-identifier">result</span> = <span class="ruby-identifier">execute_migration_in_transaction</span>(<span class="ruby-identifier">migration</span>, <span class="ruby-ivar">@direction</span>)

      <span class="ruby-identifier">record_environment</span>
      <span class="ruby-identifier">result</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Used for running multiple migrations up to or down to a certain value.</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">migrate_without_lock</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">invalid_target?</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">UnknownMigrationVersionError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@target_version</span>)
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">result</span> = <span class="ruby-identifier">runnable</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">migration</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">execute_migration_in_transaction</span>(<span class="ruby-identifier">migration</span>, <span class="ruby-ivar">@direction</span>)
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">record_environment</span>
      <span class="ruby-identifier">result</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Stores the current environment in the database.</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">record_environment</span>
      <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">down?</span>
      <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">InternalMetadata</span>[<span class="ruby-value">:environment</span>] = <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">migration_context</span>.<span class="ruby-identifier">current_environment</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">ran?</span>(<span class="ruby-identifier">migration</span>)
      <span class="ruby-identifier">migrated</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">migration</span>.<span class="ruby-identifier">version</span>.<span class="ruby-identifier">to_i</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Return true if a valid version is not provided.</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">invalid_target?</span>
      <span class="ruby-ivar">@target_version</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@target_version</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">target</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">execute_migration_in_transaction</span>(<span class="ruby-identifier">migration</span>, <span class="ruby-identifier">direction</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">down?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">migrated</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">migration</span>.<span class="ruby-identifier">version</span>.<span class="ruby-identifier">to_i</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">up?</span>   <span class="ruby-operator">&amp;&amp;</span>  <span class="ruby-identifier">migrated</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">migration</span>.<span class="ruby-identifier">version</span>.<span class="ruby-identifier">to_i</span>)

      <span class="ruby-constant">Base</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;Migrating to #{migration.name} (#{migration.version})&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">Base</span>.<span class="ruby-identifier">logger</span>

      <span class="ruby-identifier">ddl_transaction</span>(<span class="ruby-identifier">migration</span>) <span class="ruby-keyword">do</span>
        <span class="ruby-identifier">migration</span>.<span class="ruby-identifier">migrate</span>(<span class="ruby-identifier">direction</span>)
        <span class="ruby-identifier">record_version_state_after_migrating</span>(<span class="ruby-identifier">migration</span>.<span class="ruby-identifier">version</span>)
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">rescue</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
      <span class="ruby-identifier">msg</span> = <span class="ruby-string">&quot;An error has occurred, &quot;</span>.<span class="ruby-identifier">dup</span>
      <span class="ruby-identifier">msg</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;this and &quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">use_transaction?</span>(<span class="ruby-identifier">migration</span>)
      <span class="ruby-identifier">msg</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;all later migrations canceled:\n\n#{e}&quot;</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">StandardError</span>, <span class="ruby-identifier">msg</span>, <span class="ruby-identifier">e</span>.<span class="ruby-identifier">backtrace</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">target</span>
      <span class="ruby-identifier">migrations</span>.<span class="ruby-identifier">detect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">version</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@target_version</span> }
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">finish</span>
      <span class="ruby-identifier">migrations</span>.<span class="ruby-identifier">index</span>(<span class="ruby-identifier">target</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">migrations</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">start</span>
      <span class="ruby-identifier">up?</span> <span class="ruby-operator">?</span> <span class="ruby-value">0</span> <span class="ruby-operator">:</span> (<span class="ruby-identifier">migrations</span>.<span class="ruby-identifier">index</span>(<span class="ruby-identifier">current</span>) <span class="ruby-operator">||</span> <span class="ruby-value">0</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">validate</span>(<span class="ruby-identifier">migrations</span>)
      <span class="ruby-identifier">name</span>, = <span class="ruby-identifier">migrations</span>.<span class="ruby-identifier">group_by</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:name</span>).<span class="ruby-identifier">find</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">_</span>, <span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">v</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> }
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">DuplicateMigrationNameError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">name</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">name</span>

      <span class="ruby-identifier">version</span>, = <span class="ruby-identifier">migrations</span>.<span class="ruby-identifier">group_by</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:version</span>).<span class="ruby-identifier">find</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">_</span>, <span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">v</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> }
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">DuplicateMigrationVersionError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">version</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">version</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">record_version_state_after_migrating</span>(<span class="ruby-identifier">version</span>)
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">down?</span>
        <span class="ruby-identifier">migrated</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">version</span>)
        <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">SchemaMigration</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">version:</span> <span class="ruby-identifier">version</span>.<span class="ruby-identifier">to_s</span>).<span class="ruby-identifier">delete_all</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">migrated</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">version</span>
        <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">SchemaMigration</span>.<span class="ruby-identifier">create!</span>(<span class="ruby-value">version:</span> <span class="ruby-identifier">version</span>.<span class="ruby-identifier">to_s</span>)
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">up?</span>
      <span class="ruby-ivar">@direction</span> <span class="ruby-operator">==</span> <span class="ruby-value">:up</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">down?</span>
      <span class="ruby-ivar">@direction</span> <span class="ruby-operator">==</span> <span class="ruby-value">:down</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Wrap the migration in a transaction only if supported by the adapter.</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">ddl_transaction</span>(<span class="ruby-identifier">migration</span>)
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">use_transaction?</span>(<span class="ruby-identifier">migration</span>)
        <span class="ruby-constant">Base</span>.<span class="ruby-identifier">transaction</span> { <span class="ruby-keyword">yield</span> }
      <span class="ruby-keyword">else</span>
        <span class="ruby-keyword">yield</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">use_transaction?</span>(<span class="ruby-identifier">migration</span>)
      <span class="ruby-operator">!</span><span class="ruby-identifier">migration</span>.<span class="ruby-identifier">disable_ddl_transaction</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">supports_ddl_transactions?</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">use_advisory_lock?</span>
      <span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">supports_advisory_locks?</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">with_advisory_lock</span>
      <span class="ruby-identifier">lock_id</span> = <span class="ruby-identifier">generate_migrator_advisory_lock_id</span>
      <span class="ruby-identifier">connection</span> = <span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection</span>
      <span class="ruby-identifier">got_lock</span> = <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">get_advisory_lock</span>(<span class="ruby-identifier">lock_id</span>)
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">ConcurrentMigrationError</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">got_lock</span>
      <span class="ruby-identifier">load_migrated</span> <span class="ruby-comment"># reload schema_migrations to be sure it wasn&#39;t changed by another process before we got the lock</span>
      <span class="ruby-keyword">yield</span>
    <span class="ruby-keyword">ensure</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">got_lock</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">connection</span>.<span class="ruby-identifier">release_advisory_lock</span>(<span class="ruby-identifier">lock_id</span>)
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ConcurrentMigrationError</span>.<span class="ruby-identifier">new</span>(
          <span class="ruby-constant">ConcurrentMigrationError</span><span class="ruby-operator">::</span><span class="ruby-constant">RELEASE_LOCK_FAILED_MESSAGE</span>
        )
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-constant">MIGRATOR_SALT</span> = <span class="ruby-value">2053462845</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">generate_migrator_advisory_lock_id</span>
      <span class="ruby-identifier">db_name_hash</span> = <span class="ruby-constant">Zlib</span>.<span class="ruby-identifier">crc32</span>(<span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">current_database</span>)
      <span class="ruby-constant">MIGRATOR_SALT</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">db_name_hash</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-up_only">
            
              <b>up_only</b>()
            
            <a href="Migration.html#method-i-up_only" name="method-i-up_only" class="permalink">Link</a>
          </div>

          
            <div class="description">
              <p>Used to specify an operation that is only run when migrating up (for
example, populating a new column with its initial values).</p>

<p>In the following example, the new column <code>published</code> will be
given the value <code>true</code> for all existing records.</p>

<pre><code>class AddPublishedToPosts &lt; ActiveRecord::Migration[5.2]
  def change
    add_column :posts, :published, :boolean, default: false
    up_only do
      execute &quot;update posts set published = &#39;true&#39;&quot;
    end
  end
end
</code></pre>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-up_only_source')" id="l_method-i-up_only_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/migration.rb#L752" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-up_only_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/migration.rb, line 752</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">up_only</span>
  <span class="ruby-identifier">execute_block</span> { <span class="ruby-keyword">yield</span> } <span class="ruby-keyword">unless</span> <span class="ruby-identifier">reverting?</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-write">
            
              <b>write</b>(text = &quot;&quot;)
            
            <a href="Migration.html#method-i-write" name="method-i-write" class="permalink">Link</a>
          </div>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-write_source')" id="l_method-i-write_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/fc5dd0b85189811062c85520fd70de8389b55aeb/activerecord/lib/active_record/migration.rb#L823" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-write_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/migration.rb, line 823</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">write</span>(<span class="ruby-identifier">text</span> = <span class="ruby-string">&quot;&quot;</span>)
  <span class="ruby-identifier">puts</span>(<span class="ruby-identifier">text</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">verbose</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
    
  
</div>

    </div>
  </body>
</html>
